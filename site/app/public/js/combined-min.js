"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==(void 0===e?"undefined":_typeof(e))&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+(void 0===e?"undefined":_typeof(e)));t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function getCurrentContext(){return currentContext}function copyGroup(t){if(0===t.length)return[];for(var e=[],n=0;n<t.length;n++)t[n]instanceof WirePort?t.splice(n--,1):e[n]=t[n].copy();for(var i=[],n=0;n<t.length;n++)for(var o=t[n],s=0;s<o.outputs.length;s++)for(var r=o.outputs[s].connections,a=0;a<r.length;a++){for(var u=r[a];u instanceof Wire||u instanceof WirePort;)u=u.connection;if(void 0==findIPort(t,u,e))break;var c=r[a].copy();e[n].outputs[s].connect(c);for(var h=r[a];h.connection instanceof WirePort;){var l=new WirePort(o.context);c.connect(l),i.push(c),c=(h=h.connection.connection).copy(),l.connect(c),e.push(l)}var d=findIPort(t,h.connection,e);c.connect(d),i.push(c)}for(n=0;n<t.length;n++)e[n].isOn=t[n].isOn,0===t[n].inputs.length&&e[n].activate(t[n].isOn);for(n=0;n<i.length;n++)0===t[n].inputs.length&&e[n].activate(t[n].isOn);return{objects:e,wires:i}}function findIPort(t,e,n){for(var i=0;i<t.length;i++)for(var o=t[i].inputs,s=0;s<o.length;s++)if(o[s]===e)return n[i].inputs[s]}function rectContains(t,e){var n=t.size.scale(.5),i=t.size.scale(-.5),o=t.toLocalSpace(e);return o.x>i.x&&o.y>i.y&&o.x<n.x&&o.y<n.y}function circleContains(t,e){return t.toLocalSpace(e).len2()<=t.size.x*t.size.x/4}function transformContains(t,e){if(Math.abs(t.getAngle())<=1e-5&&Math.abs(e.getAngle())<=1e-5){var n=t.getPos(),i=t.getSize(),o=e.getPos(),s=e.getSize();return 2*Math.abs(n.x-o.x)<i.x+s.x&&2*Math.abs(n.y-o.y)<i.y+s.y}var r=t.getRadius()+e.getRadius(),a=t.getPos().sub(e.getPos());if(a.dot(a)>r*r)return!1;for(var u=t.getLocalCorners(),c=e.getCorners(),h=[],l=0;l<4;l++)h[l]=t.toLocalSpace(c[l]),h[l].x+=1e-4*l,h[l].y+=1e-4*l;var d=u.concat(h);g=v=d[0].x,y=m=d[4].x;for(_=1;_<4;_++)g=Math.min(d[_].x,g),v=Math.max(d[_].x,v),y=Math.min(d[_+4].x,y),m=Math.max(d[_+4].x,m);if(v<y||m<g)return!1;g=v=d[0].y,y=m=d[4].y;for(_=1;_<4;_++)g=Math.min(d[_].y,g),v=Math.max(d[_].y,v),y=Math.min(d[_+4].y,y),m=Math.max(d[_+4].y,m);if(v<y||m<g)return!1;for(var p=[h[3].sub(h[0]),h[3].sub(h[2])],l=0;l<p.length;l++){for(var f=p[l],g=void 0,v=void 0,y=void 0,m=void 0,_=0;_<4;_++){var C=d[_].dot(f);g=Math.min(C,g||1/0),v=Math.max(C,v||-1/0);var x=d[_+4].dot(f);y=Math.min(x,y||1/0),m=Math.max(x,m||-1/0)}if(v<y||m<g)return!1}return!0}function getNearestPointOnRect(t,e,n){return n.x<t.x?V(t.x,clamp(n.y,t.y,e.y)):n.x>e.x?V(e.x,clamp(n.y,t.y,e.y)):n.y<t.y?V(clamp(n.x,t.x,e.x),t.y):n.y>e.y?V(clamp(n.x,t.x,e.x),e.y):V(0,0)}function getAllThingsBetween(t){for(var e=[],n=[],i=0;i<t.length;i++)t[i]instanceof Wire||t[i]instanceof WirePort?n.push(t[i]):t[i]instanceof IOObject&&e.push(t[i]);for(var o=[],i=0;i<e.length;i++){o.push(e[i]);for(s=0;s<e[i].inputs.length;s++){for(u=e[i].inputs[s].input;void 0!=u&&!(u instanceof OPort);)void 0==findByUID(o,u.uid)&&o.push(u),u=u.input}for(var s=0;s<e[i].outputs.length;s++)for(var r=e[i].outputs[s],a=0;a<r.connections.length;a++)for(u=r.connections[a];void 0!=u&&!(u instanceof IPort);)void 0==findByUID(o,u.uid)&&o.push(u),u=u.connection}for(i=0;i<n.length;i++){o.push(n[i]);for(var u=n[i].input;void 0!=u&&!(u instanceof OPort);)void 0==findByUID(o,u.uid)&&o.push(u),u=u.input;for(u=n[i].connection;void 0!=u&&!(u instanceof IPort);)void 0==findByUID(o,u.uid)&&o.push(u),u=u.connection}return o}function getAllWires(t){for(var e=[],n=0;n<t.length;n++)for(var i=t[n],o=0;o<i.outputs.length;o++)for(var s=i.outputs[o].connections,r=0;r<s.length;r++){for(var a=s[r];a.connection instanceof WirePort;)e.push(a),a=a.connection.connection;e.push(a)}return e}function RemoveObjects(t,e,n){if(0!==e.length){for(var i=new GroupAction,o=getAllThingsBetween(e),s=0;s<o.length;s++)if(o[s].selected&&selectionTool.deselect([o[s]]),o[s]instanceof Wire||o[s]instanceof WirePort){var r=o[s].input,a=o[s].connection;o[s].remove(),n&&i.add(new DeleteAction(o[s],r,a))}for(s=0;s<o.length;s++)o[s]instanceof Wire||o[s]instanceof WirePort||(o[s].remove(),n&&i.add(new DeleteAction(o[s])));n&&t.addAction(i),render()}}function CopyArray(t){for(var e=[],n=0;n<t.length;n++)e.push(t[n]);return e}function findIC(t,e){for(var n=0;n<e.length;n++)if(e[n].icuid===t)return e[n]}function findByUID(t,e){for(var n=0;n<t.length;n++)if(t[n].uid===e)return t[n]}function createTransformAction(t,e){for(var n=new GroupAction,i=0;i<t.length;i++){var o=e[i],s=t[i].transform.copy();o.equals(s)||n.add(new TransformAction(t[i],o,s))}return n}function _getNearestT(t,e,n,i){var o=e.x-t.x,s=e.y-t.y,r=(o*(n-t.x)+s*(i-t.y))/(o*o+s*s);return V(o*(r=clamp(r,0,1))+t.x,s*r+t.y).sub(V(n,i)).len2()<WIRE_DIST_THRESHOLD2?r:-1}function findRoots(t,e,n,i,o,s){var r=e;do{var a=o(r,n,i),u=s(r,n,i);if(0===u)break;r=clamp(r-=a/u,.01,.99)}while(t-- >0);return r}function separateGroup(t){for(var e=[],n=[],i=[],o=0;o<t.length;o++){var s=t[o];s instanceof Switch||s instanceof Button||s instanceof Clock?e.push(s):s instanceof LED?i.push(s):n.push(s)}return{inputs:e,components:n,outputs:i}}function clamp(t,e,n){return Math.min(Math.max(t,e),n)}function getBrowser(){if(void 0!=navigator){var t,e=navigator.userAgent,n=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(e)||[],{name:"IE",version:t[1]||""}):"Chrome"===n[1]&&null!=(t=e.match(/\bOPR|Edge\/(\d+)/))?{name:"Opera",version:t[1]}:(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(t=e.match(/version\/(\d+)/i))&&n.splice(1,1,t[1]),{name:n[0],version:n[1]})}}function V(t,e){return new Vector(t,e)}function createChildNode(t,e){var n=Exporter.ROOT.createElement(e);return t.appendChild(n),n}function createTextElement(t,e,n){var i=Exporter.ROOT.createElement(e),o=Exporter.ROOT.createTextNode(n);i.appendChild(o),t.appendChild(i)}function getChildNode(t,e){for(var n=0;n<t.childNodes.length;n++)if(t.childNodes[n].nodeName===e)return t.childNodes[n]}function getChildrenByTagName(t,e){for(var n=[],i=0;i<t.childNodes.length;i++)t.childNodes[i].nodeName===e&&n.push(t.childNodes[i]);return n}function getBooleanValue(t,e){return void 0==t?e:"true"===t.childNodes[0].nodeValue}function getIntValue(t,e){return void 0==t?e:parseInt(t.childNodes[0].nodeValue)}function getFloatValue(t,e){return void 0==t?e:parseFloat(t.childNodes[0].nodeValue)}function getStringValue(t,e){return void 0==t?e:t.childNodes[0].nodeValue}function snap(t,e,n){return Math.abs(e-n)<=WIRE_SNAP_THRESHOLD?(t.straight=!0,n):e}function start(){var t=new CircuitDesigner(document.getElementById("canvas"));context=new Context(t),currentContext=context,popup=new SelectionPopup,icdesigner=new ICDesigner,contextmenu=new ContextMenu,Input.registerContext(context),Input.registerContext(icdesigner.context),Input.addMouseListener(icdesigner),Input.addMouseListener(TransformController),Input.addMouseListener(WireController),Input.addMouseListener(SelectionBox),selectionTool.activate(),loadImage(images,["constLow.svg","constHigh.svg","buttonUp.svg","buttonDown.svg","switchUp.svg","switchDown.svg","led.svg","ledLight.svg","buffer.svg","and.svg","or.svg","xor.svg","segment1.svg","segment2.svg","segment3.svg","segment4.svg","clock.svg","clockOn.svg","keyboard.svg","base.svg"],0,onFinishLoading)}function wire(t,e){var n=new Wire(getCurrentContext(),t);t.connect(n),n.connect(e)}function reset(){ICData.ICs=[],currentContext=context,context.reset()}function onFinishLoading(){render()}function render(){__TESTING__||(0===renderQueue&&requestAnimationFrame(actualRender),renderQueue++)}function actualRender(){renderQueue=0,getCurrentContext().render()}function loadImage(t,e,n,i){var o=new Image;o.onload=function(){t[e[n]]=o,o.dx=0,o.dy=0,o.ratio=o.width/o.height,n===e.length-1?i(t):loadImage(t,e,n+1,i)},o.src="img/items/"+e[n]}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_get=function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in o)return o.value;var r=o.get;if(void 0!==r)return r.call(i)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),__TESTING__=!1,Camera=function(){function t(e,n,i){_classCallCheck(this,t),this.canvas=e.renderer.canvas,this.pos=n||V(0,0),this.zoom=i||1,this.center=V(0,0),this.transform=new Transform(V(0,0),V(0,0),0,this),this.dirty=!0}return _createClass(t,[{key:"resize",value:function(){this.center=V(this.canvas.width,this.canvas.height).scale(.5)}},{key:"updateMatrix",value:function(){if(this.dirty){this.dirty=!1,this.mat=new Matrix2x3,this.mat.translate(this.pos),this.mat.scale(V(this.zoom,this.zoom)),this.inv=this.mat.inverse();var t=this.getWorldPos(V(0,0)),e=this.getWorldPos(V(this.canvas.width,this.canvas.height));this.transform.setPos(e.add(t).scale(.5)),this.transform.setSize(e.sub(t))}}},{key:"translate",value:function(t,e){this.dirty=!0,this.pos.x+=t,this.pos.y+=e}},{key:"zoomBy",value:function(t){this.dirty=!0,this.zoom*=t}},{key:"cull",value:function(t){return transformContains(t,this.getTransform())}},{key:"getTransform",value:function(){return this.updateMatrix(),this.transform}},{key:"getMatrix",value:function(){return this.updateMatrix(),this.mat}},{key:"getInverseMatrix",value:function(){return this.updateMatrix(),this.inv}},{key:"getScreenPos",value:function(t){return this.getInverseMatrix().mul(t).add(this.center)}},{key:"getWorldPos",value:function(t){return this.getMatrix().mul(t.sub(this.center))}}]),t}(),Clipboard=function(){function t(){var e=this;_classCallCheck(this,t),document.addEventListener("copy",function(t){e.copy(t)},!1),document.addEventListener("cut",function(t){e.cut(t)},!1),document.addEventListener("paste",function(t){e.paste(t)},!1)}return _createClass(t,[{key:"copy",value:function(t){for(var e=getAllThingsBetween(selectionTool.selections),n=[],i=[],o=0;o<e.length;o++)e[o]instanceof Wire?i.push(e[o]):n.push(e[o]);var s={getObjects:function(){return n},getWires:function(){return i}},r=Exporter.write(s);t.clipboardData.setData("text/plain",r),t.preventDefault()}},{key:"cut",value:function(t){this.copy(t),RemoveObjects(getCurrentContext(),selectionTool.selections,!0),t.preventDefault()}},{key:"paste",value:function(t){console.log("ASd");for(var e=Importer.load(t.clipboardData.getData("text/plain"),getCurrentContext()),n=e.objects,i=(e.wires,new GroupAction),o=0;o<n.length;o++)n[o].setPos(n[o].getPos().add(V(5,5))),i.add(new PlaceAction(n[o]));getCurrentContext().addAction(i),selectionTool.deselectAll(),selectionTool.select(n),render(),t.preventDefault()}}]),t}(),clipboard=new Clipboard,Context=function(){function t(e){_classCallCheck(this,t),this.uidmanager=new UIDManager(this),this.designer=e}return _createClass(t,[{key:"reset",value:function(){this.designer.reset()}},{key:"render",value:function(){this.designer.render()}},{key:"propogate",value:function(t,e,n){this.designer.propogate(t,e,n)}},{key:"add",value:function(t){t instanceof Wire?this.addWire(t):this.addObject(t)}},{key:"addObject",value:function(t){this.designer.addObject(t),this.uidmanager.giveUIDTo(t)}},{key:"addObjects",value:function(t){for(var e=0;e<t.length;e++)this.addObject(t[e])}},{key:"addWire",value:function(t){this.designer.addWire(t),this.uidmanager.giveUIDTo(t)}},{key:"addWires",value:function(t){for(var e=0;e<t.length;e++)this.addWire(t[e])}},{key:"addAction",value:function(t){this.designer.history.add(t)}},{key:"setCursor",value:function(t){this.designer.renderer.setCursor(t)}},{key:"remove",value:function(t){var e=this.getIndexOf(t);-1!==e&&(t instanceof Wire?this.designer.getWires().splice(e,1):this.designer.getObjects().splice(e,1))}},{key:"undo",value:function(){this.designer.history.undo()}},{key:"redo",value:function(){this.designer.history.redo()}},{key:"redistributeUIDs",value:function(){this.uidmanager.redistribute()}},{key:"getDesigner",value:function(){return this.designer}},{key:"getRenderer",value:function(){return this.designer.renderer}},{key:"getCamera",value:function(){return this.designer.camera}},{key:"getHistoryManager",value:function(){return this.designer.history}},{key:"getObjects",value:function(){return CopyArray(this.designer.objects)}},{key:"getWires",value:function(){return CopyArray(this.designer.wires)}},{key:"getIndexOf",value:function(t){return t instanceof Wire?this.designer.getIndexOfWire(t):this.designer.getIndexOfObject(t)}},{key:"findByUID",value:function(t){return findObjectByUID(t)||findWireByUID(t)}},{key:"findObjectByUID",value:function(t){return UIDManager.find(this.getObjects(),t)}},{key:"findWireByUID",value:function(t){return UIDManager.find(this.getWires(),t)}}]),t}(),HistoryManager=function(){function t(){_classCallCheck(this,t),this.undoStack=[],this.redoStack=[]}return _createClass(t,[{key:"onKeyDown",value:function(t,e){Input.getModifierKeyDown()&&(t===Y_KEY||t===Z_KEY&&Input.getShiftKeyDown()?this.redo():t===Z_KEY&&this.undo())}},{key:"add",value:function(t){t instanceof GroupAction&&0==t.actions.length||(this.redoStack=[],this.undoStack.push(t))}},{key:"undo",value:function(){if(this.undoStack.length>0){var t=this.undoStack.pop();t.undo(),this.redoStack.push(t),popup.update(),render()}}},{key:"redo",value:function(){if(this.redoStack.length>0){var t=this.redoStack.pop();t.redo(),this.undoStack.push(t),popup.update(),render()}}}]),t}(),PROPOGATION_TIME=1,updateRequests=0,Propogation=function(){function t(e,n,i,o){_classCallCheck(this,t),this.sender=e,this.receiver=n,this.signal=i,0===updateRequests&&(updateRequests++,setTimeout(o,PROPOGATION_TIME))}return _createClass(t,[{key:"send",value:function(){this.receiver.activate(this.signal)}}]),t}(),UIDManager=function(){function t(e){_classCallCheck(this,t),this.context=e,this.counter=0}return _createClass(t,[{key:"giveUIDTo",value:function(t){t.uid||(t.uid=this.counter++)}},{key:"redistribute",value:function(){var t=this.context.getObjects().concat(this.context.getWires());this.counter=0;for(var e=0;e<t.length;e++)t[e].uid=this.counter++}}]),t}();UIDManager.find=function(t,e){for(var n=0;n<t.length;n++)if(t[n].uid===e)return t[n]};var CurrentTool,DEFAULT_SIZE=50,GRID_SIZE=50,DEFAULT_FILL_COLOR="#ffffff",DEFAULT_BORDER_COLOR="#000000",DEFAULT_ON_COLOR="#3cacf2",IO_PORT_LENGTH=60,IO_PORT_RADIUS=7,IO_PORT_BORDER_WIDTH=1,IO_PORT_LINE_WIDTH=2,WIRE_DIST_THRESHOLD=5,WIRE_DIST_THRESHOLD2=WIRE_DIST_THRESHOLD*WIRE_DIST_THRESHOLD,WIRE_DIST_ITERATIONS=10,WIRE_NEWTON_ITERATIONS=5,WIRE_SNAP_THRESHOLD=10,ROTATION_CIRCLE_RADIUS=75,ROTATION_CIRCLE_THICKNESS=5,ROTATION_CIRCLE_THRESHOLD=5,ROTATION_CIRCLE_R1=Math.pow(ROTATION_CIRCLE_RADIUS-ROTATION_CIRCLE_THRESHOLD,2),ROTATION_CIRCLE_R2=Math.pow(ROTATION_CIRCLE_RADIUS+ROTATION_CIRCLE_THRESHOLD,2),SIDENAV_WIDTH=200,ITEMNAV_WIDTH=200,LEFT_MOUSE_BUTTON=0,RIGHT_MOUSE_BUTTON=1,OPTION_KEY=18,SHIFT_KEY=16,DELETE_KEY=8,ENTER_KEY=13,ESC_KEY=27,A_KEY=65,C_KEY=67,V_KEY=86,X_KEY=88,Y_KEY=89,Z_KEY=90,CONTROL_KEY=17,COMMAND_KEY=91,Action=function(){function t(){_classCallCheck(this,t),this.context=getCurrentContext(),saved=!1}return _createClass(t,[{key:"undo",value:function(){}},{key:"redo",value:function(){}}]),t}(),DeleteAction=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return o.obj=t,o.oldinput=n,o.oldconnection=i,o}return _inherits(e,Action),_createClass(e,[{key:"undo",value:function(){this.context.add(this.obj),void 0!=this.oldinput&&this.oldinput.connect(this.obj),void 0!=this.oldconnection&&this.obj.connect(this.oldconnection)}},{key:"redo",value:function(){this.obj.remove()}}]),e}(),GroupAction=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.actions=[],t}return _inherits(e,Action),_createClass(e,[{key:"add",value:function(t){this.actions.push(t)}},{key:"undo",value:function(){for(var t=this.actions.length-1;t>=0;t--)this.actions[t].undo()}},{key:"redo",value:function(){for(var t=0;t<this.actions.length;t++)this.actions[t].redo()}}]),e}(),PlaceAction=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.obj=t,n}return _inherits(e,Action),_createClass(e,[{key:"undo",value:function(){this.context.remove(this.obj)}},{key:"redo",value:function(){this.context.addObject(this.obj)}}]),e}(),PlaceWireAction=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.wire=t,n.input=n.wire.input,n.connection=n.wire.connection,n}return _inherits(e,Action),_createClass(e,[{key:"undo",value:function(){this.context.remove(this.wire),this.wire.disconnect(),this.wire.input.disconnect(this.wire)}},{key:"redo",value:function(){this.context.add(this.wire),this.wire.connect(this.connection),this.input.connect(this.wire)}}]),e}(),SelectAction=function(t){function e(t,n){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.obj=t,i.flip=n,i}return _inherits(e,Action),_createClass(e,[{key:"undo",value:function(){this.flip?this.reselect():this.deselect()}},{key:"redo",value:function(){this.flip?this.deselect():this.reselect()}},{key:"reselect",value:function(){selectionTool.select([this.obj])}},{key:"deselect",value:function(){selectionTool.deselect([this.obj])}}]),e}(),SplitWireAction=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.wireport=t.connection,n.wire=t,n.newwire=n.wireport.connection,n.connection=n.newwire.connection,n}return _inherits(e,Action),_createClass(e,[{key:"undo",value:function(){this.context.remove(this.wireport),this.context.remove(this.newwire),this.wire.disconnect(),this.newwire.disconnect(),this.wire.connect(this.connection)}},{key:"redo",value:function(){this.context.add(this.wireport),this.context.add(this.newwire),this.wire.disconnect(),this.wire.connect(this.wireport),this.newwire.connect(this.connection)}}]),e}(),TransformAction=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return o.obj=t,o.t0=n,o.t1=i,o}return _inherits(e,Action),_createClass(e,[{key:"undo",value:function(){this.obj.setTransform(this.t0),this.updatePopup()}},{key:"redo",value:function(){this.obj.setTransform(this.t1),this.updatePopup()}},{key:"updatePopup",value:function(){this.obj.selected&&(selectionTool.recalculateMidpoint(),popup.onMove())}}]),e}(),BezierCurve=function(){function t(e,n,i,o){_classCallCheck(this,t),this.p1=V(e.x,e.y),this.p2=V(n.x,n.y),this.c1=V(i.x,i.y),this.c2=V(o.x,o.y),this.dirty=!0,this.boundingBox=new Transform(0,0,0,getCurrentContext().getCamera())}return _createClass(t,[{key:"update",value:function(t,e,n,i){this.p1.x=t.x,this.p1.y=t.y,this.p2.x=e.x,this.p2.y=e.y,this.c1.x=n.x,this.c1.y=n.y,this.c2.x=i.x,this.c2.y=i.y}},{key:"updateBoundingBox",value:function(){if(this.dirty){this.dirty=!1;var t=V(0,0),e=V(0,0),n=this.getPos(0),i=this.getPos(1),o=this.c1.sub(this.c2).scale(3).add(this.p2.sub(this.p1)),s=this.p1.sub(this.c1.scale(2).add(this.c2)).scale(2),r=this.c1.sub(this.p1),a=s.y*s.y-4*o.y*r.y,u=-1!==(a=a>=0?Math.sqrt(a):-1)?clamp((-s.y+a)/(2*o.y),0,1):0,c=-1!==a?clamp((-s.y-a)/(2*o.y),0,1):0;e.y=Math.max(this.getY(u),this.getY(c),n.y,i.y),t.y=Math.min(this.getY(u),this.getY(c),n.y,i.y);var h=s.x*s.x-4*o.x*r.x;-1!==(h=h>=0?Math.sqrt(h):-1)&&clamp((-s.x+h)/(2*o.x),0,1),-1!==h&&clamp((-s.x-h)/(2*o.x),0,1);e.x=Math.max(this.getX(u),this.getX(c),n.x,i.x),t.x=Math.min(this.getX(u),this.getX(c),n.x,i.x),this.boundingBox.setSize(V(e.x-t.x,e.y-t.y)),this.boundingBox.setPos(V((e.x-t.x)/2+t.x,(e.y-t.y)/2+t.y))}}},{key:"draw",value:function(t,e,n){var i=n.parent.camera,o=i.getScreenPos(this.p1),s=i.getScreenPos(this.p2),r=i.getScreenPos(this.c1),a=i.getScreenPos(this.c2);n.curve(o.x,o.y,s.x,s.y,r.x,r.y,a.x,a.y,t,e)}},{key:"getX",value:function(t){var e=1-t;return this.p1.x*e*e*e+3*this.c1.x*t*e*e+3*this.c2.x*t*t*e+this.p2.x*t*t*t}},{key:"getY",value:function(t){var e=1-t;return this.p1.y*e*e*e+3*this.c1.y*t*e*e+3*this.c2.y*t*t*e+this.p2.y*t*t*t}},{key:"getPos",value:function(t){return V(this.getX(t),this.getY(t))}},{key:"getDX",value:function(t){var e=1-t;return-3*this.p1.x*e*e+3*this.c1.x*e*(1-3*t)+3*this.c2.x*t*(2-3*t)+3*this.p2.x*t*t}},{key:"getDY",value:function(t){var e=1-t;return-3*this.p1.y*e*e+3*this.c1.y*e*(1-3*t)+3*this.c2.y*t*(2-3*t)+3*this.p2.y*t*t}},{key:"getVel",value:function(t){return V(this.getDX(t),this.getDY(t))}},{key:"getDDX",value:function(t){return 6*((-this.p1.x+3*this.c1.x-3*this.c2.x+this.p2.x)*t+(this.p1.x-2*this.c1.x+this.c2.x))}},{key:"getDDY",value:function(t){return 6*((-this.p1.y+3*this.c1.y-3*this.c2.y+this.p2.y)*t+(this.p1.y-2*this.c1.y+this.c2.y))}},{key:"getDist",value:function(t,e,n){var i=this.getX(t)-e,o=this.getY(t)-n;return Math.sqrt(i*i+o*o)}},{key:"getDist2",value:function(t,e,n){var i=this.getX(t)-e,o=this.getY(t)-n;return i*i+o*o}},{key:"getDistDenominator",value:function(t,e,n){var i=this.getX(t)-e,o=this.getY(t)-n;return i*i+o*o}},{key:"getDistDenominatorDerivative",value:function(t,e,n){return 2*(this.getX(t)-e)*this.getDX(t)+2*(this.getY(t)-n)*this.getDY(t)}},{key:"getDistNumerator",value:function(t,e,n){var i=this.getX(t)-e,o=this.getY(t)-n;return this.getDX(t)*i+this.getDY(t)*o}},{key:"getDistNumeratorDerivative",value:function(t,e,n){var i=this.getX(t)-e,o=this.getY(t)-n,s=this.getDX(t),r=this.getDY(t);return s*s+i*this.getDDX(t)+r*r+o*this.getDDY(t)}},{key:"getNearestT",value:function(t,e){for(var n=this,i=1e20,o=-1,s=0;s<=1;s+=1/WIRE_DIST_ITERATIONS){var r=this.getDist(s,t,e);r<i&&(o=s,i=r)}var a=findRoots(WIRE_NEWTON_ITERATIONS,o,t,e,function(t,e,i){return n.getDistDenominator(t,e,i)},function(t,e,i){return n.getDistDenominatorDerivative(t,e,i)});if(this.getDist2(a,t,e)<WIRE_DIST_THRESHOLD2)return a;var u=findRoots(WIRE_NEWTON_ITERATIONS,o,t,e,function(t,e,i){return n.getDistNumerator(t,e,i)},function(t,e,i){return n.getDistNumeratorDerivative(t,e,i)});return this.getDist2(u,t,e)<WIRE_DIST_THRESHOLD2?u:-1}},{key:"getBoundingBox",value:function(){return this.updateBoundingBox(),this.boundingBox}},{key:"copy",value:function(){return new t(this.p1.copy(),this.p2.copy(),this.c1.copy(),this.c2.copy())}},{key:"writeTo",value:function(t){var e=createChildNode(t,"bezier");createTextElement(e,"p1x",this.p1.x),createTextElement(e,"p1y",this.p1.y),createTextElement(e,"p2x",this.p2.x),createTextElement(e,"p2y",this.p2.y),createTextElement(e,"c1x",this.c1.x),createTextElement(e,"c1y",this.c1.y),createTextElement(e,"c2x",this.c2.x),createTextElement(e,"c2y",this.c2.y)}},{key:"load",value:function(t){var e=V(getFloatValue(getChildNode(t,"p1x")),getFloatValue(getChildNode(t,"p1y"))),n=V(getFloatValue(getChildNode(t,"p2x")),getFloatValue(getChildNode(t,"p2y"))),i=V(getFloatValue(getChildNode(t,"c1x")),getFloatValue(getChildNode(t,"c1y"))),o=V(getFloatValue(getChildNode(t,"c2x")),getFloatValue(getChildNode(t,"c2y")));this.update(e,n,i,o)}}]),t}(),Matrix2x3=function(){function t(e){if(_classCallCheck(this,t),this.mat=[],this.identity(),e instanceof t)for(var n=0;n<6;n++)this.mat[n]=e.mat[n]}return _createClass(t,[{key:"zero",value:function(){for(var t=0;t<6;t++)this.mat[t]=0;return this}},{key:"identity",value:function(){return this.zero(),this.mat[0]=1,this.mat[3]=1,this}},{key:"mul",value:function(t){var e=V(0,0);return e.x=this.mat[0]*t.x+this.mat[2]*t.y+this.mat[4],e.y=this.mat[1]*t.x+this.mat[3]*t.y+this.mat[5],e}},{key:"mult",value:function(e){var n=new t;return n.mat[0]=this.mat[0]*e.mat[0]+this.mat[2]*e.mat[1],n.mat[1]=this.mat[1]*e.mat[0]+this.mat[3]*e.mat[1],n.mat[2]=this.mat[0]*e.mat[2]+this.mat[2]*e.mat[3],n.mat[3]=this.mat[1]*e.mat[2]+this.mat[3]*e.mat[3],n.mat[4]=this.mat[0]*e.mat[4]+this.mat[2]*e.mat[5]+this.mat[4],n.mat[5]=this.mat[1]*e.mat[4]+this.mat[3]*e.mat[5]+this.mat[5],n}},{key:"translate",value:function(t){this.mat[4]+=this.mat[0]*t.x+this.mat[2]*t.y,this.mat[5]+=this.mat[1]*t.x+this.mat[3]*t.y}},{key:"rotate",value:function(t){var e=Math.cos(t),n=Math.sin(t),i=this.mat[0]*e+this.mat[2]*n,o=this.mat[1]*e+this.mat[3]*n,s=this.mat[0]*-n+this.mat[2]*e,r=this.mat[1]*-n+this.mat[3]*e;this.mat[0]=i,this.mat[1]=o,this.mat[2]=s,this.mat[3]=r}},{key:"scale",value:function(t){this.mat[0]*=t.x,this.mat[1]*=t.x,this.mat[2]*=t.y,this.mat[3]*=t.y}},{key:"inverse",value:function(){var e,n=new Array(6);if(n[0]=this.mat[3],n[1]=-this.mat[1],n[2]=-this.mat[2],n[3]=this.mat[0],n[4]=this.mat[2]*this.mat[5]-this.mat[4]*this.mat[3],n[5]=this.mat[4]*this.mat[1]-this.mat[0]*this.mat[5],0!=(e=this.mat[0]*this.mat[3]-this.mat[1]*this.mat[2])){e=1/e;for(var i=new t,o=0;o<6;o++)i.mat[o]=n[o]*e;return i}}},{key:"print",value:function(){console.log("["+this.mat[0].toFixed(3)+", "+this.mat[2].toFixed(3)+", "+this.mat[4].toFixed(3)+"]\n["+this.mat[1].toFixed(3)+", "+this.mat[3].toFixed(3)+", "+this.mat[5].toFixed(3)+"]")}}]),t}(),Transform=function(){function t(e,n,i,o){_classCallCheck(this,t),this.parent=void 0,this.pos=V(e.x,e.y),this.size=V(n.x,n.y),this.angle=i,this.scale=V(1,1),this.corners=[],this.localCorners=[],this.camera=o,this.dirty=!0,this.dirtySize=!0,this.dirtyCorners=!0,this.updateMatrix()}return _createClass(t,[{key:"updateMatrix",value:function(t){this.dirty&&(this.dirty=!1,this.matrix=new Matrix2x3,this.matrix.translate(this.pos),this.matrix.rotate(this.angle),this.matrix.scale(this.scale),void 0!=this.parent&&(this.matrix=this.parent.getMatrix().mult(this.matrix)),this.inverse=this.matrix.inverse())}},{key:"updateSize",value:function(){this.dirtySize&&(this.dirtySize=!1,this.localCorners=[this.size.scale(V(-.5,.5)),this.size.scale(V(.5,.5)),this.size.scale(V(.5,-.5)),this.size.scale(V(-.5,-.5))],this.radius=Math.sqrt(this.size.x*this.size.x+this.size.y*this.size.y)/2)}},{key:"updateCorners",value:function(){if(this.dirtyCorners){this.dirtyCorners=!1;for(var t=this.getLocalCorners(),e=0;e<4;e++)this.corners[e]=this.toWorldSpace(t[e])}}},{key:"transformCtx",value:function(t){this.updateMatrix();var e=new Matrix2x3(this.matrix),n=this.camera.getScreenPos(V(e.mat[4],e.mat[5]));e.mat[4]=n.x,e.mat[5]=n.y,e.scale(V(1/this.camera.zoom,1/this.camera.zoom)),t.setTransform(e.mat[0],e.mat[1],e.mat[2],e.mat[3],e.mat[4],e.mat[5])}},{key:"rotateAbout",value:function(t,e){this.setAngle(t),this.setPos(this.pos.sub(e));var n=Math.cos(t),i=Math.sin(t),o=this.pos.x*n-this.pos.y*i,s=this.pos.y*n+this.pos.x*i;this.setPos(V(o,s).add(e)),this.dirty=!0,this.dirtyCorners=!0}},{key:"setParent",value:function(t){this.parent=t,this.dirty=!0,this.dirtyCorners=!0}},{key:"setCamera",value:function(t){this.camera=t}},{key:"setPos",value:function(t){this.pos.x=t.x,this.pos.y=t.y,this.dirty=!0,this.dirtyCorners=!0}},{key:"setAngle",value:function(t){this.angle=t,this.dirty=!0,this.dirtyCorners=!0}},{key:"setScale",value:function(t){this.scale.x=t.x,this.scale.y=t.y,this.dirty=!0}},{key:"setSize",value:function(t){this.size.x=t.x,this.size.y=t.y,this.dirtySize=!0,this.dirtyCorners=!0}},{key:"setWidth",value:function(t){this.size.x=t,this.dirtySize=!0,this.dirtyCorners=!0}},{key:"setHeight",value:function(t){this.size.y=t,this.dirtySize=!0,this.dirtyCorners=!0}},{key:"toLocalSpace",value:function(t){return this.getInverseMatrix().mul(t)}},{key:"toWorldSpace",value:function(t){return this.getMatrix().mul(t)}},{key:"getPos",value:function(){return V(this.pos.x,this.pos.y)}},{key:"getAngle",value:function(){return this.angle}},{key:"getScale",value:function(){return V(this.scale.x,this.scale.y)}},{key:"getSize",value:function(){return this.size}},{key:"getRadius",value:function(){return this.updateSize(),this.radius}},{key:"getMatrix",value:function(){return this.updateMatrix(),this.matrix}},{key:"getInverseMatrix",value:function(){return this.updateMatrix(),this.inverse}},{key:"getBottomLeft",value:function(){return this.updateCorners(),this.corners[0]}},{key:"getBottomRight",value:function(){return this.updateCorners(),this.corners[1]}},{key:"getTopRight",value:function(){return this.updateCorners(),this.corners[2]}},{key:"getTopLeft",value:function(){return this.updateCorners(),this.corners[3]}},{key:"getCorners",value:function(){return this.updateCorners(),this.corners}},{key:"getLocalCorners",value:function(){return this.updateSize(),this.localCorners}},{key:"equals",value:function(e){if(!(e instanceof t))return!1;for(var n=this.getMatrix().mat,i=e.getMatrix().mat,o=0;o<n.length;o++)if(n[o]!==i[o])return!1;return!0}},{key:"print",value:function(){this.updateMatrix(),this.matrix.print()}},{key:"copy",value:function(){var e=new t(this.pos.copy(),this.size.copy(),this.angle,this.camera);return e.scale=this.scale.copy(),e.dirty=!0,e}}]),t}(),Vector=function(){function t(e,n){_classCallCheck(this,t),this.set(e,n)}return _createClass(t,[{key:"set",value:function(e,n){e instanceof t?(this.x=e.x?e.x:0,this.y=e.y?e.y:0):(this.x=e||0,this.y=n||0)}},{key:"translate",value:function(e,n){e instanceof t?this.set(this.add(e)):this.set(this.x+e,this.y+n)}},{key:"add",value:function(e,n){return e instanceof t?new t(this.x+e.x,this.y+e.y):new t(this.x+e,this.y+n)}},{key:"sub",value:function(e,n){return e instanceof t?new t(this.x-e.x,this.y-e.y):new t(this.x-e,this.y-n)}},{key:"scale",value:function(e){return e instanceof t?new t(e.x*this.x,e.y*this.y):new t(e*this.x,e*this.y)}},{key:"normalize",value:function(){var e=this.len();if(0===e)return new t(0,0);var n=1/e;return new t(this.x*n,this.y*n)}},{key:"len",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"len2",value:function(){return this.x*this.x+this.y*this.y}},{key:"distanceTo",value:function(t){return this.sub(t).len()}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y}},{key:"project",value:function(t){return this.scale(t.dot(this)/this.len2())}},{key:"copy",value:function(){return new t(this.x,this.y)}}]),t}(),Module=function(){function t(e,n,i){var o=this;_classCallCheck(this,t),this.parent=e,this.div=document.getElementById(n),this.divtext=i?document.getElementById(i):void 0,this.div.oninput=function(){render(),o.onChange()},this.div.onclick=function(){return o.onClick()},this.div.onfocus=function(){return o.onFocus()},this.div.onblur=function(){return o.onBlur()}}return _createClass(t,[{key:"blur",value:function(){this.div.blur()}},{key:"onShow",value:function(){}},{key:"setValue",value:function(t){this.div.value=t}},{key:"setPlaceholder",value:function(t){this.div.placeholder=t}},{key:"setVisibility",value:function(t){this.div.style.display=t,void 0!=this.divtext&&(this.divtext.style.display=t)}},{key:"setDisabled",value:function(t){this.div.disabled=t}},{key:"getValue",value:function(){return this.div.value}},{key:"onChange",value:function(){}},{key:"onClick",value:function(){}},{key:"onFocus",value:function(){this.parent.focused=!0}},{key:"onBlur",value:function(){this.parent.focused=!1}}]),t}(),Popup=function(){function t(e){var n=this;_classCallCheck(this,t),this.div=document.getElementById(e),this.div.addEventListener("keydown",function(t){n.onKeyDown(t.keyCode)},!1),this.div.addEventListener("keyup",function(t){n.onKeyUp(t.keyCode)},!1),this.div.style.position="absolute",this.focused=!1,this.modules=[],this.setPos(V(0,0)),this.hide()}return _createClass(t,[{key:"onKeyDown",value:function(t){}},{key:"onKeyUp",value:function(t){}},{key:"add",value:function(t){this.modules.push(t)}},{key:"update",value:function(){this.onShow()}},{key:"onShow",value:function(){for(var t=0;t<this.modules.length;t++)this.modules[t].onShow()}},{key:"blur",value:function(){for(var t=0;t<this.modules.length;t++)this.modules[t].blur()}},{key:"show",value:function(){this.hidden=!1,this.div.style.visibility="visible",this.div.focus(),this.onShow()}},{key:"hide",value:function(){this.hidden=!0,this.div.style.visibility="hidden",this.div.blur()}},{key:"setPos",value:function(t){this.pos=V(t.x,t.y),this.clamp(),this.div.style.left=this.pos.x+"px",this.div.style.top=this.pos.y+"px"}},{key:"clamp",value:function(){this.pos.x=Math.max(Math.min(this.pos.x,window.innerWidth-this.div.clientWidth-1),ItemNavController.isOpen?ITEMNAV_WIDTH+5:5),this.pos.y=Math.max(Math.min(this.pos.y,window.innerHeight-this.div.clientHeight-1),(header?header.clientHeight:0)+5)}}]),t}(),Exporter=function(){var t=document.getElementById("project-name");return{ROOT:void 0,saveFile:function(){var e=this.write(getCurrentContext()),n=t.value;"Untitled Circuit*"===n&&(n="Untitled Circuit");var i=n+".circuit",o=new Blob([e],{type:"text/plain"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(o,i),saved=!0;else{var s=document.createElement("a"),r=URL.createObjectURL(o);s.href=r,s.download=i,document.body.appendChild(s),s.click(),setTimeout(function(){document.body.removeChild(s),window.URL.revokeObjectURL(r),saved=!0},0)}},write:function(t){var e=(new window.DOMParser).parseFromString('<?xml version="1.0" encoding="UTF-8"?><project></project>',"text/xml");this.ROOT=e;var n=t.getObjects(),i=t.getWires(),o=getChildNode(e,"project"),s=createChildNode(o,"ics");return this.writeICs(s),this.writeGroup(o,n,i),e.xml?e.xml:(new XMLSerializer).serializeToString(e)},writeGroup:function(t,e,n){for(var i=createChildNode(t,"objects"),o=createChildNode(t,"wires"),s=0;s<e.length;s++)e[s].writeTo(i);for(s=0;s<n.length;s++)n[s].writeTo(o)},writeICs:function(t){for(var e=0;e<ICData.ICs.length;e++){var n=ICData.ICs[e],i=createChildNode(t,"ic");createTextElement(i,"icuid",n.icuid),createTextElement(i,"width",n.transform.size.x),createTextElement(i,"height",n.transform.size.y);for(var o=createChildNode(i,"iports"),s=0;s<n.iports.length;s++)n.iports[s].writeTo(o);for(var r=createChildNode(i,"oports"),s=0;s<n.oports.length;s++)n.oports[s].writeTo(r);var a=createChildNode(i,"components"),u=n.inputs.concat(n.components,n.outputs),c=getAllWires(u);this.writeGroup(a,u,c)}}}}(),Importer=function(){var t=document.getElementById("file-input");return{types:[],openFile:function(){if(confirm("Are you sure you want to overwrite your current scene?")){reset();var e=new FileReader;e.onload=function(t){Importer.load(e.result,getCurrentContext()),render()},e.readAsText(t.files[0])}},load:function(t,e){t=t.substring(0,t.indexOf(">")+1)+t.substring(t.indexOf(">")+1).replace(/\s/g,"");var n=(new window.DOMParser).parseFromString(t,"text/xml");if("parsererror"!=n.documentElement.nodeName){var i=getChildNode(n,"project"),o=getChildNode(i,"ics"),s=this.loadICs(o,e),r=this.loadGroup(i,e,s);e.addObjects(r.objects),e.addWires(r.wires);for(var a=0;a<s.length;a++)ICData.add(s[a]);return e.redistributeUIDs(),ICData.redistributeUIDs(),r}},loadGroup:function(t,e,n){for(var i=getChildNode(t,"objects"),o=getChildNode(t,"wires"),s=[],r=[],a=0;a<this.types.length;a++)for(var u=this.types[a],c=getChildrenByTagName(i,u.getXMLName()),h=0;h<c.length;h++)s.push(new u(e).load(c[h],n));for(var l=getChildrenByTagName(o,"wire"),a=0;a<l.length;a++)r.push(new Wire(e).load(l[a]));for(a=0;a<r.length;a++)r[a].loadConnections(l[a],s);return{objects:s,wires:r}},loadICs:function(t,e){for(var n=[],i=getChildrenByTagName(t,"ic"),o=0;o<i.length;o++){var s=i[o],r=getIntValue(getChildNode(s,"icuid")),a=getIntValue(getChildNode(s,"width")),u=getIntValue(getChildNode(s,"height")),c=getChildNode(s,"components"),h=this.loadGroup(c,e,n),l=ICData.create(h.objects);l.icuid=r,l.transform.setSize(V(a,u));for(var d=getChildrenByTagName(getChildNode(s,"iports"),"iport"),p=0;p<d.length;p++)l.iports[p]=(new IPort).load(d[p]);for(var f=getChildrenByTagName(getChildNode(s,"oports"),"oport"),p=0;p<f.length;p++)l.oports[p]=(new OPort).load(f[p]);n.push(l)}return n}}}(),Input=function(){var t=new Vector(0,0),e=new Vector(0,0),n=new Vector(0,0),i=new Vector(0,0),o=!1,s=void 0,r=[],a=!1,u=!1,c=!1,h=!1,l=void 0;console.log(a);var d=function(a){var u=getCurrentContext().getRenderer().canvas,d=getCurrentContext().getCamera(),p=u.getBoundingClientRect();n.x=e.x,n.y=e.y,t=new Vector(a.clientX,a.clientY),e=new Vector(a.clientX-p.left,a.clientY-p.top),i=d.getWorldPos(e),h=o&&Date.now()-l>50;var f=!1;if(c&&h){var g=new Vector(e.x,e.y),v=s.sub(g);d.translate(d.zoom*v.x,d.zoom*v.y),s=e,popup.onMove(),f=!0}f=CurrentTool.onMouseMove(f)||f;for(var y=0;y<r.length;y++){var m=r[y];!m.disabled&&m.onMouseMove(f)&&(f=!0)}f&&render()},p=function(t){o=!1;var e=!1;e=CurrentTool.onMouseUp(e);for(var n=0;n<r.length;n++){var i=r[n];!i.disabled&&i.onMouseUp(e)&&(e=!0)}e&&render()},f=function(t){var e=!1;e=CurrentTool.onClick(e);for(var n=0;n<r.length;n++){var i=r[n];!i.disabled&&i.onClick(e)&&(e=!0)}e&&render()};return window.addEventListener("keydown",function(t){!function(t){var e=t.keyCode;switch(console.log(a),e){case SHIFT_KEY:a=!0;break;case CONTROL_KEY:case COMMAND_KEY:u=!0;break;case OPTION_KEY:c=!0,getCurrentContext().setCursor("pointer");break;case ENTER_KEY:document.activeElement!==document.body&&document.activeElement.blur()}for(var n=getCurrentContext().getObjects(),i=0;i<n.length;i++)n[i]instanceof Keyboard&&n[i].onKeyDown(e);getCurrentContext().getHistoryManager().onKeyDown(e),CurrentTool.onKeyDown(e)&&render()}(t)},!1),window.addEventListener("keyup",function(t){!function(t){var e=t.keyCode;switch(e){case SHIFT_KEY:a=!1;break;case CONTROL_KEY:case COMMAND_KEY:u=!1;break;case OPTION_KEY:c=!1,getCurrentContext().setCursor("default")}for(var n=getCurrentContext().getObjects(),i=0;i<n.length;i++)n[i]instanceof Keyboard&&n[i].onKeyUp(e);CurrentTool.onKeyUp(e)&&render()}(t)},!1),{registerContext:function(t){var n=t.getRenderer().canvas;n.addEventListener("click",function(t){return f()},!1),n.addEventListener("dblclick",function(t){},!1),n.addEventListener("wheel",function(t){return function(t){var n=getCurrentContext().getCamera(),i=.95;-t.deltaY/120<0&&(i=1/i);var o=n.getWorldPos(e);n.zoomBy(i);var s=n.getScreenPos(o),r=(e.x-s.x)*n.zoom,a=(e.y-s.y)*n.zoom;n.translate(-r,-a),popup.onWheel(),render()}(t)},!1),n.addEventListener("mousedown",function(t){return function(t){var e=getCurrentContext().getRenderer().canvas.getBoundingClientRect();if(h=!1,l=Date.now(),o=!0,s=new Vector(t.clientX-e.left,t.clientY-e.top),t.button===LEFT_MOUSE_BUTTON){var n=!1;contextmenu.hide(),n=CurrentTool.onMouseDown(n);for(var i=0;i<r.length;i++){var a=r[i];!a.disabled&&a.onMouseDown(n)&&(n=!0)}n&&render()}}(t)},!1),n.addEventListener("mouseup",function(t){return p()},!1),n.addEventListener("mousemove",function(t){return d(t)},!1),n.addEventListener("mouseenter",function(t){PlaceItemController.drag&&(d(t),f(),PlaceItemController.drag=!1)},!1),n.addEventListener("mouseleave",function(t){o&&(p(),f())}),n.addEventListener("contextmenu",function(t){contextmenu.show(t),t.preventDefault()})},addMouseListener:function(t){r.push(t)},getWorldMousePos:function(){return V(i)},getRawMousePos:function(){return V(t)},getShiftKeyDown:function(){return a},getModifierKeyDown:function(){return u},getOptionKeyDown:function(){return c},getIsDragging:function(){return h}}}(),ItemNavController=function(){var t=document.getElementById("open-items-tab"),e=document.getElementById("items");return{disabled:!1,isOpen:!1,toggle:function(){this.isOpen?(this.isOpen=!1,e.style.width="0px",t.style.marginLeft=ItemNavController.getTabOffset()+"px",t.style.borderColor="rgba(153, 153, 153, 0.7)",t.style.backgroundColor="rgba(200, 200, 200, 0.7)",t.style.fontSize="2em",t.innerHTML="&#9776;"):(this.isOpen=!0,e.style.width=ITEMNAV_WIDTH+"px",t.style.marginLeft=ItemNavController.getTabOffset()+"px",t.style.borderColor="rgba(153, 153, 153, 0.0)",t.style.backgroundColor="rgba(200, 200, 200, 0.0)",t.style.fontSize="2.5em",t.innerHTML="&times;")},getTabOffset:function(){return this.isOpen?ITEMNAV_WIDTH-t.offsetWidth:0}}}(),PlaceItemController={disabled:!1,drag:!1,place:function(t,e){e&&(t.not=e);getCurrentContext().getRenderer().canvas.getBoundingClientRect();itemTool.activate(t,getCurrentContext())},onDragEnd:function(t){this.drag=!0,t.srcElement.parentElement.onclick()}},SelectionBox=function(){var t=void 0,e=void 0;return{disabled:!1,onMouseDown:function(e){var n=getCurrentContext().getObjects(),i=getCurrentContext().getWires(),o=Input.getWorldMousePos();if(!e&&selectionTool.isActive&&!Input.getOptionKeyDown()){for(r=0;r<n.length;r++){var s=n[r];if(s.contains(o)||s.sContains(o)||-1!==s.oPortContains(o)||-1!==s.iPortContains(o))return}for(var r=0;r<i.length;r++){if(-1!==i[r].getNearestT(o.x,o.y))return}t=V(o),popup.hide()}},onMouseMove:function(){getCurrentContext().getObjects();var n=Input.getWorldMousePos();if(void 0!=t)return e=V(n),popup.hide(),!0},onMouseUp:function(){},onClick:function(n){getCurrentContext().getObjects();var i=Input.getWorldMousePos();if(void 0!=t){e=V(i);var o=function(){var n=getCurrentContext().getObjects(),i=[];if(void 0!=t)for(var o=new Transform(V((t.x+e.x)/2,(t.y+e.y)/2),V(Math.abs(e.x-t.x),Math.abs(e.y-t.y)),0,getCurrentContext().getCamera()),s=0;s<n.length;s++){var r=n[s];if(transformContains(void 0!=r.selectionBoxTransform?r.selectionBoxTransform:r.transform,o))i.push(r);else if(void 0!=r.inputs&&void 0!=r.outputs){for(u=0;u<r.inputs.length;u++){var a=r.inputs[u];rectContains(o,a.getPos())&&i.push(a)}for(var u=0;u<r.outputs.length;u++){var c=r.outputs[u];rectContains(o,c.getPos())&&i.push(c)}}}return i}();return Input.getShiftKeyDown()||selectionTool.deselectAll(!0),selectionTool.select(o,!0),t=void 0,e=void 0,!0}},draw:function(n){var i=n.getCamera();if(void 0!=t&&void 0!=e){var o=i.getScreenPos(t),s=i.getScreenPos(e),r=s.x-o.x,a=s.y-o.y;n.save(),n.context.globalAlpha=.4,n.rect(o.x+r/2,o.y+a/2,r,a,"#ffffff","#6666ff",2/i.zoom),n.restore()}}}}(),SideNavController=function(){document.getElementById("open-sive-nav-button"),document.getElementById("open-items-tab");var t=document.getElementById("sidenav"),e=document.getElementById("content"),n=document.getElementById("overlay");n&&n.addEventListener("transitionend",function(t){SideNavController.isOpen||(n.style.visibility="hidden")},!1);return{disabled:!1,isOpen:!1,toggle:function(){this.isOpen?(this.isOpen=!1,t.style.width="0px",e.style.marginLeft="0px",n.style.opacity="0",n.onclick=function(){}):(this.isOpen=!0,t.style.width=SIDENAV_WIDTH+"px",e.style.marginLeft=SIDENAV_WIDTH+"px",n.style.visibility="visible",n.style.opacity="1",n.onclick=function(){SideNavController.toggle()})},getWidth:function(){return this.isOpen?SIDENAV_WIDTH:0}}}(),Tool=function(){function t(){_classCallCheck(this,t),this.isActive=!1}return _createClass(t,[{key:"activate",value:function(){CurrentTool&&CurrentTool.deactivate(),CurrentTool=this,this.isActive=!0,render()}},{key:"deactivate",value:function(){this.isActive=!1}},{key:"onKeyDown",value:function(t){}},{key:"onKeyUp",value:function(t){}},{key:"onMouseDown",value:function(){}},{key:"onMouseMove",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"onClick",value:function(){}},{key:"draw",value:function(){}}]),t}(),TransformController=function(){var t=void 0,e=!1,n=!1,i=V(0,0),o=[],s=0,r=0,a=[],u=[],c=[];return{disabled:!1,startDrag:function(n,s){n.selected||(selectionTool.deselectAll(!0),selectionTool.select([n],!0)),o=selectionTool.selections,c=[];for(var r=0;r<o.length;r++){if(!o[r].transform)return!0;c[r]=o[r].transform.copy()}return e=!0,i=s.copy().sub(n.getPos()),t=n,popup.hide(),!0},startRotation:function(t,e){u=t,a=[],c=[];for(var i=0;i<u.length;i++){if(!u[i].transform)return!0;a[i]=u[i].getAngle(),c[i]=u[i].transform.copy()}return n=!0,s=Math.atan2(e.y-selectionTool.midpoint.y,e.x-selectionTool.midpoint.x),r=s,popup.hide(),!0},onMouseDown:function(){var e=getCurrentContext().getObjects(),i=Input.getWorldMousePos();if(!n&&selectionTool.selections.length>0){var o=i.sub(selectionTool.midpoint).len2();if(o<=ROTATION_CIRCLE_R2&&o>=ROTATION_CIRCLE_R1)return this.startRotation(selectionTool.selections,i)}for(var s=e.length-1;s>=0;s--){var r=e[s];if(r.contains(i)||r.sContains(i))return void(t=r)}},onMouseMove:function(){getCurrentContext().getObjects();var s=Input.getWorldMousePos();return e||void 0==t?e?(function(e,n){for(var s=V(e).sub(t.getPos()).sub(i),r=0;r<o.length;r++){var a=o[r],u=a.getPos().add(s);n&&(u=V(Math.floor(u.x/GRID_SIZE+.5)*GRID_SIZE,Math.floor(u.y/GRID_SIZE+.5)*GRID_SIZE)),a.setPos(u)}selectionTool.recalculateMidpoint()}(s,Input.getShiftKeyDown()),!0):n?(function(t,e){for(var n=selectionTool.midpoint,i=Math.atan2(t.y-n.y,t.x-n.x)-r,o=0;o<u.length;o++){var s=a[o]+i;a[o]=s,e&&(s=Math.floor(s/(Math.PI/4))*Math.PI/4),u[o].setRotationAbout(s,n)}r=i+r}(s,Input.getShiftKeyDown()),!0):void 0:this.startDrag(t,s)},onMouseUp:function(){return t=void 0,e?(getCurrentContext().addAction(createTransformAction(o,c)),e=!1,!0):n?(getCurrentContext().addAction(createTransformAction(u,c)),n=!1,!0):void 0},onClick:function(){},draw:function(t){var e=t.getCamera(),i=e.getScreenPos(selectionTool.midpoint),o=ROTATION_CIRCLE_RADIUS/e.zoom;if(n){t.save(),t.context.fillStyle="#fff",t.context.strokeStyle="#000",t.context.lineWidth=5,t.context.globalAlpha=.4,t.context.beginPath(),t.context.moveTo(i.x,i.y);var a=(r-s)%(2*Math.PI);a<0&&(a+=2*Math.PI),t.context.arc(i.x,i.y,o,s,r,a>Math.PI),t.context.fill(),t.context.closePath(),t.restore()}}}}(),WireController=function(){var t=void 0,e=void 0,n=-1;return{disabled:!1,onMouseDown:function(i){var o=getCurrentContext().getObjects(),s=getCurrentContext().getWires(),r=Input.getWorldMousePos();if(!i){for(c=o.length-1;c>=0;c--){var a,u=o[c];if(-1!==(a=u.oPortContains(r)))return void(t=u.outputs[a]);if(-1!==(a=u.iPortContains(r)))return void(t=u.inputs[a])}for(var c=0;c<s.length;c++){var h,l=s[c];if(-1!==(h=l.getNearestT(r.x,r.y)))return e=l,n=h,!0}}},onMouseMove:function(i){var o=Input.getWorldMousePos();if(!i){if(void 0!=t)return wiringTool.activate(t,getCurrentContext()),t=void 0,!0;if(void 0!=e){e.split(n);var s=new SplitWireAction(e);return getCurrentContext().addAction(s),selectionTool.deselectAll(!0),selectionTool.select([e.connection],!0),TransformController.startDrag(e.connection,o),e=void 0,!0}}},onMouseUp:function(){},onClick:function(n){return n?(t=void 0,void(e=void 0)):void 0!=t?(wiringTool.activate(t,getCurrentContext()),t=void 0,!0):void 0!=e?(Input.getShiftKeyDown()||selectionTool.deselectAll(!0),selectionTool.select([e],!0),e=void 0,!0):void 0}}}(),ContextMenu=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"context-menu"));return t.add(new CutModule(t,"context-menu-cut")),t.add(new CopyModule(t,"context-menu-copy")),t.add(new PasteModule(t,"context-menu-paste")),t.add(new SelectAllModule(t,"context-menu-select-all")),t.add(new UndoModule(t,"context-menu-undo")),t.add(new RedoModule(t,"context-menu-redo")),t}return _inherits(e,Popup),_createClass(e,[{key:"onKeyDown",value:function(t){t!==ESC_KEY||this.hidden||this.hide()}},{key:"onShow",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"onShow",this).call(this);var t=Input.getRawMousePos();this.setPos(V(t.x,t.y))}}]),e}(),CopyModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){this.setDisabled(0==selectionTool.selections.length)}},{key:"onClick",value:function(){this.parent.hide(),document.execCommand("copy")}}]),e}(),CutModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){this.setDisabled(0==selectionTool.selections.length)}},{key:"onClick",value:function(){this.parent.hide(),document.execCommand("cut")}}]),e}(),PasteModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){this.setDisabled(!1)}},{key:"onClick",value:function(){this.parent.hide(),document.execCommand("copy")}}]),e}(),RedoModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){this.setDisabled(0==getCurrentContext().designer.history.redoStack.length)}},{key:"onClick",value:function(){this.parent.hide(),getCurrentContext().designer.history.redo()}}]),e}(),SelectAllModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){this.setDisabled(!1)}},{key:"onClick",value:function(){this.parent.hide(),selectionTool.selectAll(),render()}}]),e}(),UndoModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){this.setDisabled(0==getCurrentContext().designer.history.undoStack.length)}},{key:"onClick",value:function(){this.parent.hide(),getCurrentContext().designer.history.undo()}}]),e}(),BusButtonModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=0,e=0,n=selectionTool.selections,i=0;i<n.length;i++)if(n[i]instanceof IPort)t++;else{if(!(n[i]instanceof OPort))return void this.setVisibility("none");e++}this.setVisibility(t===e?"inherit":"none")}},{key:"onClick",value:function(){this.createBus()}},{key:"createBus",value:function(){for(var t=selectionTool.selections,e=[],n=[],i=0;i<t.length;i++)t[i]instanceof IPort?e.push(t[i]):n.push(t[i]);for(;n.length>0;){for(var o=-1/0,s=-1,r=-1,i=0;i<n.length;i++){for(var a=n[i].getPos(),u=1/0,c=-1,h=0;h<e.length;h++){var l=e[h],d=a.sub(l.getPos()).len2();d<u&&(u=d,c=h)}u>o&&(o=u,s=i,r=c)}var p=new Wire(context);getCurrentContext().add(p),n[s].connect(p),p.connect(e[r]),p.set=!0,p.straight=!0,n.splice(s,1),e.splice(r,1)}render()}}]),e}(),ColorPickerModule=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=!0,e=!0,n=selectionTool.selections,i=0;i<n.length;i++)(t=t&&n[i]instanceof LED)&&(e=e&&n[i].color===n[0].color);this.setVisibility(t?"inherit":"none"),this.setValue(t&&e?n[0].color:"#ffffff")}},{key:"onChange",value:function(){for(var t=selectionTool.selections,e=0;e<t.length;e++)t[e].color=this.getValue()}},{key:"onFocus",value:function(){this.parent.focused=!0}},{key:"onBlur",value:function(){this.parent.focused=!1,this.onChange()}}]),e}(),ICButtonModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=0,e=selectionTool.selections,n=0;n<e.length;n++)e[n]instanceof IOObject&&!(e[n]instanceof WirePort)&&t++;this.setVisibility(t>=2?"inherit":"none")}},{key:"onClick",value:function(){icdesigner.show(selectionTool.selections)}}]),e}(),InputCountModule=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=!0,e=!0,n=0,i=999,o=selectionTool.selections,s=0;s<o.length;s++)e=e&&o[s].maxInputs>1&&!0!==o[s].noChange,t=t&&o[s].getInputAmount()===o[0].getInputAmount(),n=Math.max(o[s].getMinInputFieldCount(),n),i=Math.min(o[s].getMaxInputFieldCount(),i);this.setValue(t?o[0].getInputAmount():""),this.setPlaceholder(t?"":"-"),this.setVisibility(e?"inherit":"none"),this.div.min=n,this.div.max=i}},{key:"onChange",value:function(){for(var t=selectionTool.selections,e=0;e<t.length;e++)t[e].setInputAmount(Number(this.getValue()))}}]),e}(),PositionXModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=!0,e=selectionTool.selections,n=0;n<e.length;n++)t=t&&e[n].getPos().x===e[0].getPos().x;this.setValue(t?+(e[0].getPos().x/GRID_SIZE-.5).toFixed(3):""),this.setPlaceholder(t?"":"-")}},{key:"onChange",value:function(){for(var t=new GroupAction,e=selectionTool.selections,n=0;n<e.length;n++){if(!e[n].transform)return void this.onShow();var i=e[n].transform.copy();e[n].setPos(V(GRID_SIZE*(Number(this.getValue())+.5),e[n].transform.getPos().y));var o=e[n].transform.copy();t.add(new TransformAction(e[n],i,o))}getCurrentContext().addAction(t)}}]),e}(),PositionYModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=!0,e=selectionTool.selections,n=0;n<e.length;n++)t=t&&e[n].getPos().y===e[0].getPos().y;this.setValue(t?+(e[0].getPos().y/GRID_SIZE-.5).toFixed(3):""),this.setPlaceholder(t?"":"-")}},{key:"onChange",value:function(){for(var t=new GroupAction,e=selectionTool.selections,n=0;n<e.length;n++){if(!e[n].transform)return void this.onShow();var i=e[n].transform.copy();e[n].setPos(V(e[n].transform.getPos().x,GRID_SIZE*(Number(this.getValue())+.5)));var o=e[n].transform.copy();t.add(new TransformAction(e[n],i,o))}getCurrentContext().addAction(t)}}]),e}(),SelectionPopup=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"popup"));return t.add(new TitleModule(t,"popup-name")),t.add(new PositionXModule(t,"popup-position-x")),t.add(new PositionYModule(t,"popup-position-y")),t.add(new InputCountModule(t,"popup-input-count","popup-input-count-text")),t.add(new ColorPickerModule(t,"popup-color-picker","popup-color-text")),t.add(new ICButtonModule(t,"popup-ic-button")),t.add(new BusButtonModule(t,"popup-bus-button")),t}return _inherits(e,Popup),_createClass(e,[{key:"onKeyDown",value:function(t){if(t!==DELETE_KEY||this.focused)return t!==ESC_KEY||this.hidden?void 0:(selectionTool.deselectAll(),void render());RemoveObjects(getCurrentContext(),selectionTool.selections,!0)}},{key:"onEnter",value:function(){this.blur()}},{key:"update",value:function(){selectionTool.selections.length>0?(this.show(),this.onMove()):this.hide()}},{key:"onMove",value:function(){var t=getCurrentContext().getCamera();if(selectionTool.selections.length>0){selectionTool.recalculateMidpoint();var e=t.getScreenPos(selectionTool.midpoint);e.y-=this.div.clientHeight/2,this.setPos(e)}}},{key:"onWheel",value:function(){this.onMove()}}]),e}(),TitleModule=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,Module),_createClass(e,[{key:"onShow",value:function(){for(var t=!0,e=selectionTool.selections,n=0;n<e.length;n++)t=t&&e[n].getName()===e[0].getName();this.setValue(t?e[0].getName():"<Multiple>")}},{key:"onChange",value:function(){for(var t=selectionTool.selections,e=0;e<t.length;e++)t[e].setName(this.getValue())}},{key:"onFocus",value:function(){this.parent.focused=!0}},{key:"onBlur",value:function(){this.parent.focused=!1,this.onChange()}}]),e}(),ItemTool=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.item=void 0,t}return _inherits(e,Tool),_createClass(e,[{key:"activate",value:function(t,n){void 0!=this.item&&n.remove(this.item),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this),this.item=t,n.addObject(this.item),this.onMouseMove()}},{key:"deactivate",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deactivate",this).call(this),this.item=void 0}},{key:"onMouseMove",value:function(){return this.item.setPos(Input.getWorldMousePos()),!0}},{key:"onClick",value:function(){this.item.setPos(Input.getWorldMousePos());var t=new PlaceAction(this.item);return getCurrentContext().addAction(t),selectionTool.activate(),!0}}]),e}(),itemTool=new ItemTool,SelectionTool=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.selections=[],t.midpoint=V(0,0),t}return _inherits(e,Tool),_createClass(e,[{key:"onKeyDown",value:function(t,e){return console.log(t),!!icdesigner.hidden&&(t===A_KEY&&Input.getModifierKeyDown()?(this.selectAll(),!0):void 0)}},{key:"onMouseDown",value:function(){var t=getCurrentContext().getObjects(),e=(getCurrentContext().getWires(),Input.getWorldMousePos());if(!icdesigner.hidden)return!1;for(var n=t.length-1;n>=0;n--){var i=t[n];if(i.contains(e))return i.isPressable&&i.press(),!0;if(i.sContains(e))return;if(-1!==i.oPortContains(e)||-1!==i.iPortContains(e))return}}},{key:"onMouseMove",value:function(){}},{key:"onMouseUp",value:function(){var t=getCurrentContext().getObjects();getCurrentContext().getWires(),Input.getWorldMousePos();if(!icdesigner.hidden)return!1;popup.update();for(var e=0;e<t.length;e++){var n=t[e];if(n.isPressable&&n.isOn&&!Input.isDragging)return n.release(),!0}}},{key:"onClick",value:function(){var t=getCurrentContext().getObjects(),e=(getCurrentContext().getWires(),Input.getWorldMousePos());if(!icdesigner.hidden||Input.getIsDragging())return!1;for(var n=t.length-1;n>=0;n--){var i=t[n];if(i.sContains(e)){if(i.selected)return!1;if(!Input.getShiftKeyDown()&&this.selections.length>0){this.deselectAll(!0);var o=getCurrentContext().designer.history.undoStack.pop();this.select([i],!0);var s=getCurrentContext().designer.history.undoStack.pop(),r=new GroupAction;void 0!=o&&r.add(o),r.add(s),getCurrentContext().addAction(r)}else this.select([i],!0);return!0}if(i.contains(e))return i.click(),!0}return!Input.getShiftKeyDown()&&this.selections.length>0?(this.deselectAll(!0),!0):void 0}},{key:"select",value:function(t,e){if(0!==t.length){for(var n=new GroupAction,i=0;i<t.length;i++){var o=t[i];o.selected||(o.selected=!0,this.selections.push(o),this.sendToFront(o),e&&n.add(new SelectAction(o)))}e&&getCurrentContext().addAction(n),popup.update(),this.recalculateMidpoint()}}},{key:"deselect",value:function(t,e){if(0!==t.length){for(var n=new GroupAction,i=0;i<t.length;i++){var o=t[i];o.selected?(o.selected=!1,this.selections.splice(this.selections.indexOf(o),1),e&&n.add(new SelectAction(o,!0))):console.error("Can't deselect an unselected object! "+o)}e&&getCurrentContext().addAction(n),popup.update(),this.recalculateMidpoint()}}},{key:"selectAll",value:function(){this.deselectAll(!0),this.select(getCurrentContext().getObjects(),!0)}},{key:"deselectAll",value:function(t){for(var e=[],n=0;n<this.selections.length;n++)e.push(this.selections[n]);this.deselect(e,t)}},{key:"sendToFront",value:function(t){(t instanceof IOObject||t instanceof Wire)&&(getCurrentContext().remove(t),getCurrentContext().add(t))}},{key:"recalculateMidpoint",value:function(){this.midpoint=V(0,0);for(var t=0;t<this.selections.length;t++)this.midpoint.translate(this.selections[t].getPos());this.midpoint=this.midpoint.scale(1/this.selections.length)}},{key:"draw",value:function(t){var e=t.getCamera();if(this.selections.length>0&&!this.drag){var n=e.getScreenPos(this.midpoint),i=ROTATION_CIRCLE_RADIUS/e.zoom,o=ROTATION_CIRCLE_THICKNESS/e.zoom;TransformController.draw(t),t.circle(n.x,n.y,i,void 0,"#ff0000",o,.5)}SelectionBox.draw(t)}}]),e}(),selectionTool=new SelectionTool,WiringTool=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.clickOPort=!1,t.wire=void 0,t}return _inherits(e,Tool),_createClass(e,[{key:"onKeyUp",value:function(t,e){t===ESC_KEY&&(this.removeWire(),selectionTool.activate(),render())}},{key:"activate",value:function(t,n){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this),console.log(t),this.wire=new Wire(n),this.clickOPort=t instanceof OPort;(this.clickOPort?t.connect(this.wire):this.wire.connect(t))?(this.onMouseMove(),n.addWire(this.wire)):selectionTool.activate()}},{key:"deactivate",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deactivate",this).call(this),this.wire=void 0}},{key:"removeWire",value:function(){getCurrentContext().remove(this.wire),this.clickOPort?this.wire.input.disconnect(this.wire):this.wire.disconnect()}},{key:"onMouseMove",value:function(){return this.clickOPort?this.wire.curve.update(this.wire.curve.p1,Input.getWorldMousePos(),this.wire.curve.c1,Input.getWorldMousePos()):this.wire.curve.update(Input.getWorldMousePos(),this.wire.curve.p2,Input.getWorldMousePos(),this.wire.curve.c2),!0}},{key:"onClick",value:function(){for(var t=getCurrentContext().getObjects(),e=Input.getWorldMousePos(),n=0;n<t.length;n++){var i=-1;if(this.clickOPort&&-1!==(i=t[n].iPortContains(e))&&(this.wire.connect(t[n].inputs[i])||this.removeWire()),this.clickOPort||-1===(i=t[n].oPortContains(e))||t[n].outputs[i].connect(this.wire)||this.removeWire(),-1!==i){var o=new PlaceWireAction(this.wire);return getCurrentContext().addAction(o),selectionTool.activate(),!0}}return this.removeWire(),selectionTool.activate(),!0}}]),e}(),wiringTool=new WiringTool,IOObject=function(){function t(e,n,i,o,s,r,a,u,c,h,l){_classCallCheck(this,t),void 0==e&&(e=getCurrentContext()),this.context=e,n=void 0==n?0:n,i=void 0==i?0:i,this.transform=new Transform(V(n,i),V(o,s),0,e.getCamera()),this.cullTransform=new Transform(this.transform.getPos(),V(0,0),0,this.context.getCamera()),this.name=this.getDisplayName(),this.img=r,this.isOn=!1,this.isPressable=a,this.maxInputs=u,this.maxOutputs=c,this.selected=!1,this.isPressable&&(this.selectionBoxTransform=new Transform(V(n,i),V(h,l),0,e.getCamera())),this.outputs=[],this.inputs=[],c>0&&this.setOutputAmount(1)}return _createClass(t,[{key:"setInputAmount",value:function(t){for(t=clamp(t,0,this.maxInputs);this.inputs.length>t;)this.inputs.splice(this.inputs.length-1,1);for(;this.inputs.length<t;)this.inputs.push(new IPort(this));for(var e=0;e<this.inputs.length;e++)this.inputs[e].updatePosition();this.onTransformChange()}},{key:"setOutputAmount",value:function(t){for(t=clamp(t,0,this.maxOutputs);this.outputs.length>t;)this.outputs.splice(this.outputs.length-1,1);for(;this.outputs.length<t;)this.outputs.push(new OPort(this));for(var e=0;e<this.outputs.length;e++)this.outputs[e].updatePosition();this.onTransformChange()}},{key:"onTransformChange",value:function(){this.isPressable&&void 0!=this.selectionBoxTransform&&(this.selectionBoxTransform.setPos(this.transform.getPos()),this.selectionBoxTransform.setAngle(this.transform.getAngle()),this.selectionBoxTransform.setScale(this.transform.getScale())),this.updateCullTransform();for(t=0;t<this.inputs.length;t++)this.inputs[t].onTransformChange();for(var t=0;t<this.outputs.length;t++)this.outputs[t].onTransformChange()}},{key:"updateCullTransform",value:function(){var t=V(-this.transform.size.x/2,-this.transform.size.y/2),e=V(this.transform.size.x/2,this.transform.size.y/2);void 0!=this.selectionBoxTransform&&(t.x=Math.min(-this.selectionBoxTransform.size.x/2,t.x),t.y=Math.min(-this.selectionBoxTransform.size.y/2,t.y),e.x=Math.max(this.selectionBoxTransform.size.x/2,e.x),e.y=Math.max(this.selectionBoxTransform.size.y/2,e.y));for(i=0;i<this.inputs.length;i++){var n=this.inputs[i];t.x=Math.min(n.target.x,t.x),t.y=Math.min(n.target.y,t.y),e.x=Math.max(n.target.x,e.x),e.y=Math.max(n.target.y,e.y)}for(var i=0;i<this.outputs.length;i++){var o=this.outputs[i];t.x=Math.min(o.target.x,t.x),t.y=Math.min(o.target.y,t.y),e.x=Math.max(o.target.x,e.x),e.y=Math.max(o.target.y,e.y)}this.cullTransform.setSize(V(e.x-t.x,e.y-t.y));var s=Math.cos(this.transform.getAngle()),r=Math.sin(this.transform.getAngle()),a=(t.x- -this.cullTransform.size.x/2)*s+(t.y- -this.cullTransform.size.y/2)*r,u=(t.y- -this.cullTransform.size.y/2)*s+(t.x- -this.cullTransform.size.x/2)*r;this.cullTransform.setPos(this.transform.getPos().add(V(a,u))),this.cullTransform.setAngle(this.transform.getAngle()),this.cullTransform.setScale(this.transform.getScale()),this.cullTransform.setSize(this.cullTransform.size.add(V(2*IO_PORT_RADIUS,2*IO_PORT_RADIUS)))}},{key:"click",value:function(){}},{key:"press",value:function(){}},{key:"release",value:function(){}},{key:"activate",value:function(t,e){void 0==e&&(e=0),this.isOn=t,void 0!=this.outputs[e]&&this.outputs[e].activate(t)}},{key:"localSpace",value:function(){var t=this.context.getRenderer();t.save(),this.transform.transformCtx(t.context)}},{key:"draw",value:function(){this.localSpace();for(t=0;t<this.inputs.length;t++)this.inputs[t].draw();for(var t=0;t<this.outputs.length;t++)this.outputs[t].draw(t);var e=this.context.getRenderer();this.isPressable&&void 0!=this.selectionBoxTransform&&e.rect(0,0,this.selectionBoxTransform.size.x,this.selectionBoxTransform.size.y,this.getCol(),this.getBorderColor()),void 0!=this.img&&e.image(this.img,0,0,this.transform.size.x,this.transform.size.y,this.getImageTint()),e.restore()}},{key:"remove",value:function(){this.context.remove(this);for(t=0;t<this.outputs.length;t++)this.outputs[t].remove();for(var t=0;t<this.inputs.length;t++)this.inputs[t].remove()}},{key:"contains",value:function(t){return rectContains(this.transform,t)}},{key:"sContains",value:function(t){return!this.isPressable&&this.contains(t)||this.isPressable&&!this.contains(t)&&rectContains(this.selectionBoxTransform,t)}},{key:"iPortContains",value:function(t){for(var e=0;e<this.inputs.length;e++)if(this.inputs[e].contains(t))return e;return-1}},{key:"oPortContains",value:function(t){for(var e=0;e<this.outputs.length;e++)if(this.outputs[e].contains(t))return e;return-1}},{key:"setContext",value:function(t){this.context=t,this.transform.setCamera(this.context.getCamera()),void 0!=this.selectionBoxTransform&&this.selectionBoxTransform.setCamera(this.context.getCamera())}},{key:"setTransform",value:function(t){this.transform=t,this.onTransformChange()}},{key:"setPos",value:function(t){this.transform.setPos(t),this.onTransformChange()}},{key:"setAngle",value:function(t){this.transform.setAngle(t),this.onTransformChange()}},{key:"setRotationAbout",value:function(t,e){this.transform.rotateAbout(-this.getAngle(),e),this.transform.rotateAbout(t,e),this.onTransformChange()}},{key:"setName",value:function(t){this.name=t}},{key:"getCullBox",value:function(){return this.cullTransform}},{key:"getInputAmount",value:function(){return this.inputs.length}},{key:"getImageTint",value:function(){return this.getCol()}},{key:"getCol",value:function(){return this.selected?"#1cff3e":void 0}},{key:"getBorderColor",value:function(){return this.selected?"#0d7f1f":void 0}},{key:"getPos",value:function(){return this.transform.pos.copy()}},{key:"getAngle",value:function(){return this.transform.angle}},{key:"getSize",value:function(){return this.transform.size}},{key:"getMaxInputFieldCount",value:function(){return 8}},{key:"getMinInputFieldCount",value:function(){return 2}},{key:"getName",value:function(){return this.name}},{key:"getDisplayName",value:function(){return"IOObject"}},{key:"getRenderer",value:function(){return this.context.getRenderer()}},{key:"copy",value:function(){var t=new this.constructor(this.context);t.transform=this.transform.copy(),t.name=this.name,void 0!=this.selectionBoxTransform&&(t.selectionBoxTransform=this.selectionBoxTransform.copy());for(e=0;e<this.inputs.length;e++)t.inputs[e]=this.inputs[e].copy(),t.inputs[e].parent=t;for(var e=0;e<this.outputs.length;e++)t.outputs[e]=this.outputs[e].copy(),t.outputs[e].parent=t;return t}},{key:"writeTo",value:function(t){var e=createChildNode(t,this.constructor.getXMLName());return createTextElement(e,"uid",this.uid),createTextElement(e,"name",this.getName()),createTextElement(e,"x",this.getPos().x),createTextElement(e,"y",this.getPos().y),createTextElement(e,"angle",this.getAngle()),e}},{key:"load",value:function(t){var e=getIntValue(getChildNode(t,"uid")),n=getStringValue(getChildNode(t,"name")),i=getFloatValue(getChildNode(t,"x")),o=getFloatValue(getChildNode(t,"y")),s=getFloatValue(getChildNode(t,"angle")),r=getBooleanValue(getChildNode(t,"isOn"),!1);return this.uid=e,this.setName(n),r&&this.click(r),this.setPos(V(i,o)),this.setAngle(s),this}}]),t}(),IOPort=function(){function t(e,n){_classCallCheck(this,t),this.isOn=!1,this.parent=e,this.connections=[],this.lineColor=DEFAULT_BORDER_COLOR,this.origin=V(0,0),this.target=n.scale(IO_PORT_LENGTH),this.dir=n,this.set=!1,void 0!=e&&this.updatePosition()}return _createClass(t,[{key:"getArray",value:function(){}},{key:"getIndex",value:function(){for(var t=0;t<this.getArray().length&&this.getArray()[t]!==this;t++);return t}},{key:"getCol",value:function(){return this.parent.selected||this.selected?"#1cff3e":void 0}},{key:"getBorderColor",value:function(){return this.parent.selected||this.selected?"#0d7f1f":void 0}},{key:"updatePosition",value:function(){var t=this.getIndex(),e=-this.parent.transform.size.y/2*(t-this.getArray().length/2+.5);0===t&&(e-=1),t===this.getArray().length-1&&(e+=1),this.origin.y=e,this.target.y=e,this.prevParentLength=this.getArray().length}},{key:"onTransformChange",value:function(){this.set||this.updatePosition();for(var t=0;t<this.connections.length;t++)void 0!=this.connections[t]&&this.connections[t].onTransformChange()}},{key:"activate",value:function(t){}},{key:"contains",value:function(t){var e=new Transform(this.target,V(IO_PORT_RADIUS,IO_PORT_RADIUS).scale(2),0,this.parent.context.getCamera());return e.setParent(this.parent.transform),circleContains(e,t)}},{key:"sContains",value:function(t){var e=Math.atan2(this.target.y-this.origin.y,this.target.x-this.origin.x),n=this.origin.distanceTo(this.target),i=this.target.add(this.origin).scale(.5),o=new Transform(i,V(n,2*IO_PORT_LINE_WIDTH),e,this.parent.context.getCamera());return o.setParent(this.parent.transform),rectContains(o,t)}},{key:"draw",value:function(){this.set||this.getArray().length===this.prevParentLength||this.updatePosition();var t=this.origin,e=this.target,n=this.parent.getRenderer(),i=this.parent.getBorderColor()?this.parent.getBorderColor():this.lineColor;n.line(t.x,t.y,e.x,e.y,i,IO_PORT_LINE_WIDTH);var o=this.getCol()?this.getCol():DEFAULT_FILL_COLOR,s=this.getBorderColor()?this.getBorderColor():DEFAULT_BORDER_COLOR;n.circle(e.x,e.y,IO_PORT_RADIUS,o,s,IO_PORT_BORDER_WIDTH)}},{key:"remove",value:function(){}},{key:"setOrigin",value:function(t){this.origin.x=t.x,this.origin.y=t.y,this.set=!0,void 0!=this.parent&&this.parent.onTransformChange()}},{key:"setTarget",value:function(t){this.target.x=t.x,this.target.y=t.y,this.set=!0,void 0!=this.parent&&this.parent.onTransformChange()}},{key:"getPos",value:function(){return this.parent.transform.getMatrix().mul(this.target)}},{key:"getOPos",value:function(){return this.parent.transform.getMatrix().mul(this.origin)}},{key:"getDir",value:function(){return this.parent.transform.getMatrix().mul(this.dir).sub(this.parent.getPos()).normalize()}},{key:"setName",value:function(t){}},{key:"setPos",value:function(){}},{key:"getInputAmount",value:function(){return 1}},{key:"getMaxInputFieldCount",value:function(){return 1}},{key:"getMinInputFieldCount",value:function(){return 1}},{key:"getName",value:function(){return this.getDisplayName()}},{key:"getDisplayName",value:function(){return"ioport"}},{key:"getXMLName",value:function(){return this.getDisplayName().toLowerCase().replace(/\s+/g,"")}},{key:"copy",value:function(){var t=new this.constructor;return t.origin=this.origin.copy(),t.target=this.target.copy(),t.set=this.set,t.lineColor=this.lineColor,t}},{key:"writeTo",value:function(t){var e=createChildNode(t,this.getXMLName());createTextElement(e,"originx",this.origin.x),createTextElement(e,"originy",this.origin.y),createTextElement(e,"targetx",this.target.x),createTextElement(e,"targety",this.target.y)}},{key:"load",value:function(t){var e=getFloatValue(getChildNode(t,"originx")),n=getFloatValue(getChildNode(t,"originy")),i=getFloatValue(getChildNode(t,"targetx")),o=getFloatValue(getChildNode(t,"targety"));return this.setOrigin(V(e,n)),this.setTarget(V(i,o)),this}},{key:"uid",get:function(){return this.parent.uid}}]),t}(),IPort=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,V(-1,0)))}return _inherits(e,IOPort),_createClass(e,[{key:"getArray",value:function(){return this.parent.inputs}},{key:"activate",value:function(t){this.isOn!==t&&(this.isOn=t,this.parent.context.propogate(this,this.parent,this.isOn))}},{key:"remove",value:function(){void 0!=this.input&&this.input.disconnect(this)}},{key:"getDisplayName",value:function(){return"iport"}},{key:"input",set:function(t){void 0==t?this.connections=[]:this.connections[0]=t},get:function(){return this.connections.length>0?this.connections[0]:void 0}}]),e}(),OPort=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,V(1,0)))}return _inherits(e,IOPort),_createClass(e,[{key:"getArray",value:function(){return this.parent.outputs}},{key:"activate",value:function(t){if(this.isOn!==t){this.isOn=t;for(var e=0;e<this.connections.length;e++)this.parent.context.propogate(this,this.connections[e],this.isOn)}}},{key:"remove",value:function(){for(var t=0;t<this.connections.length;t++)this.disconnect(this.connections[t])}},{key:"connect",value:function(t){return this.connections.push(t),t.input=this,t.onTransformChange(),t.activate(this.isOn),!0}},{key:"disconnect",value:function(t){for(var e=0;e<this.connections.length&&this.connections[e]!==t;e++);this.connections[e].input=void 0,this.connections.splice(e,1)}},{key:"getDisplayName",value:function(){return"oport"}}]),e}(),Wire=function(){function t(e){_classCallCheck(this,t),this.context=e,this.input=void 0,this.connection=void 0,this.curve=new BezierCurve(V(0,0),V(0,0),V(0,0),V(0,0)),this.isOn=!1,this.set=!1,this.straight=!1,this.dirty=!0,this.boundingBox=new Transform(0,0,0,e.getCamera())}return _createClass(t,[{key:"activate",value:function(t){this.isOn!==t&&(this.isOn=t,void 0!=this.connection&&this.connection.activate(t))}},{key:"split",value:function(e){var n=this.curve.getPos(e),i=new t(this.context),o=this.connection;this.disconnect();var s=new WirePort(this.context);this.connect(s),i.connect(o),s.connect(i),this.connection.setPos(n),getCurrentContext().addObject(s),getCurrentContext().addWire(i)}},{key:"updateBoundingBox",value:function(){if(this.dirty){this.dirty=!1;var t=this.getPos(0),e=this.getPos(1),n=V(Math.min(t.x,e.x),Math.min(t.y,e.y)),i=V(Math.max(t.x,e.x),Math.max(t.y,e.y));this.boundingBox.setSize(V(i.x-n.x+2,i.y-n.y+2)),this.boundingBox.setPos(V((i.x-n.x)/2+n.x,(i.y-n.y)/2+n.y))}}},{key:"onTransformChange",value:function(){if(void 0!=this.input){t=this.input.getPos();if(this.set)this.curve.c1.x+=t.x-this.curve.p1.x,this.curve.c1.y+=t.y-this.curve.p1.y;else{n=(e=this.input instanceof WirePort?this.input.getODir():this.input.getDir()).scale(DEFAULT_SIZE).add(t);this.curve.c1.x=n.x,this.curve.c1.y=n.y}this.curve.p1.x=t.x,this.curve.p1.y=t.y,this.curve.dirty=!0,this.dirty=!0}if(void 0!=this.connection){var t=this.connection.getPos();if(this.set)this.curve.c2.x+=t.x-this.curve.p2.x,this.curve.c2.y+=t.y-this.curve.p2.y;else{var e=this.connection.getDir(),n=e.scale(DEFAULT_SIZE).add(t);this.curve.c2.x=n.x,this.curve.c2.y=n.y}this.curve.p2.x=t.x,this.curve.p2.y=t.y,this.curve.dirty=!0,this.dirty=!0}}},{key:"connect",value:function(t){return void 0==this.connection&&void 0==t.input&&(this.connection=t,t.input=this,this.onTransformChange(),t.activate(this.isOn),!0)}},{key:"disconnect",value:function(){if(void 0==this.connection)return!1;this.connection.input=void 0,this.connection.activate(!1),this.connection=void 0}},{key:"draw",value:function(){var t=this.context.getRenderer(),e=this.context.getCamera(),n=this.isOn?"#3cacf2":this.selected?"#1cff3e":DEFAULT_FILL_COLOR;if(this.straight){var i=e.getScreenPos(this.curve.p1),o=e.getScreenPos(this.curve.p2);t.line(i.x,i.y,o.x,o.y,n,7/e.zoom)}else this.curve.draw(n,7/e.zoom,t)}},{key:"remove",value:function(){this.context.remove(this),void 0!=this.input&&this.input.disconnect(this),void 0!=this.connection&&this.disconnect(this.connection)}},{key:"contains",value:function(t){return-1!==this.curve.getNearestT(t.x,t.y)}},{key:"setName",value:function(t){}},{key:"setPos",value:function(){}},{key:"getPos",value:function(t){return void 0==t&&(t=.5),this.curve.getPos(t)}},{key:"getNearestT",value:function(t,e){return this.straight?_getNearestT(this.curve.p1,this.curve.p2,t,e):this.curve.getNearestT(t,e)}},{key:"getCullBox",value:function(){return this.straight?this.getBoundingBox():this.curve.getBoundingBox()}},{key:"getBoundingBox",value:function(){if(this.straight)return this.updateBoundingBox(),this.boundingBox}},{key:"getInputAmount",value:function(){return 1}},{key:"getMaxInputFieldCount",value:function(){return 1}},{key:"getMinInputFieldCount",value:function(){return 1}},{key:"getName",value:function(){return this.getDisplayName()}},{key:"getDisplayName",value:function(){return"Wire"}},{key:"copy",value:function(){var e=new t(this.context);return e.curve=this.curve.copy(),e.straight=this.straight,e}},{key:"writeTo",value:function(t,e,n){var i=createChildNode(t,"wire");createTextElement(i,"uid",this.uid);var o=createChildNode(i,"input");createTextElement(o,"uid",this.input.uid),createTextElement(o,"index",this.input.getIndex());var s=createChildNode(i,"connection");createTextElement(s,"uid",this.connection.uid),createTextElement(s,"index",this.connection.getIndex()),this.curve.writeTo(i),createTextElement(i,"straight",this.straight)}},{key:"load",value:function(t){this.context.getObjects(),this.context.getWires();var e=getIntValue(getChildNode(t,"uid"));this.uid=e;var n=getChildNode(t,"bezier");this.curve.load(n);var i=getBooleanValue(getChildNode(t,"straight"));return this.straight=i,this}},{key:"loadConnections",value:function(t,e){var n=getChildNode(t,"input"),i=getIntValue(getChildNode(n,"uid")),o=getIntValue(getChildNode(n,"index")),s=findByUID(e,i);s=s instanceof WirePort?s:s.outputs[o];var r=getChildNode(t,"connection"),a=getIntValue(getChildNode(r,"uid")),u=getIntValue(getChildNode(r,"index")),c=findByUID(e,a);console.log(a),console.log(u),console.log(c),c=c instanceof WirePort?c:c.inputs[u],s.connect(this),this.connect(c)}}]),t}(),WirePort=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,0,0,2*IO_PORT_RADIUS,2*IO_PORT_RADIUS));return n._input=void 0,n.connection=void 0,n.isOn=!1,n.selected=!1,n.hasSetTransform=!1,n}return _inherits(e,IOObject),_createClass(e,[{key:"activate",value:function(t){this.isOn!==t&&(this.isOn=t,void 0!=this.connection&&this.connection.activate(t))}},{key:"remove",value:function(){this.context.remove(this),void 0!=this.input&&this.input.disconnect(this),void 0!=this.connection&&this.disconnect(this.connection)}},{key:"setTransform",value:function(t){this.transform=t,this.setPos(t.pos)}},{key:"onTransformChange",value:function(){void 0!=this.input&&this.input.onTransformChange(),void 0!=this.connection&&this.connection.onTransformChange()}},{key:"connect",value:function(t){return void 0==this.connection&&(this.connection=t,t.input=this,t.onTransformChange(),t.activate(this.isOn),!0)}},{key:"disconnect",value:function(){void 0!=this.connection&&(this.connection.input=void 0,this.connection=void 0)}},{key:"draw",value:function(){var t=this.context.getRenderer(),e=this.context.getCamera(),n=e.getScreenPos(this.getPos());t.circle(n.x,n.y,7/e.zoom,this.selected?"#1cff3e":"#ffffff",this.selected?"#0d7f1f":"#000000",1/e.zoom)}},{key:"contains",value:function(t){return circleContains(this.transform,t)}},{key:"sContains",value:function(t){return this.contains(t)}},{key:"setPos",value:function(t){void 0!=this.input&&void 0!=this.connection&&(this.input.straight=!1,this.connection.straight=!1,t.x=snap(this.input,t.x,this.input.curve.p1.x),t.y=snap(this.input,t.y,this.input.curve.p1.y),t.x=snap(this.connection,t.x,this.connection.curve.p2.x),t.y=snap(this.connection,t.y,this.connection.curve.p2.y)),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setPos",this).call(this,t)}},{key:"getIndex",value:function(){return 0}},{key:"getDir",value:function(){return this.transform.getMatrix().mul(V(-1,0)).sub(this.transform.pos).normalize()}},{key:"getODir",value:function(){return this.transform.getMatrix().mul(V(1,0)).sub(this.transform.pos).normalize()}},{key:"getCullBox",value:function(){return this.transform}},{key:"getInputAmount",value:function(){return 1}},{key:"getName",value:function(){return this.getDisplayName()}},{key:"getDisplayName",value:function(){return"Port"}},{key:"input",set:function(t){this._input=t,this.hasSetTransform||(this.hasSetTransform=!0,this.transform=new Transform(t.curve.p2.copy(),V(15,15),0,this.context.getCamera()))},get:function(){return this._input}}]),e}();WirePort.getXMLName=function(){return"port"},Importer.types.push(WirePort);var Gate=function(t){function e(t,n,i,o,s){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,o,DEFAULT_SIZE*(void 0!=s?s.ratio:1),DEFAULT_SIZE,s,!1,512,512));return r._not=!!n,r.name=r.getDisplayName(),r.setInputAmount(2),r}return _inherits(e,IOObject),_createClass(e,[{key:"activate",value:function(t,n){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,this.not?!t:t,n)}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();if(this.localSpace(),this.not){var n=this.transform.size.x/2+5;t.circle(n,0,5,void 0==this.getCol()?"#fff":this.getCol(),this.getBorderColor(),2)}t.restore()}},{key:"getDisplayName",value:function(){return"Gate"}},{key:"copy",value:function(){var t=_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"copy",this).call(this);return t.not=this.not,t}},{key:"writeTo",value:function(t){var n=_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"writeTo",this).call(this,t);return createTextElement(n,"not",this.not),createTextElement(n,"inputcount",this.getInputAmount()),n}},{key:"load",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"load",this).call(this,t);var n=getBooleanValue(getChildNode(t,"not")),i=getIntValue(getChildNode(t,"inputcount"),1);return this.not=n,this.setInputAmount(i),this}},{key:"not",set:function(t){this._not=t,t&&(this.outputs[0].isOn=!this.isOn)},get:function(){return this._not}}]),e}(),SRFlipFlop=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,!1,n,i,void 0));return o.noChange=!0,o.setInputAmount(3),o.setOutputAmount(2),o.transform.setSize(o.transform.size.scale(1.5)),o}return _inherits(e,Gate),_createClass(e,[{key:"onTransformChange",value:function(){this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE)),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"onTransformChange",this).call(this),this.transform.setSize(V(1.5*DEFAULT_SIZE,1.5*DEFAULT_SIZE))}},{key:"activate",value:function(t){var n=this.outputs[0].isOn,i=this.inputs[0].isOn,o=this.inputs[1].isOn,s=this.inputs[2].isOn;o&&(i&&s||(i?n=!0:s&&(n=!1))),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,n,0),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,!n,1)}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace(),t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor()),t.restore()}},{key:"getDisplayName",value:function(){return"SR Flip Flop"}}]),e}();SRFlipFlop.getXMLName=function(){return"srff"},Importer.types.push(SRFlipFlop);var Button=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,DEFAULT_SIZE,DEFAULT_SIZE,images["buttonUp.svg"],!0,0,1,60,60))}return _inherits(e,IOObject),_createClass(e,[{key:"press",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,!0),this.img=images["buttonDown.svg"]}},{key:"release",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,!1),this.img=images["buttonUp.svg"]}},{key:"contains",value:function(t){return circleContains(this.transform,t)}},{key:"getDisplayName",value:function(){return"Button"}}]),e}();Button.getXMLName=function(){return"button"},Importer.types.push(Button);var Clock=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,60,60/images["clock.svg"].ratio,images["clock.svg"],!1,0,1));return o.frequency=1e3,setTimeout(function(){return o.tick()},o.frequency),o}return _inherits(e,IOObject),_createClass(e,[{key:"tick",value:function(){var t=this;this.activate(!this.isOn),setTimeout(function(){return t.tick()},this.frequency)}},{key:"activate",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,t),this.img=t?images["clockOn.svg"]:images["clock.svg"],render()}},{key:"getDisplayName",value:function(){return"Clock"}}]),e}();Clock.getXMLName=function(){return"clock"},Importer.types.push(Clock);var ConstantHigh=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,DEFAULT_SIZE,DEFAULT_SIZE,images["constHigh.svg"],!1,0,1));return _get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",o).call(o,!0),o}return _inherits(e,IOObject),_createClass(e,[{key:"getDisplayName",value:function(){return"Constant High"}}]),e}();ConstantHigh.getXMLName=function(){return"consthigh"},Importer.types.push(ConstantHigh);var ConstantLow=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,DEFAULT_SIZE,DEFAULT_SIZE,images["constLow.svg"],!1,0,1));return _get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",o).call(o,!1),o}return _inherits(e,IOObject),_createClass(e,[{key:"getDisplayName",value:function(){return"Constant Low"}}]),e}();ConstantLow.getXMLName=function(){return"constlow"},Importer.types.push(ConstantLow);var Keyboard=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,3.5*DEFAULT_SIZE,3.5*DEFAULT_SIZE/images["keyboard.svg"].ratio,images["keyboard.svg"],!1,0,7));o.setOutputAmount(7);for(var s=0;s<7;s++){var r=o.outputs[s],a=-DEFAULT_SIZE/2*(s-3.5+.5);0===s&&(a-=1),6===s&&(a+=1),r.setOrigin(V(a,0)),r.setTarget(V(a,-IO_PORT_LENGTH-(o.transform.size.y-DEFAULT_SIZE)/2)),r.dir=V(0,-1)}return o}return _inherits(e,IOObject),_createClass(e,[{key:"onKeyDown",value:function(t){if(void 0!=(t=e.codeMap[t])){this.activate(!0,this.outputs.length-1);for(var n=this.outputs.length-2;n>=0;n--){var i=1<<n;i>t?this.outputs[n].activate(!1):(this.outputs[n].activate(!0),t-=i)}}}},{key:"onKeyUp",value:function(t){if(void 0!=(t=e.codeMap[t])){this.activate(!1,this.outputs.length-1);for(var n=this.outputs.length-2;n>=0;n--)this.outputs[n].activate(!1)}}},{key:"getDisplayName",value:function(){return"Keyboard"}}]),e}();Keyboard.getXMLName=function(){return"keyboard"},Importer.types.push(Keyboard),Keyboard.codeMap=[],Keyboard.codeCount=0,Keyboard.addKey=function(t){Keyboard.codeMap[t]=++Keyboard.codeCount};for(code=48;code<=57;code++)Keyboard.addKey(code);for(var code=65;code<=90;code++)Keyboard.addKey(code);Keyboard.addKey(32),Keyboard.addKey(13),Keyboard.addKey(8),Keyboard.addKey(9),Keyboard.addKey(16),Keyboard.addKey(17),Keyboard.addKey(18),Keyboard.addKey(91),Keyboard.addKey(20),Keyboard.addKey(27),Keyboard.addKey(192),Keyboard.addKey(189),Keyboard.addKey(187),Keyboard.addKey(219),Keyboard.addKey(221),Keyboard.addKey(220),Keyboard.addKey(186),Keyboard.addKey(222),Keyboard.addKey(188),Keyboard.addKey(190),Keyboard.addKey(191),Keyboard.addKey(37),Keyboard.addKey(38),Keyboard.addKey(39),Keyboard.addKey(40),Keyboard.addKey(112),Keyboard.addKey(112),console.log(Keyboard.codeCount);var Switch=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,60*images["switchUp.svg"].ratio,60,images["switchUp.svg"],!0,0,1,77*images["switchUp.svg"].ratio,77))}return _inherits(e,IOObject),_createClass(e,[{key:"activate",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,t),this.img=images[this.isOn?"switchDown.svg":"switchUp.svg"]}},{key:"click",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"click",this).call(this),this.activate(!this.isOn)}},{key:"getDisplayName",value:function(){return"Switch"}},{key:"writeTo",value:function(t){var n=_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"writeTo",this).call(this,t);return createTextElement(n,"isOn",this.outputs[0].isOn),n}}]),e}();Switch.getXMLName=function(){return"switch"},Importer.types.push(Switch);var ANDGate=function(t){function e(t,n,i,o){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,o,images["and.svg"]))}return _inherits(e,Gate),_createClass(e,[{key:"setInputAmount",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,t);for(var n=0;n<this.inputs.length;n++){var i=this.inputs[n];i.origin=V(-(this.transform.size.x-2)/2,i.origin.y)}}},{key:"activate",value:function(t){for(var n=!0,i=0;i<this.inputs.length;i++)n=n&&this.inputs[i].isOn;_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,n)}},{key:"draw",value:function(){var t=this.context.getRenderer();this.localSpace();var n=-this.transform.size.y/2*(.5-this.inputs.length/2),i=-this.transform.size.y/2*(this.inputs.length/2-.5),o=(this.transform.size.x-2)/2,s=V(-o,n),r=V(-o,i);t.line(s.x,s.y,r.x,r.y,this.getBorderColor(),2),t.restore(),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this)}},{key:"getDisplayName",value:function(){return this.not?"NAND Gate":"AND Gate"}}]),e}();ANDGate.getXMLName=function(){return"andgate"},Importer.types.push(ANDGate);var BUFGate=function(t){function e(t,n,i,o){_classCallCheck(this,e);var s=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,o,images["buffer.svg"]));return s.maxInputs=1,s.setInputAmount(1),s.activate(!1),s}return _inherits(e,Gate),_createClass(e,[{key:"activate",value:function(t){for(var n=!1,i=0;i<this.inputs.length;i++)n=this.inputs[i].isOn;_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,n)}},{key:"getDisplayName",value:function(){return this.not?"NOT Gate":"Buffer Gate"}}]),e}();BUFGate.getXMLName=function(){return"bufgate"},Importer.types.push(BUFGate);var ORGate=function(t){function e(t,n,i,o){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,o,images["or.svg"]))}return _inherits(e,Gate),_createClass(e,[{key:"quadCurveXAt",value:function(t){var e=this.transform.size.x/2-2,n=1-t;return n*n*-e+2*t*n*-(this.transform.size.x/5-2)+t*t*-e}},{key:"setInputAmount",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,t);for(var n=0;n<this.inputs.length;n++){var i=this.inputs[n],o=(i.origin.y/this.transform.size.y+.5)%1;o<0&&(o+=1);var s=this.quadCurveXAt(o);i.origin=V(s,i.origin.y)}}},{key:"activate",value:function(t){for(var n=!1,i=0;i<this.inputs.length;i++)n=n||this.inputs[i].isOn;_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,n)}},{key:"draw",value:function(){var t=this.context.getRenderer();this.localSpace();for(var n=2*Math.floor(this.inputs.length/4)+1,i=0;i<n;i++){var o=(i-Math.floor(n/2))*this.transform.size.y,s=-this.transform.size.y/2,r=+this.transform.size.y/2,a=this.transform.size.x/2-2,u=this.transform.size.x/5-2,c=V(-a,s+o),h=V(-a,r+o),l=V(-u,o);t.quadCurve(c.x,c.y,h.x,h.y,l.x,l.y,this.getBorderColor(),2)}t.restore(),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this)}},{key:"getDisplayName",value:function(){return this.not?"NOR Gate":"OR Gate"}}]),e}();ORGate.getXMLName=function(){return"orgate"},Importer.types.push(ORGate);var XORGate=function(t){function e(t,n,i,o){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,o,images["or.svg"]))}return _inherits(e,Gate),_createClass(e,[{key:"quadCurveXAt",value:function(t){var e=this.transform.size.x/2-2,n=1-t;return n*n*-e+2*t*n*-(this.transform.size.x/5-2)+t*t*-e}},{key:"setInputAmount",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,t);for(var n=0;n<this.inputs.length;n++){var i=this.inputs[n],o=(i.origin.y/this.transform.size.y+.5)%1;o<0&&(o+=1);var s=this.quadCurveXAt(o);i.origin=V(s,i.origin.y)}}},{key:"activate",value:function(t){for(var n=!1,i=0;i<this.inputs.length;i++)n=n!==this.inputs[i].isOn;_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,n)}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace();for(var n=2*Math.floor(this.inputs.length/4)+1,i=0;i<n;i++){var o=(i-Math.floor(n/2))*this.transform.size.y,s=-this.transform.size.y/2,r=+this.transform.size.y/2,a=this.transform.size.x/2-2,u=this.transform.size.x/5-2,c=V(-a,s+o),h=V(-a,r+o),l=V(-u,o);t.quadCurve(c.x,c.y,h.x,h.y,l.x,l.y,this.getBorderColor(),2),t.quadCurve(c.x-12,c.y,h.x-12,h.y,l.x-12,l.y,this.getBorderColor(),2)}t.restore()}},{key:"getDisplayName",value:function(){return this.not?"XNOR Gate":"XOR Gate"}},{key:"getXMLName",value:function(){return"xorgate"}}]),e}();XORGate.getXMLName=function(){return"xorgate"},Importer.types.push(XORGate);var Decoder=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,!1,n,i,void 0))}return _inherits(e,Gate),_createClass(e,[{key:"onTransformChange",value:function(){this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE)),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"onTransformChange",this).call(this),this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE/2*(2<<this.inputs.length-1)))}},{key:"setInputAmount",value:function(t){t=clamp(t,0,8),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,t),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setOutputAmount",this).call(this,2<<t-1)}},{key:"getInputAmount",value:function(){return this.inputs.length}},{key:"activate",value:function(t){for(var e=0,n=0;n<this.inputs.length;n++)e|=(this.inputs[n].isOn?1:0)<<n;for(n=0;n<this.outputs.length;n++)this.outputs[n].activate(n===e,n)}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace(),t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor()),t.restore()}},{key:"getMinInputFieldCount",value:function(){return 1}},{key:"getDisplayName",value:function(){return"Decoder"}}]),e}();Decoder.getXMLName=function(){return"decoder"},Importer.types.push(Decoder);var Demultiplexer=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,!1,n,i,void 0))}return _inherits(e,Gate),_createClass(e,[{key:"setInputAmount",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,t+1),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setOutputAmount",this).call(this,2<<t-1);var n=Math.max(DEFAULT_SIZE/2*(t-1),DEFAULT_SIZE),i=DEFAULT_SIZE/2*(2<<t-1);this.transform.setSize(V(n+10,i)),this.selectLines=[];for(o=0;o<t;o++){a=this.inputs[o];this.selectLines.push(a);r=-DEFAULT_SIZE/2*(o-t/2+.5);0===o&&(r-=1),o===t-1&&(r+=1),a.setOrigin(V(r,0)),a.setTarget(V(r,IO_PORT_LENGTH+i/2-DEFAULT_SIZE/2))}for(var o=0;o<this.outputs.length;o++){var s=this.outputs[o],r=-DEFAULT_SIZE/2*(o-this.outputs.length/2+.5);0===o&&(r-=1),o===this.outputs.length-1&&(r+=1),s.setOrigin(V(0,r)),s.setTarget(V(IO_PORT_LENGTH+(n/2-DEFAULT_SIZE/2),r))}var a;(a=this.inputs[this.inputs.length-1]).setOrigin(V(0,0)),a.setTarget(V(-IO_PORT_LENGTH-(n/2-DEFAULT_SIZE/2),0))}},{key:"getInputAmount",value:function(){return this.selectLines.length}},{key:"activate",value:function(t){for(var n=0,i=0;i<this.selectLines.length;i++)n|=(this.selectLines[i].isOn?1:0)<<i;_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,this.inputs[this.inputs.length-1].isOn,n)}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace();var n=V(this.transform.size.x/2,this.transform.size.y/2),i=V(this.transform.size.x/2,-this.transform.size.y/2),o=V(-this.transform.size.x/2,-this.transform.size.y/2+20),s=V(-this.transform.size.x/2,this.transform.size.y/2-20);t.shape([n,i,o,s],this.getCol(),this.getBorderColor(),2),t.restore()}},{key:"getMinInputFieldCount",value:function(){return 1}},{key:"getDisplayName",value:function(){return"Demultiplexer"}}]),e}();Demultiplexer.getXMLName=function(){return"demux"},Importer.types.push(Demultiplexer);var Encoder=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,!1,n,i,void 0))}return _inherits(e,Gate),_createClass(e,[{key:"onTransformChange",value:function(){this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE)),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"onTransformChange",this).call(this),this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE/2*(2<<this.outputs.length-1)))}},{key:"setInputAmount",value:function(t){t=clamp(t,0,8),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,2<<t-1),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setOutputAmount",this).call(this,t)}},{key:"getInputAmount",value:function(){return this.outputs.length}},{key:"activate",value:function(t){for(var e=-1,n=0;n<this.inputs.length;n++)if(this.inputs[n].isOn){if(-1!==e)return;e=n}if(-1!==e)for(n=this.outputs.length-1;n>=0;n--){var i=1<<n;i>e?this.outputs[n].activate(!1):(this.outputs[n].activate(!0),e-=i)}}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace(),t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor()),t.restore()}},{key:"getMinInputFieldCount",value:function(){return 1}},{key:"getDisplayName",value:function(){return"Encoder"}}]),e}();Encoder.getXMLName=function(){return"encoder"},Importer.types.push(Encoder);var IC=function(t){function e(t,n,i,o){_classCallCheck(this,e);var s=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,o,50,50,void 0,!1,999,999));return s.data=n,s.setup(),s}return _inherits(e,IOObject),_createClass(e,[{key:"setup",value:function(){if(void 0!=this.data){this.setInputAmount(this.data.getInputAmount()),this.setOutputAmount(this.data.getOutputAmount());var t=this.data.copy();this.inputObjects=t.inputs,this.outputObjects=t.outputs,this.components=t.components;for(var e=0;e<this.outputObjects.length;e++){var n=this.outputs[e];this.outputObjects[e].activate=function(t){n.activate(t)}}this.noChange=!0,this.update()}}},{key:"update",value:function(){if(void 0!=this.data){this.transform.setWidth(this.data.getWidth()),this.transform.setHeight(this.data.getHeight());for(t=0;t<this.inputs.length;t++)this.inputs[t].setOrigin(this.data.iports[t].origin),this.inputs[t].setTarget(this.data.iports[t].target);for(var t=0;t<this.outputs.length;t++)this.outputs[t].setOrigin(this.data.oports[t].origin),this.outputs[t].setTarget(this.data.oports[t].target);this.activate()}}},{key:"activate",value:function(){for(var t=0;t<this.inputs.length;t++)this.inputObjects[t].activate(this.inputs[t].isOn)}},{key:"draw",value:function(){var t=this.context.getRenderer();_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this),this.localSpace();var n=this.transform.size;t.rect(0,0,n.x,n.y,this.getCol(),"#000000",1);for(u=0;u<this.inputs.length;u++){var i=this.inputObjects[u].getName(),o=this.transform.toLocalSpace(this.inputs[u].getPos()),s="center",r=8,a=t.getTextWidth(i)/2;(c=(c=getNearestPointOnRect(V(-n.x/2,-n.y/2),V(n.x/2,n.y/2),o)).sub(o).normalize().scale(r).add(c)).x=clamp(c.x,-n.x/2+r+a,n.x/2-r-a),c.y=clamp(c.y,-n.y/2+14,n.y/2-14),t.text(i,c.x,c.y,0,0,s)}for(var u=0;u<this.outputs.length;u++){var i=this.outputObjects[u].getName(),o=this.transform.toLocalSpace(this.outputs[u].getPos()),s="center",r=8,a=t.getTextWidth(i)/2,c=getNearestPointOnRect(V(-n.x/2,-n.y/2),V(n.x/2,n.y/2),o);(c=c.sub(o).normalize().scale(r).add(c)).x=clamp(c.x,-n.x/2+r+a,n.x/2-r-a),c.y=clamp(c.y,-n.y/2+14,n.y/2-14),t.text(i,c.x,c.y,0,0,s)}t.restore()}},{key:"getDisplayName",value:function(){return"IC"}},{key:"copy",value:function(){return new e(this.context,this.data,this.transform.pos.x,this.transform.pos.y)}},{key:"writeTo",value:function(t){var n=_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"writeTo",this).call(this,t);return createTextElement(n,"icuid",this.data.getUID()),n}},{key:"load",value:function(t,n){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"load",this).call(this,t);var i=findIC(getIntValue(getChildNode(t,"icuid")),n);return this.data=i,this.setup(),this}}]),e}();IC.getXMLName=function(){return"ic"},Importer.types.push(IC);var ICData=function(){function t(e,n,i){_classCallCheck(this,t),this.transform=new Transform(V(0,0),V(0,0),0),this.inputs=e,this.outputs=n,this.components=i,this.wires=getAllWires(this.getObjects()),this.uidmanager=new UIDManager(this);for(var o=this.getObjects(),s=0;s<o.length;s++)this.uidmanager.giveUIDTo(o[s]);for(s=0;s<this.wires.length;s++)this.uidmanager.giveUIDTo(this.wires[s]);for(var r=0,s=0;s<this.inputs.length;s++)r=Math.max(this.inputs[s].getName().length,r);for(s=0;s<this.outputs.length;s++)r=Math.max(this.outputs[s].getName().length,r);var a=DEFAULT_SIZE+20*r,u=DEFAULT_SIZE/2*Math.max(this.inputs.length,this.outputs.length);this.transform.setSize(V(a,u)),this.iports=[],this.oports=[];for(s=0;s<this.inputs.length;s++){this.iports[s]=new IPort;c=-DEFAULT_SIZE/2*(s-this.inputs.length/2+.5);0===s&&(c-=1),s===this.inputs.length-1&&(c+=1),this.iports[s].setOrigin(V(0,c)),this.iports[s].setTarget(V(-IO_PORT_LENGTH-(a/2-DEFAULT_SIZE/2),c))}for(s=0;s<this.outputs.length;s++){this.oports[s]=new OPort;var c=-DEFAULT_SIZE/2*(s-this.outputs.length/2+.5);0===s&&(c-=1),s===this.outputs.length-1&&(c+=1),this.oports[s].setOrigin(V(0,c)),this.oports[s].setTarget(V(IO_PORT_LENGTH+(a/2-DEFAULT_SIZE/2),c))}this.recalculatePorts()}return _createClass(t,[{key:"recalculatePorts",value:function(){for(var t=this.transform.size,e=this.iports,n=0;n<e.length;n++){var i=e[n],o=this.transform.getMatrix().mul(i.target),s=this.transform.getMatrix().mul(i.origin),r=o.add(o.sub(s).normalize().scale(1e4)),a=(l=getNearestPointOnRect(V(-t.x/2,-t.y/2),V(t.x/2,t.y/2),r)).sub(r).normalize().scale(t.scale(.5)).add(l),u=l.sub(r).normalize().scale(t.scale(.5).sub(V(IO_PORT_LENGTH+t.x/2-25,IO_PORT_LENGTH+t.y/2-25))).add(l);i.setOrigin(a),i.setTarget(u)}for(var c=this.oports,n=0;n<c.length;n++){var h=c[n],o=this.transform.getMatrix().mul(h.target),s=this.transform.getMatrix().mul(h.origin),r=o.add(o.sub(s).normalize().scale(1e4)),l=getNearestPointOnRect(V(-t.x/2,-t.y/2),V(t.x/2,t.y/2),r),a=l.sub(r).normalize().scale(t.scale(.5)).add(l),u=l.sub(r).normalize().scale(t.scale(.5).sub(V(IO_PORT_LENGTH+t.x/2-25,IO_PORT_LENGTH+t.y/2-25))).add(l);h.setOrigin(a),h.setTarget(u)}}},{key:"getInputAmount",value:function(){return this.inputs.length}},{key:"getOutputAmount",value:function(){return this.outputs.length}},{key:"copy",value:function(){return separateGroup(copyGroup(this.getObjects()).objects)}},{key:"getUID",value:function(){return this.icuid}},{key:"getObjects",value:function(){return this.inputs.concat(this.components,this.outputs)}},{key:"getWires",value:function(){return this.wires}},{key:"getWidth",value:function(){return this.transform.getSize().x}},{key:"getHeight",value:function(){return this.transform.getSize().y}}]),t}();ICData.create=function(t){for(var e=separateGroup(t=copyGroup(t).objects),n=0;n<e.inputs.length;n++){var i=e.inputs[n];i instanceof Clock&&i.getName()===i.getDisplayName()&&i.setName(">")}return new ICData(e.inputs,e.outputs,e.components)},ICData.add=function(t){t.icuid=ICData.ICs.length,ICData.ICs.push(t)},ICData.redistributeUIDs=function(){for(var t=[],e=0;e<ICData.ICs.length;e++)t[e]=ICData.ICs[e];ICData.ICs=[];for(e=0;e<t.length;e++)t[e].icuid=e,ICData.ICs[e]=t[e]},ICData.ICs=[];var Label=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,0,0,void 0,!0,0,0,60,30));return o.setName("LABEL"),o.setInputAmount(0),o.setOutputAmount(0),o}return _inherits(e,IOObject),_createClass(e,[{key:"activate",value:function(t){}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace();t.getTextWidth(this.text);var n=V(0,0);t.text(this.name,n.x,n.y,0,0,"center"),t.restore()}},{key:"setName",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setName",this).call(this,t);var n=this.context.getRenderer().getTextWidth(this.name)+20;this.selectionBoxTransform.setSize(V(n,this.selectionBoxTransform.size.y)),this.onTransformChange(),render()}},{key:"getDisplayName",value:function(){return this.name}}]),e}();Label.getXMLName=function(){return"label"},Importer.types.push(Label);var Multiplexer=function(t){function e(t,n,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,!1,n,i,void 0))}return _inherits(e,Gate),_createClass(e,[{key:"setInputAmount",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setInputAmount",this).call(this,t+(2<<t-1));var n=Math.max(DEFAULT_SIZE/2*(t-1),DEFAULT_SIZE),i=DEFAULT_SIZE/2*(2<<t-1);this.transform.setSize(V(n+10,i)),this.selectLines=[];for(s=0;s<t;s++){r=this.inputs[s];this.selectLines.push(r);a=-DEFAULT_SIZE/2*(s-t/2+.5);0===s&&(a-=1),s===t-1&&(a+=1),r.setOrigin(V(a,0)),r.setTarget(V(a,IO_PORT_LENGTH+i/2-DEFAULT_SIZE/2))}for(var o=t;o<this.inputs.length;o++){var s,r=this.inputs[o],a=-DEFAULT_SIZE/2*((s=o-t)-(this.inputs.length-t)/2+.5);0===s&&(a-=1),s===this.inputs.length-t-1&&(a+=1),r.setOrigin(V(0,a)),r.setTarget(V(-IO_PORT_LENGTH-(n/2-DEFAULT_SIZE/2),a))}var u=this.outputs[0];u.target=V(IO_PORT_LENGTH+(n/2-DEFAULT_SIZE/2),u.target.y)}},{key:"getInputAmount",value:function(){return this.selectLines.length}},{key:"activate",value:function(t){for(var n=0,i=0;i<this.selectLines.length;i++)n|=(this.selectLines[i].isOn?1:0)<<i;_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,this.inputs[n+this.selectLines.length].isOn)}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace();var n=V(-this.transform.size.x/2,this.transform.size.y/2),i=V(-this.transform.size.x/2,-this.transform.size.y/2),o=V(this.transform.size.x/2,-this.transform.size.y/2+20),s=V(this.transform.size.x/2,this.transform.size.y/2-20);t.shape([n,i,o,s],this.getCol(),this.getBorderColor(),2),t.restore()}},{key:"getMinInputFieldCount",value:function(){return 1}},{key:"getDisplayName",value:function(){return"Multiplexer"}},{key:"getXMLName",value:function(){return"mux"}}]),e}();Multiplexer.getXMLName=function(){return"mux"},Importer.types.push(Multiplexer);var SevenSegmentDisplay=function(t){function e(t,n,i){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,70,100,void 0,!1,7,0));o.setInputAmount(7),o.noChange=!0,o.segmentWidth=45,o.segmentHeight=10;for(var s=0;s<7;s++){var r=o.inputs[s],a=-15*(r.getIndex()-r.getArray().length/2+.5);r.setOrigin(V(r.origin.x,a)),r.setTarget(V(r.target.x,a))}o.transform.size.x,o.transform.size.y;var u=o.segmentWidth,c=o.segmentHeight;return o.segmentPositions=[V(0,-u+c),V(u/2-c/2,(-u+c)/2),V(u/2-c/2,(+u-c)/2),V(0,u-c),V(-u/2+c/2,(+u-c)/2),V(-u/2+c/2,(-u+c)/2),V(0,0)],o.segmentSizes=[V(u,c),V(c,u),V(c,u),V(u,c),V(c,u),V(c,u),V(u,c)],o.segmentImages=[images["segment1.svg"],images["segment2.svg"],images["segment2.svg"],images["segment1.svg"],images["segment2.svg"],images["segment2.svg"],images["segment1.svg"]],o.segmentOnImages=[images["segment3.svg"],images["segment4.svg"],images["segment4.svg"],images["segment3.svg"],images["segment4.svg"],images["segment4.svg"],images["segment3.svg"]],o}return _inherits(e,IOObject),_createClass(e,[{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this),this.localSpace();var t=this.context.getRenderer();t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor());for(var n=0;n<7;n++){var i=this.segmentPositions[n],o=this.segmentSizes[n],s=this.inputs[n].isOn?this.segmentOnImages[n]:this.segmentImages[n];t.image(s,i.x,i.y,o.x,o.y,void 0)}t.restore()}},{key:"getDisplayName",value:function(){return"7 Segment Display"}},{key:"getXMLName",value:function(){return"sevensegmentdisplay"}}]),e}();SevenSegmentDisplay.getXMLName=function(){return"sevensegmentdisplay"},Importer.types.push(SevenSegmentDisplay);var LED=function(t){function e(t,n,i,o){_classCallCheck(this,e);var s=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,i,DEFAULT_SIZE,DEFAULT_SIZE,images["led.svg"],!1,1,0));return s.transform.setPos(V(s.transform.pos.x,s.transform.pos.y-2*s.transform.size.y)),s.color=void 0==o?"#ffffff":o,s.connectorWidth=5,s.setInputAmount(1),s.inputs[0].setOrigin(V(0,0)),s.inputs[0].setTarget(V(0,2*s.transform.size.y)),s.inputs[0].lineColor="#ffffff",s.inputs[0].dir=V(0,1),s}return _inherits(e,IOObject),_createClass(e,[{key:"updateCullTransform",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateCullTransform",this).call(this),this.isOn&&(this.cullTransform.setSize(V(3*this.transform.size.x,4*this.transform.size.y)),this.cullTransform.setPos(this.transform.pos.add(V(0,(this.inputs[0].target.y-3*this.transform.size.y/2)/2))))}},{key:"activate",value:function(t,n){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"activate",this).call(this,t,n),this.updateCullTransform()}},{key:"getImageTint",value:function(){return this.color}},{key:"draw",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"draw",this).call(this);var t=this.context.getRenderer();this.localSpace(),this.isOn&&t.image(images["ledLight.svg"],0,0,3*this.transform.size.x,3*this.transform.size.y,this.color),t.restore()}},{key:"getDisplayName",value:function(){return"LED"}},{key:"copy",value:function(){var t=_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"copy",this).call(this);return t.color=this.color,t.connectorWidth=this.connectorWidth,t}},{key:"writeTo",value:function(t){var n=_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"writeTo",this).call(this,t);return createTextElement(n,"color",this.color),n}},{key:"load",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"load",this).call(this,t);var n=getStringValue(getChildNode(t,"color"));return this.color=n,this}}]),e}();LED.getXMLName=function(){return"led"},Importer.types.push(LED);var popup,contextmenu,icdesigner,context,currentContext,CircuitDesigner=function(){function t(e,n,i){var o=this;_classCallCheck(this,t),this.renderer=new Renderer(this,e,n,i),this.camera=new Camera(this),this.history=new HistoryManager,this.wires=[],this.objects=[],this.propogationQueue=[],window.addEventListener("resize",function(t){return o.resize()},!1),this.resize()}return _createClass(t,[{key:"reset",value:function(){for(t=0;t<this.objects.length;t++)this.objects[t].remove();for(var t=0;t<this.wires.length;t++)this.wires[t].remove();this.objects=[],this.wires=[],this.propogationQueue=[]}},{key:"propogate",value:function(t,e,n){var i=this;this.propogationQueue.push(new Propogation(t,e,n,function(){return i.update(t,e)}))}},{key:"update",value:function(t,e){for(var n=this,i=[];this.propogationQueue.length>0;)i.push(this.propogationQueue.pop());for(;i.length>0;)i.pop().send();this.propogationQueue.length>0&&updateRequests++,updateRequests--,console.log("update");var o=!1;if(t instanceof Wire||e instanceof Wire){for(var s=0;s<this.wires.length;s++)if(this.wires[s]===t||this.wires[s]===e){o=!0;break}}else render();o&&render(),updateRequests>0&&setTimeout(function(){return n.update(t,e)},PROPOGATION_TIME)}},{key:"render",value:function(){this.renderer.clear();var t=GRID_SIZE/this.camera.zoom,e=V(this.camera.pos.x/this.camera.zoom-this.renderer.canvas.width/2,this.camera.pos.y/this.camera.zoom-this.renderer.canvas.height/2),n=e.x-Math.floor(e.x/t)*t;n<0&&(n+=t);var i=e.y-Math.floor(e.y/t)*t;i<0&&(i+=t),this.renderer.save(),this.renderer.setStyles(void 0,"#999",1/this.camera.zoom),this.renderer.context.beginPath();for(var o=-n;o<=this.renderer.canvas.width-n+t;o+=t)this.renderer._line(o,0,o,this.renderer.canvas.height);for(var s=-i;s<=this.renderer.canvas.height-i+t;s+=t)this.renderer._line(0,s,this.renderer.canvas.width,s);this.renderer.context.closePath(),this.renderer.context.stroke(),this.renderer.restore();for(r=0;r<this.wires.length;r++)this.camera.cull(this.wires[r].getCullBox())&&this.wires[r].draw();for(var r=0;r<this.objects.length;r++)this.camera.cull(this.objects[r].getCullBox())&&this.objects[r].draw();CurrentTool.draw(this.renderer)}},{key:"resize",value:function(){this.renderer.resize(),this.camera.resize(),render()}},{key:"addObject",value:function(t){-1===this.getIndexOfObject(t)?this.objects.push(t):console.error("Attempted to add an object that already existed!")}},{key:"addWire",value:function(t){-1===this.getIndexOfWire(t)?this.wires.push(t):console.error("Attempted to add a wire that already existed!")}},{key:"getRenderer",value:function(){return this.renderer}},{key:"getObjects",value:function(){return this.objects}},{key:"getWires",value:function(){return this.wires}},{key:"getIndexOfObject",value:function(t){for(var e=0;e<this.objects.length;e++)if(t===this.objects[e])return e;return-1}},{key:"getIndexOfWire",value:function(t){for(var e=0;e<this.wires.length;e++)if(t===this.wires[e])return e;return-1}}]),t}(),ICDesigner=function(){function t(){_classCallCheck(this,t),this.canvas=document.getElementById("designer-canvas"),this.designer=new CircuitDesigner(this.canvas,.84,.76),this.context=new Context(this.designer),this.ic=void 0,this.data=void 0,this.drag=!1,this.dragObj=void 0,this.dragEdge=void 0,this.disabled=!0,this.confirmButton=document.getElementById("ic-confirmbutton"),this.cancelButton=document.getElementById("ic-cancelbutton"),this.hide()}return _createClass(t,[{key:"confirm",value:function(){if(void 0!=this.ic){ICData.add(this.data);var t=this.ic.copy();t.setContext(context),context.getDesigner().addObject(t),this.hide()}}},{key:"cancel",value:function(){void 0!=this.ic&&this.hide()}},{key:"show",value:function(t){currentContext=this.context,this.disabled=!1,TransformController.disabled=!0,WireController.disabled=!0,SelectionBox.disabled=!0,this.hidden=!1,this.canvas.style.visibility="visible",this.confirmButton.style.visibility="visible",this.cancelButton.style.visibility="visible",ItemNavController.isOpen&&ItemNavController.toggle(),popup.hide(),this.data=ICData.create(t),this.ic=new IC(this.context,this.data,0,0),this.designer.addObject(this.ic),selectionTool.deselectAll(),this.context.getCamera().zoom=.5+.1*(this.ic.transform.size.x-50)/20,render()}},{key:"hide",value:function(){currentContext=context,this.disabled=!0,TransformController.disabled=!1,WireController.disabled=!1,SelectionBox.disabled=!1,this.hidden=!0,this.canvas.style.visibility="hidden",this.confirmButton.style.visibility="hidden",this.cancelButton.style.visibility="hidden",void 0!=this.ic&&(this.ic.remove(),this.ic=void 0,this.data=void 0),render()}},{key:"onMouseDown",value:function(){if(void 0==this.ic)return!1;for(var t=Input.getWorldMousePos(),e=this.ic.inputs,n=0;n<e.length;n++){if(e[n].sContains(t))return this.drag=!0,this.dragObj=this.data.iports[n],!0}for(var i=this.ic.outputs,n=0;n<i.length;n++){if(i[n].sContains(t))return this.drag=!0,this.dragObj=this.data.oports[n],!0}var o=this.ic.getPos(),s=this.ic.getSize(),r=new Transform(o,s.scale(1.2),0,this.context.getCamera()),a=new Transform(o,s.scale(.8),0,this.context.getCamera());return rectContains(r,t)&&!rectContains(a,t)?(t.y<o.y+s.y/2-4&&t.y>o.y-s.y/2+4?this.dragEdge="horizontal":this.dragEdge="vertical",!0):void 0}},{key:"onMouseUp",value:function(){if(void 0==this.ic)return!1;this.drag=!1,this.dragObj=void 0,this.dragEdge=void 0}},{key:"onMouseMove",value:function(){if(void 0==this.ic)return!1;var t=Input.getWorldMousePos();if(this.drag){var e=this.ic.getSize(),n=getNearestPointOnRect(V(-e.x/2,-e.y/2),V(e.x/2,e.y/2),t),i=n.sub(t).normalize().scale(e.scale(.5)).add(n),o=n.sub(t).normalize().scale(e.scale(.5).sub(V(IO_PORT_LENGTH+e.x/2-25,IO_PORT_LENGTH+e.y/2-25))).add(n);return this.dragObj.setOrigin(i),this.dragObj.setTarget(o),this.ic.update(),!0}return void 0!=this.dragEdge?("horizontal"===this.dragEdge?this.data.transform.setWidth(Math.abs(2*t.x)):this.data.transform.setHeight(Math.abs(2*t.y)),this.data.recalculatePorts(),this.ic.update(),!0):void 0}},{key:"onClick",value:function(){}}]),t}(),images=[],browser=getBrowser(),saved=!0;window.onbeforeunload=function(t){if(!saved){return t.returnValue="You have unsaved changes.","You have unsaved changes."}};var renderQueue=0,Renderer=function(){function t(e,n,i,o){_classCallCheck(this,t),this.parent=e,this.canvas=n,this.tintCanvas=document.createElement("canvas"),this.vw=void 0==i?1:i,this.vh=void 0==o?1:o,this.context=this.canvas.getContext("2d"),this.tintCanvas.width=100,this.tintCanvas.height=100,this.tintContext=this.tintCanvas.getContext("2d")}return _createClass(t,[{key:"getCamera",value:function(){return this.parent.camera}},{key:"setCursor",value:function(t){this.canvas.style.cursor=t}},{key:"resize",value:function(){this.canvas.width=window.innerWidth*this.vw,this.canvas.height=window.innerHeight*this.vh}},{key:"clear",value:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"save",value:function(){this.context.save()}},{key:"restore",value:function(){this.context.restore()}},{key:"translate",value:function(t){this.context.translate(t.x,t.y)}},{key:"scale",value:function(t){this.context.scale(t.x,t.y)}},{key:"rotate",value:function(t){this.context.rotate(t)}},{key:"rect",value:function(t,e,n,i,o,s,r,a){this.save(),this.setStyles(o,s,r,a),this.context.beginPath(),this.context.rect(t-n/2,e-i/2,n,i),this.context.fill(),(r>0||void 0==r)&&this.context.stroke(),this.context.closePath(),this.restore()}},{key:"circle",value:function(t,e,n,i,o,s,r){this.save(),this.setStyles(i,o,s,r),this.context.beginPath(),this.context.arc(t,e,n,0,2*Math.PI),void 0!=i&&this.context.fill(),(s>0||void 0==s)&&this.context.stroke(),this.context.closePath(),this.restore()}},{key:"image",value:function(t,e,n,i,o,s){this.context.drawImage(t,e-i/2,n-o/2,i,o),void 0!=s&&this.tintImage(t,e,n,i,o,s)}},{key:"tintImage",value:function(t,e,n,i,o,s){this.tintContext.clearRect(0,0,this.tintCanvas.width,this.tintCanvas.height),this.tintContext.fillStyle=s,this.tintContext.fillRect(0,0,this.tintCanvas.width,this.tintCanvas.height),"Firefox"!==browser.name?this.tintContext.globalCompositeOperation="destination-atop":this.tintContext.globalCompositeOperation="source-atop",this.tintContext.drawImage(t,0,0,this.tintCanvas.width,this.tintCanvas.height),this.context.globalAlpha=.5,this.context.drawImage(this.tintCanvas,e-i/2,n-o/2,i,o),this.context.globalAlpha=1}},{key:"text",value:function(t,e,n,i,o,s){this.save(),this.context.font="lighter 15px arial",this.context.fillStyle="#000",this.context.textAlign=s,this.context.textBaseline="middle",this.context.fillText(t,e,n),this.restore()}},{key:"getTextWidth",value:function(t){var e=0;return this.save(),this.context.font="lighter 15px arial",this.context.fillStyle="#000",this.context.textBaseline="middle",e=this.context.measureText(t).width,this.restore(),e}},{key:"line",value:function(t,e,n,i,o,s){this.save(),this.setStyles(void 0,o,s),this.context.beginPath(),this.context.moveTo(t,e),this.context.lineTo(n,i),this.context.stroke(),this.context.closePath(),this.restore()}},{key:"_line",value:function(t,e,n,i){this.context.moveTo(t,e),this.context.lineTo(n,i)}},{key:"curve",value:function(t,e,n,i,o,s,r,a,u,c){this.save(),this.setStyles(void 0,u,c),this.context.beginPath(),this.context.moveTo(t,e),this.context.bezierCurveTo(o,s,r,a,n,i),this.context.stroke(),this.context.closePath(),this.restore()}},{key:"quadCurve",value:function(t,e,n,i,o,s,r,a){this.save(),this.setStyles(void 0,r,a),this.context.beginPath(),this.context.moveTo(t,e),this.context.quadraticCurveTo(o,s,n,i),this.context.stroke(),this.context.closePath(),this.restore()}},{key:"shape",value:function(t,e,n,i){this.save(),this.setStyles(e,n,i),this.context.beginPath(),this.context.moveTo(t[0].x,t[0].y);for(var o=1;o<t.length;o++)this.context.lineTo(t[o].x,t[o].y);this.context.lineTo(t[0].x,t[0].y),this.context.fill(),this.context.closePath(),i>0&&this.context.stroke(),this.restore()}},{key:"setStyles",value:function(t,e,n,i){void 0!=i&&i!==this.context.globalAlpha&&(this.context.globalAlpha=i),void 0!=(t=void 0==t?"#ffffff":t)&&t!==this.context.fillStyle&&(this.context.fillStyle=t),void 0!=(e=void 0==e?"#000000":e)&&e!==this.context.strokeStyle&&(this.context.strokeStyle=e),void 0!=(n=void 0==n?2:n)&&n!==this.context.lineWidth&&(this.context.lineWidth=n)}}]),t}();