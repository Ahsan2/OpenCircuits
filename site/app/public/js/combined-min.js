function getCurrentContext(){return currentContext}function copyGroup(t){if(0===t.length)return[];for(var e=[],s=0;s<t.length;s++)t[s]instanceof WirePort?t.splice(s--,1):e[s]=t[s].copy();for(var i=[],s=0;s<t.length;s++)for(var r=t[s],o=0;o<r.outputs.length;o++)for(var n=r.outputs[o].connections,a=0;a<n.length;a++){for(var h=n[a];h instanceof Wire||h instanceof WirePort;)h=h.connection;if(void 0==findIPort(t,h,e))break;var c=n[a].copy();e[s].outputs[o].connect(c);for(var u=n[a];u.connection instanceof WirePort;){var l=new WirePort(r.context);c.connect(l),i.push(c),c=(u=u.connection.connection).copy(),l.connect(c),e.push(l)}var d=findIPort(t,u.connection,e);c.connect(d),i.push(c)}for(s=0;s<t.length;s++)e[s].isOn=t[s].isOn,0===t[s].inputs.length&&e[s].activate(t[s].isOn);for(s=0;s<i.length;s++)0===t[s].inputs.length&&e[s].activate(t[s].isOn);return{objects:e,wires:i}}function findIPort(t,e,s){for(var i=0;i<t.length;i++)for(var r=t[i].inputs,o=0;o<r.length;o++)if(r[o]===e)return s[i].inputs[o]}function rectContains(t,e){var s=t.size.scale(.5),i=t.size.scale(-.5),r=t.toLocalSpace(e);return r.x>i.x&&r.y>i.y&&r.x<s.x&&r.y<s.y}function circleContains(t,e){return t.toLocalSpace(e).len2()<=t.size.x*t.size.x/4}function transformContains(t,e){if(Math.abs(t.getAngle())<=1e-5&&Math.abs(e.getAngle())<=1e-5){var s=t.getPos(),i=t.getSize(),r=e.getPos(),o=e.getSize();return 2*Math.abs(s.x-r.x)<i.x+o.x&&2*Math.abs(s.y-r.y)<i.y+o.y}var n=t.getRadius()+e.getRadius(),a=t.getPos().sub(e.getPos());if(a.dot(a)>n*n)return!1;for(var h=t.getLocalCorners(),c=e.getCorners(),u=[],l=0;l<4;l++)u[l]=t.toLocalSpace(c[l]),u[l].x+=1e-4*l,u[l].y+=1e-4*l;var d=h.concat(u);m=v=d[0].x,x=f=d[4].x;for(y=1;y<4;y++)m=Math.min(d[y].x,m),v=Math.max(d[y].x,v),x=Math.min(d[y+4].x,x),f=Math.max(d[y+4].x,f);if(v<x||f<m)return!1;m=v=d[0].y,x=f=d[4].y;for(y=1;y<4;y++)m=Math.min(d[y].y,m),v=Math.max(d[y].y,v),x=Math.min(d[y+4].y,x),f=Math.max(d[y+4].y,f);if(v<x||f<m)return!1;for(var g=[u[3].sub(u[0]),u[3].sub(u[2])],l=0;l<g.length;l++){for(var p=g[l],m=void 0,v=void 0,x=void 0,f=void 0,y=0;y<4;y++){var C=d[y].dot(p);m=Math.min(C,m||1/0),v=Math.max(C,v||-1/0);var T=d[y+4].dot(p);x=Math.min(T,x||1/0),f=Math.max(T,f||-1/0)}if(v<x||f<m)return!1}return!0}function getNearestPointOnRect(t,e,s){return s.x<t.x?V(t.x,clamp(s.y,t.y,e.y)):s.x>e.x?V(e.x,clamp(s.y,t.y,e.y)):s.y<t.y?V(clamp(s.x,t.x,e.x),t.y):s.y>e.y?V(clamp(s.x,t.x,e.x),e.y):V(0,0)}function getAllThingsBetween(t){for(var e=[],s=[],i=0;i<t.length;i++)t[i]instanceof Wire||t[i]instanceof WirePort?s.push(t[i]):t[i]instanceof IOObject&&e.push(t[i]);for(var r=[],i=0;i<e.length;i++){r.push(e[i]);for(o=0;o<e[i].inputs.length;o++){for(h=e[i].inputs[o].input;void 0!=h&&!(h instanceof OPort);)void 0==findByUID(r,h.uid)&&r.push(h),h=h.input}for(var o=0;o<e[i].outputs.length;o++)for(var n=e[i].outputs[o],a=0;a<n.connections.length;a++)for(h=n.connections[a];void 0!=h&&!(h instanceof IPort);)void 0==findByUID(r,h.uid)&&r.push(h),h=h.connection}for(i=0;i<s.length;i++){r.push(s[i]);for(var h=s[i].input;void 0!=h&&!(h instanceof OPort);)void 0==findByUID(r,h.uid)&&r.push(h),h=h.input;for(h=s[i].connection;void 0!=h&&!(h instanceof IPort);)void 0==findByUID(r,h.uid)&&r.push(h),h=h.connection}return r}function getAllWires(t){for(var e=[],s=0;s<t.length;s++)for(var i=t[s],r=0;r<i.outputs.length;r++)for(var o=i.outputs[r].connections,n=0;n<o.length;n++){for(var a=o[n];a.connection instanceof WirePort;)e.push(a),a=a.connection.connection;e.push(a)}return e}function findIC(t,e){for(var s=0;s<e.length;s++)if(e[s].icuid===t)return e[s]}function findByUID(t,e){for(var s=0;s<t.length;s++)if(t[s].uid===e)return t[s]}function getNearestT(t,e,s,i){var r=e.x-t.x,o=e.y-t.y,n=(r*(s-t.x)+o*(i-t.y))/(r*r+o*o);return V(r*(n=clamp(n,0,1))+t.x,o*n+t.y).sub(V(s,i)).len2()<WIRE_DIST_THRESHOLD2?n:-1}function findRoots(t,e,s,i,r,o){var n=e;do{var a=r(n,s,i),h=o(n,s,i);if(0===h)break;n=clamp(n-=a/h,.01,.99)}while(t-- >0);return n}function separateGroup(t){for(var e=[],s=[],i=[],r=0;r<t.length;r++){var o=t[r];o instanceof Switch||o instanceof Button||o instanceof Clock?e.push(o):o instanceof LED?i.push(o):s.push(o)}return{inputs:e,components:s,outputs:i}}function clamp(t,e,s){return Math.min(Math.max(t,e),s)}function getBrowser(){if(void 0!=navigator){var t,e=navigator.userAgent,s=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(s[1])?(t=/\brv[ :]+(\d+)/g.exec(e)||[],{name:"IE",version:t[1]||""}):"Chrome"===s[1]&&null!=(t=e.match(/\bOPR|Edge\/(\d+)/))?{name:"Opera",version:t[1]}:(s=s[2]?[s[1],s[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(t=e.match(/version\/(\d+)/i))&&s.splice(1,1,t[1]),{name:s[0],version:s[1]})}}function V(t,e){return new Vector(t,e)}function saveFile(){var t=Exporter.write(getCurrentContext()),e=projectNameInput.value;"Untitled Circuit*"===e&&(e="Untitled Circuit");var s=e+".circuit",i=new Blob([t],{type:"text/plain"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(i,s),saved=!0;else{var r=document.createElement("a"),o=URL.createObjectURL(i);r.href=o,r.download=s,document.body.appendChild(r),r.click(),setTimeout(function(){document.body.removeChild(r),window.URL.revokeObjectURL(o),saved=!0},0)}}function createChildNode(t,e){var s=Exporter.ROOT.createElement(e);return t.appendChild(s),s}function createTextElement(t,e,s){var i=Exporter.ROOT.createElement(e),r=Exporter.ROOT.createTextNode(s);i.appendChild(r),t.appendChild(i)}function openFile(){var t=document.getElementById("file-input");if(confirm("Are you sure you want to overwrite your current scene?")){reset();var e=new FileReader;e.onload=function(t){Importer.load(e.result,getCurrentContext()),render()},e.readAsText(t.files[0])}}function getChildNode(t,e){for(var s=0;s<t.childNodes.length;s++)if(t.childNodes[s].nodeName===e)return t.childNodes[s]}function getChildrenByTagName(t,e){for(var s=[],i=0;i<t.childNodes.length;i++)t.childNodes[i].nodeName===e&&s.push(t.childNodes[i]);return s}function getBooleanValue(t,e){return void 0==t?e:"true"===t.childNodes[0].nodeValue}function getIntValue(t,e){return void 0==t?e:parseInt(t.childNodes[0].nodeValue)}function getFloatValue(t,e){return void 0==t?e:parseFloat(t.childNodes[0].nodeValue)}function getStringValue(t,e){return void 0==t?e:t.childNodes[0].nodeValue}function snap(t,e,s){return Math.abs(e-s)<=WIRE_SNAP_THRESHOLD?(t.straight=!0,s):e}function start(){var t=new CircuitDesigner(document.getElementById("canvas"));context=new Context(t),currentContext=context,popup=new SelectionPopup,icdesigner=new ICDesigner,contextmenu=new ContextMenu,currentTool=selectionTool,loadImage(images,["constLow.svg","constHigh.svg","buttonUp.svg","buttonDown.svg","switchUp.svg","switchDown.svg","led.svg","ledLight.svg","buffer.svg","and.svg","or.svg","xor.svg","segment1.svg","segment2.svg","segment3.svg","segment4.svg","clock.svg","clockOn.svg","keyboard.svg","base.svg"],0,onFinishLoading)}function wire(t,e){var s=new Wire(getCurrentContext(),t);t.connect(s),s.connect(e)}function reset(){UID_COUNTER=0,ICs=[],currentContext=context,context.reset()}function onFinishLoading(){render()}function render(){__TESTING__||(0===renderQueue&&requestAnimationFrame(actualRender),renderQueue++)}function actualRender(){renderQueue=0,getCurrentContext().render()}function loadImage(t,e,s,i){var r=new Image;r.onload=function(){t[e[s]]=r,r.dx=0,r.dy=0,r.ratio=r.width/r.height,s===e.length-1?i(t):loadImage(t,e,s+1,i)},r.src="img/items/"+e[s]}var __TESTING__=!1;class Camera{constructor(t,e,s){this.canvas=t.renderer.canvas,this.pos=e||V(0,0),this.zoom=s||1,this.center=V(0,0),this.transform=new Transform(V(0,0),V(0,0),0,this),this.dirty=!0}resize(){this.center=V(this.canvas.width,this.canvas.height).scale(.5)}updateMatrix(){if(this.dirty){this.dirty=!1,this.mat=new Matrix2x3,this.mat.translate(this.pos),this.mat.scale(V(this.zoom,this.zoom)),this.inv=this.mat.inverse();var t=this.getWorldPos(V(0,0)),e=this.getWorldPos(V(this.canvas.width,this.canvas.height));this.transform.setPos(e.add(t).scale(.5)),this.transform.setSize(e.sub(t))}}translate(t,e){this.dirty=!0,this.pos.x+=t,this.pos.y+=e}zoomBy(t){this.dirty=!0,this.zoom*=t}cull(t){return transformContains(t,this.getTransform())}getTransform(){return this.updateMatrix(),this.transform}getMatrix(){return this.updateMatrix(),this.mat}getInverseMatrix(){return this.updateMatrix(),this.inv}getScreenPos(t){return this.getInverseMatrix().mul(t).add(this.center)}getWorldPos(t){return this.getMatrix().mul(t.sub(this.center))}}class Clipboard{constructor(){document.addEventListener("copy",t=>{this.copy(t)},!1),document.addEventListener("cut",t=>{this.cut(t)},!1),document.addEventListener("paste",t=>{this.paste(t)},!1)}copy(t){for(var e=getAllThingsBetween(selectionTool.selections),s=[],i=[],r=0;r<e.length;r++)e[r]instanceof Wire?i.push(e[r]):s.push(e[r]);var o={getObjects:function(){return s},getWires:function(){return i}},n=Exporter.write(o);t.clipboardData.setData("text/plain",n),t.preventDefault()}cut(t){this.copy(t),selectionTool.removeSelections(),t.preventDefault()}paste(t){console.log("ASd");for(var e=Importer.load(t.clipboardData.getData("text/plain"),getCurrentContext()),s=e.objects,i=(e.wires,new GroupAction),r=0;r<s.length;r++)s[r].setPos(s[r].getPos().add(V(5,5))),i.add(new PlaceAction(s[r]));getCurrentContext().addAction(i),selectionTool.deselect(selectionTool.selections),selectionTool.select(s),render(),t.preventDefault()}}var clipboard=new Clipboard;class Context{constructor(t){this.uidmanager=new UIDManager(this),this.designer=t}reset(){this.designer.reset()}render(){this.designer.render()}propogate(t,e,s){this.designer.propogate(t,e,s)}add(t){t instanceof Wire?this.addWire(t):this.addObject(t)}addObject(t){this.designer.addObject(t),this.uidmanager.giveUIDTo(t)}addObjects(t){for(var e=0;e<t.length;e++)this.addObject(t[e])}addWire(t){this.designer.addWire(t),this.uidmanager.giveUIDTo(t)}addWires(t){for(var e=0;e<t.length;e++)this.addWire(t[e])}addAction(t){this.designer.history.add(t)}setCursor(t){this.designer.renderer.setCursor(t)}remove(t){var e=this.getIndexOf(t);-1!==e&&(t instanceof Wire?this.getWires().splice(e,1):this.getObjects().splice(e,1))}undo(){this.designer.history.undo()}redo(){this.designer.history.redo()}redistributeUIDs(){this.uidmanager.redistribute()}getDesigner(){return this.designer}getRenderer(){return this.designer.renderer}getCamera(){return this.designer.camera}getInput(){return this.designer.input}getObjects(){return this.designer.objects}getWires(){return this.designer.wires}getIndexOf(t){return t instanceof Wire?this.designer.getIndexOfWire(t):this.designer.getIndexOfObject(t)}findByUID(t){return findObjectByUID(t)||findWireByUID(t)}findObjectByUID(t){return UIDManager.find(this.getObjects(),t)}findWireByUID(t){return UIDManager.find(this.getWires(),t)}getWorldMousePos(){return this.designer.input.worldMousePos}}class HistoryManager{constructor(){this.undoStack=[],this.redoStack=[]}onKeyDown(t,e){e.modiferKeyDown&&(t===Y_KEY||t===Z_KEY&&e.shiftKeyDown?this.redo():t===Z_KEY&&this.undo())}add(t){if(!(t instanceof GroupAction&&0==t.actions.length)){if(t instanceof GroupAction&&t.actions[0]instanceof SelectAction){var e=this.undoStack[this.undoStack.length-1];if(this.undoStack.length>0&&!t.actions[0].flip&&e instanceof GroupAction&&e.actions[0]instanceof SelectAction&&e.actions[0].flip){var s=new GroupAction;return s.add(t),s.add(e),this.redoStack=[],void(this.undoStack[this.undoStack.length-1]=s)}}this.redoStack=[],this.undoStack.push(t)}}undo(){if(this.undoStack.length>0){var t=this.undoStack.pop();t.undo(),this.redoStack.push(t),popup.update(),render()}}redo(){if(this.redoStack.length>0){var t=this.redoStack.pop();t.redo(),this.undoStack.push(t),popup.update(),render()}}}var PROPOGATION_TIME=1,updateRequests=0;class Propogation{constructor(t,e,s,i){this.sender=t,this.receiver=e,this.signal=s,0===updateRequests&&(updateRequests++,setTimeout(i,PROPOGATION_TIME))}send(){this.receiver.activate(this.signal)}}class SelectionBox{constructor(){this.selBoxDownPos=void 0,this.selBoxCurPos=void 0}onMouseDown(t){var e=t.worldMousePos;t.optionKeyDown||(this.selBoxDownPos=V(e.x,e.y),popup.hide())}onMouseMove(t){t.parent.getObjects();var e=t.worldMousePos;if(void 0!=this.selBoxDownPos)return this.selBoxCurPos=V(e.x,e.y),popup.hide(),!0}onMouseUp(t){var e=t.parent.getObjects(),s=t.worldMousePos;if(void 0!=this.selBoxDownPos){this.selBoxCurPos=V(s.x,s.y);var i=this.getSelections(e);return t.shiftKeyDown||selectionTool.deselect(selectionTool.selections,!0),console.log(i),selectionTool.select(i,!0),this.selBoxDownPos=void 0,this.selBoxCurPos=void 0,!0}}getSelections(t){if(void 0!=this.selBoxDownPos){for(var e=this.selBoxDownPos,s=this.selBoxCurPos,i=new Transform(V((e.x+s.x)/2,(e.y+s.y)/2),V(Math.abs(s.x-e.x),Math.abs(s.y-e.y)),0,getCurrentContext().getCamera()),r=[],o=0;o<t.length;o++){var n=t[o];if(transformContains(void 0!=n.selectionBoxTransform?n.selectionBoxTransform:n.transform,i))r.push(n);else if(void 0!=n.inputs&&void 0!=n.outputs){for(h=0;h<n.inputs.length;h++){var a=n.inputs[h];rectContains(i,a.getPos())&&r.push(a)}for(var h=0;h<n.outputs.length;h++){var c=n.outputs[h];rectContains(i,c.getPos())&&r.push(c)}}}return r}return[]}draw(t){var e=t.getCamera();if(void 0!=this.selBoxDownPos&&void 0!=this.selBoxCurPos){var s=e.getScreenPos(this.selBoxDownPos),i=e.getScreenPos(this.selBoxCurPos),r=i.x-s.x,o=i.y-s.y;t.save(),t.context.globalAlpha=.4,t.rect(s.x+r/2,s.y+o/2,r,o,"#ffffff","#6666ff",2/e.zoom),t.restore()}}}class UIDManager{constructor(t){this.context=t,this.counter=0}giveUIDTo(t){t.uid||(t.uid=this.counter++)}redistribute(){var t=this.context.getObjects().concat(this.context.getWires());this.counter=0;for(var e=0;e<t.length;e++)t[e].uid=this.counter++}}UIDManager.find=function(t,e){for(var s=0;s<t.length;s++)if(t[s].uid===e)return t[s]};var DEFAULT_SIZE=50,GRID_SIZE=50,DEFAULT_FILL_COLOR="#ffffff",DEFAULT_BORDER_COLOR="#000000",DEFAULT_ON_COLOR="#3cacf2",IO_PORT_LENGTH=60,IO_PORT_RADIUS=7,IO_PORT_BORDER_WIDTH=1,IO_PORT_LINE_WIDTH=2,WIRE_DIST_THRESHOLD=5,WIRE_DIST_THRESHOLD2=WIRE_DIST_THRESHOLD*WIRE_DIST_THRESHOLD,WIRE_DIST_ITERATIONS=10,WIRE_NEWTON_ITERATIONS=5,WIRE_SNAP_THRESHOLD=10,ROTATION_CIRCLE_RADIUS=75,ROTATION_CIRCLE_THICKNESS=5,ROTATION_CIRCLE_THRESHOLD=5,ROTATION_CIRCLE_R1=Math.pow(ROTATION_CIRCLE_RADIUS-ROTATION_CIRCLE_THRESHOLD,2),ROTATION_CIRCLE_R2=Math.pow(ROTATION_CIRCLE_RADIUS+ROTATION_CIRCLE_THRESHOLD,2),SIDENAV_WIDTH=200,ITEMNAV_WIDTH=200,OPTION_KEY=18,SHIFT_KEY=16,DELETE_KEY=8,ENTER_KEY=13,ESC_KEY=27,A_KEY=65,C_KEY=67,V_KEY=86,X_KEY=88,Y_KEY=89,Z_KEY=90,CONTROL_KEY=17,COMMAND_KEY=91;class Action{constructor(){this.context=getCurrentContext(),saved=!1}undo(){}redo(){}}class DeleteAction extends Action{constructor(t,e,s){super(),this.obj=t,this.oldinput=e,this.oldconnection=s}undo(){this.context.add(this.obj),void 0!=this.oldinput&&this.oldinput.connect(this.obj),void 0!=this.oldconnection&&this.obj.connect(this.oldconnection)}redo(){this.obj.remove()}}class GroupAction extends Action{constructor(){super(),this.actions=[]}add(t){this.actions.push(t)}undo(){for(var t=this.actions.length-1;t>=0;t--)this.actions[t].undo()}redo(){for(var t=0;t<this.actions.length;t++)this.actions[t].redo()}}class PlaceAction extends Action{constructor(t){super(),this.obj=t}undo(){this.context.remove(this.obj)}redo(){this.context.addObject(this.obj)}}class PlaceWireAction extends Action{constructor(t){super(),this.wire=t,this.input=void 0,this.connection=void 0}undo(){void 0==this.input&&(this.input=this.wire.input),void 0==this.connection&&(this.connection=this.wire.connection);var t=this.context.getIndexOf(this.wire);this.context.getWires().splice(t,1),this.wire.disconnect(this.wire.connection),this.wire.input.disconnect(this.wire)}redo(){this.context.getWires().push(this.wire),this.wire.connect(this.connection),this.input.connect(this.wire)}}class SelectAction extends Action{constructor(t,e){super(),this.obj=t,this.flip=e}undo(){this.flip?this.reselect():this.deselect()}redo(){this.flip?this.deselect():this.reselect()}reselect(){selectionTool.select([this.obj])}deselect(){selectionTool.deselect([this.obj])}}class SplitWireAction extends Action{constructor(t){super(),this.wireport=t.connection,this.wire=t,this.newwire=this.wireport.connection,this.connection=this.newwire.connection}undo(){this.context.remove(this.wireport),this.context.remove(this.newwire),this.wire.disconnect(this.wireport),this.newwire.disconnect(this.connection),this.wire.connect(this.connection)}redo(){this.context.addObject(this.wireport),this.context.addWire(this.newwire),this.wire.disconnect(this.connection),this.wire.connect(this.wireport),this.newwire.connect(this.connection)}}class TransformAction extends Action{constructor(t,e,s){super(),this.obj=t,this.t0=e,this.t1=s}undo(){this.obj.setTransform(this.t0),this.updatePopup()}redo(){this.obj.setTransform(this.t1),this.updatePopup()}updatePopup(){this.obj.selected&&(selectionTool.recalculateMidpoint(),popup.onMove())}}class BezierCurve{constructor(t,e,s,i){this.p1=V(t.x,t.y),this.p2=V(e.x,e.y),this.c1=V(s.x,s.y),this.c2=V(i.x,i.y),this.dirty=!0,this.boundingBox=new Transform(0,0,0,getCurrentContext().getCamera())}update(t,e,s,i){this.p1.x=t.x,this.p1.y=t.y,this.p2.x=e.x,this.p2.y=e.y,this.c1.x=s.x,this.c1.y=s.y,this.c2.x=i.x,this.c2.y=i.y}updateBoundingBox(){if(this.dirty){this.dirty=!1;var t=V(0,0),e=V(0,0),s=this.getPos(0),i=this.getPos(1),r=this.c1.sub(this.c2).scale(3).add(this.p2.sub(this.p1)),o=this.p1.sub(this.c1.scale(2).add(this.c2)).scale(2),n=this.c1.sub(this.p1),a=o.y*o.y-4*r.y*n.y,h=-1!==(a=a>=0?Math.sqrt(a):-1)?clamp((-o.y+a)/(2*r.y),0,1):0,c=-1!==a?clamp((-o.y-a)/(2*r.y),0,1):0;e.y=Math.max(this.getY(h),this.getY(c),s.y,i.y),t.y=Math.min(this.getY(h),this.getY(c),s.y,i.y);var u=o.x*o.x-4*r.x*n.x;-1!==(u=u>=0?Math.sqrt(u):-1)&&clamp((-o.x+u)/(2*r.x),0,1),-1!==u&&clamp((-o.x-u)/(2*r.x),0,1);e.x=Math.max(this.getX(h),this.getX(c),s.x,i.x),t.x=Math.min(this.getX(h),this.getX(c),s.x,i.x),this.boundingBox.setSize(V(e.x-t.x,e.y-t.y)),this.boundingBox.setPos(V((e.x-t.x)/2+t.x,(e.y-t.y)/2+t.y))}}draw(t,e,s){var i=s.parent.camera,r=i.getScreenPos(this.p1),o=i.getScreenPos(this.p2),n=i.getScreenPos(this.c1),a=i.getScreenPos(this.c2);s.curve(r.x,r.y,o.x,o.y,n.x,n.y,a.x,a.y,t,e)}getX(t){var e=1-t;return this.p1.x*e*e*e+3*this.c1.x*t*e*e+3*this.c2.x*t*t*e+this.p2.x*t*t*t}getY(t){var e=1-t;return this.p1.y*e*e*e+3*this.c1.y*t*e*e+3*this.c2.y*t*t*e+this.p2.y*t*t*t}getPos(t){return V(this.getX(t),this.getY(t))}getDX(t){var e=1-t;return-3*this.p1.x*e*e+3*this.c1.x*e*(1-3*t)+3*this.c2.x*t*(2-3*t)+3*this.p2.x*t*t}getDY(t){var e=1-t;return-3*this.p1.y*e*e+3*this.c1.y*e*(1-3*t)+3*this.c2.y*t*(2-3*t)+3*this.p2.y*t*t}getVel(t){return V(this.getDX(t),this.getDY(t))}getDDX(t){return 6*((-this.p1.x+3*this.c1.x-3*this.c2.x+this.p2.x)*t+(this.p1.x-2*this.c1.x+this.c2.x))}getDDY(t){return 6*((-this.p1.y+3*this.c1.y-3*this.c2.y+this.p2.y)*t+(this.p1.y-2*this.c1.y+this.c2.y))}getDist(t,e,s){var i=this.getX(t)-e,r=this.getY(t)-s;return Math.sqrt(i*i+r*r)}getDist2(t,e,s){var i=this.getX(t)-e,r=this.getY(t)-s;return i*i+r*r}getDistDenominator(t,e,s){var i=this.getX(t)-e,r=this.getY(t)-s;return i*i+r*r}getDistDenominatorDerivative(t,e,s){return 2*(this.getX(t)-e)*this.getDX(t)+2*(this.getY(t)-s)*this.getDY(t)}getDistNumerator(t,e,s){var i=this.getX(t)-e,r=this.getY(t)-s;return this.getDX(t)*i+this.getDY(t)*r}getDistNumeratorDerivative(t,e,s){var i=this.getX(t)-e,r=this.getY(t)-s,o=this.getDX(t),n=this.getDY(t);return o*o+i*this.getDDX(t)+n*n+r*this.getDDY(t)}getNearestT(t,e){for(var s=1e20,i=-1,r=0;r<=1;r+=1/WIRE_DIST_ITERATIONS){var o=this.getDist(r,t,e);o<s&&(i=r,s=o)}var n=findRoots(WIRE_NEWTON_ITERATIONS,i,t,e,(t,e,s)=>this.getDistDenominator(t,e,s),(t,e,s)=>this.getDistDenominatorDerivative(t,e,s));if(this.getDist2(n,t,e)<WIRE_DIST_THRESHOLD2)return n;var a=findRoots(WIRE_NEWTON_ITERATIONS,i,t,e,(t,e,s)=>this.getDistNumerator(t,e,s),(t,e,s)=>this.getDistNumeratorDerivative(t,e,s));return this.getDist2(a,t,e)<WIRE_DIST_THRESHOLD2?a:-1}getBoundingBox(){return this.updateBoundingBox(),this.boundingBox}copy(){return new BezierCurve(this.p1.copy(),this.p2.copy(),this.c1.copy(),this.c2.copy())}writeTo(t){var e=createChildNode(t,"bezier");createTextElement(e,"p1x",this.p1.x),createTextElement(e,"p1y",this.p1.y),createTextElement(e,"p2x",this.p2.x),createTextElement(e,"p2y",this.p2.y),createTextElement(e,"c1x",this.c1.x),createTextElement(e,"c1y",this.c1.y),createTextElement(e,"c2x",this.c2.x),createTextElement(e,"c2y",this.c2.y)}load(t){var e=V(getFloatValue(getChildNode(t,"p1x")),getFloatValue(getChildNode(t,"p1y"))),s=V(getFloatValue(getChildNode(t,"p2x")),getFloatValue(getChildNode(t,"p2y"))),i=V(getFloatValue(getChildNode(t,"c1x")),getFloatValue(getChildNode(t,"c1y"))),r=V(getFloatValue(getChildNode(t,"c2x")),getFloatValue(getChildNode(t,"c2y")));this.update(e,s,i,r)}}class Matrix2x3{constructor(t){if(this.mat=[],this.identity(),t instanceof Matrix2x3)for(var e=0;e<6;e++)this.mat[e]=t.mat[e]}zero(){for(var t=0;t<6;t++)this.mat[t]=0;return this}identity(){return this.zero(),this.mat[0]=1,this.mat[3]=1,this}mul(t){var e=V(0,0);return e.x=this.mat[0]*t.x+this.mat[2]*t.y+this.mat[4],e.y=this.mat[1]*t.x+this.mat[3]*t.y+this.mat[5],e}mult(t){var e=new Matrix2x3;return e.mat[0]=this.mat[0]*t.mat[0]+this.mat[2]*t.mat[1],e.mat[1]=this.mat[1]*t.mat[0]+this.mat[3]*t.mat[1],e.mat[2]=this.mat[0]*t.mat[2]+this.mat[2]*t.mat[3],e.mat[3]=this.mat[1]*t.mat[2]+this.mat[3]*t.mat[3],e.mat[4]=this.mat[0]*t.mat[4]+this.mat[2]*t.mat[5]+this.mat[4],e.mat[5]=this.mat[1]*t.mat[4]+this.mat[3]*t.mat[5]+this.mat[5],e}translate(t){this.mat[4]+=this.mat[0]*t.x+this.mat[2]*t.y,this.mat[5]+=this.mat[1]*t.x+this.mat[3]*t.y}rotate(t){var e=Math.cos(t),s=Math.sin(t),i=this.mat[0]*e+this.mat[2]*s,r=this.mat[1]*e+this.mat[3]*s,o=this.mat[0]*-s+this.mat[2]*e,n=this.mat[1]*-s+this.mat[3]*e;this.mat[0]=i,this.mat[1]=r,this.mat[2]=o,this.mat[3]=n}scale(t){this.mat[0]*=t.x,this.mat[1]*=t.x,this.mat[2]*=t.y,this.mat[3]*=t.y}inverse(){var t,e=new Array(6);if(e[0]=this.mat[3],e[1]=-this.mat[1],e[2]=-this.mat[2],e[3]=this.mat[0],e[4]=this.mat[2]*this.mat[5]-this.mat[4]*this.mat[3],e[5]=this.mat[4]*this.mat[1]-this.mat[0]*this.mat[5],0!=(t=this.mat[0]*this.mat[3]-this.mat[1]*this.mat[2])){t=1/t;for(var s=new Matrix2x3,i=0;i<6;i++)s.mat[i]=e[i]*t;return s}}print(){console.log("["+this.mat[0].toFixed(3)+", "+this.mat[2].toFixed(3)+", "+this.mat[4].toFixed(3)+"]\n["+this.mat[1].toFixed(3)+", "+this.mat[3].toFixed(3)+", "+this.mat[5].toFixed(3)+"]")}}class Transform{constructor(t,e,s,i){this.parent=void 0,this.pos=V(t.x,t.y),this.size=V(e.x,e.y),this.angle=s,this.scale=V(1,1),this.corners=[],this.localCorners=[],this.camera=i,this.dirty=!0,this.dirtySize=!0,this.dirtyCorners=!0,this.updateMatrix()}updateMatrix(t){this.dirty&&(this.dirty=!1,this.matrix=new Matrix2x3,this.matrix.translate(this.pos),this.matrix.rotate(this.angle),this.matrix.scale(this.scale),void 0!=this.parent&&(this.matrix=this.parent.getMatrix().mult(this.matrix)),this.inverse=this.matrix.inverse())}updateSize(){this.dirtySize&&(this.dirtySize=!1,this.localCorners=[this.size.scale(V(-.5,.5)),this.size.scale(V(.5,.5)),this.size.scale(V(.5,-.5)),this.size.scale(V(-.5,-.5))],this.radius=Math.sqrt(this.size.x*this.size.x+this.size.y*this.size.y)/2)}updateCorners(){if(this.dirtyCorners){this.dirtyCorners=!1;for(var t=this.getLocalCorners(),e=0;e<4;e++)this.corners[e]=this.toWorldSpace(t[e])}}transformCtx(t){this.updateMatrix();var e=new Matrix2x3(this.matrix),s=this.camera.getScreenPos(V(e.mat[4],e.mat[5]));e.mat[4]=s.x,e.mat[5]=s.y,e.scale(V(1/this.camera.zoom,1/this.camera.zoom)),t.setTransform(e.mat[0],e.mat[1],e.mat[2],e.mat[3],e.mat[4],e.mat[5])}rotateAbout(t,e){this.setAngle(t),this.setPos(this.pos.sub(e));var s=Math.cos(t),i=Math.sin(t),r=this.pos.x*s-this.pos.y*i,o=this.pos.y*s+this.pos.x*i;this.setPos(V(r,o).add(e)),this.dirty=!0,this.dirtyCorners=!0}setParent(t){this.parent=t,this.dirty=!0,this.dirtyCorners=!0}setCamera(t){this.camera=t}setPos(t){this.pos.x=t.x,this.pos.y=t.y,this.dirty=!0,this.dirtyCorners=!0}setAngle(t){this.angle=t,this.dirty=!0,this.dirtyCorners=!0}setScale(t){this.scale.x=t.x,this.scale.y=t.y,this.dirty=!0}setSize(t){this.size.x=t.x,this.size.y=t.y,this.dirtySize=!0,this.dirtyCorners=!0}setWidth(t){this.size.x=t,this.dirtySize=!0,this.dirtyCorners=!0}setHeight(t){this.size.y=t,this.dirtySize=!0,this.dirtyCorners=!0}toLocalSpace(t){return this.getInverseMatrix().mul(t)}toWorldSpace(t){return this.getMatrix().mul(t)}getPos(){return V(this.pos.x,this.pos.y)}getAngle(){return this.angle}getScale(){return V(this.scale.x,this.scale.y)}getSize(){return this.size}getRadius(){return this.updateSize(),this.radius}getMatrix(){return this.updateMatrix(),this.matrix}getInverseMatrix(){return this.updateMatrix(),this.inverse}getBottomLeft(){return this.updateCorners(),this.corners[0]}getBottomRight(){return this.updateCorners(),this.corners[1]}getTopRight(){return this.updateCorners(),this.corners[2]}getTopLeft(){return this.updateCorners(),this.corners[3]}getCorners(){return this.updateCorners(),this.corners}getLocalCorners(){return this.updateSize(),this.localCorners}equals(t){if(!(t instanceof Transform))return!1;for(var e=this.getMatrix(),s=t.getMatrix(),i=0;i<e.mat.length;i++)if(e[i]!==s[i])return!1;return!0}print(){this.updateMatrix(),this.matrix.print()}copy(){var t=new Transform(this.pos.copy(),this.size.copy(),this.angle,this.camera);return t.scale=this.scale.copy(),t.dirty=!0,t}}class Vector{constructor(t,e){this.set(t,e)}set(t,e){t instanceof Vector?(this.x=t.x?t.x:0,this.y=t.y?t.y:0):(this.x=t||0,this.y=e||0)}translate(t,e){t instanceof Vector?this.set(this.add(t)):this.set(this.x+t,this.y+e)}add(t,e){return t instanceof Vector?new Vector(this.x+t.x,this.y+t.y):new Vector(this.x+t,this.y+e)}sub(t,e){return t instanceof Vector?new Vector(this.x-t.x,this.y-t.y):new Vector(this.x-t,this.y-e)}scale(t){return t instanceof Vector?new Vector(t.x*this.x,t.y*this.y):new Vector(t*this.x,t*this.y)}normalize(){var t=this.len();if(0===t)return new Vector(0,0);var e=1/t;return new Vector(this.x*e,this.y*e)}len(){return Math.sqrt(this.x*this.x+this.y*this.y)}len2(){return this.x*this.x+this.y*this.y}distanceTo(t){return this.sub(t).len()}dot(t){return this.x*t.x+this.y*t.y}project(t){return this.scale(t.dot(this)/this.len2())}copy(){return new Vector(this.x,this.y)}}class Module{constructor(t,e,s){this.parent=t,this.div=document.getElementById(e),this.divtext=s?document.getElementById(s):void 0,this.div.oninput=(()=>{render(),this.onChange()}),this.div.onclick=(()=>this.onClick()),this.div.onfocus=(()=>this.onFocus()),this.div.onblur=(()=>this.onBlur())}blur(){this.div.blur()}onShow(){}setValue(t){this.div.value=t}setPlaceholder(t){this.div.placeholder=t}setVisibility(t){this.div.style.display=t,void 0!=this.divtext&&(this.divtext.style.display=t)}setDisabled(t){this.div.disabled=t}getValue(){return this.div.value}onChange(){}onClick(){}onFocus(){this.parent.focused=!0}onBlur(){this.parent.focused=!1}}class Popup{constructor(t){this.div=document.getElementById(t),this.div.addEventListener("keydown",t=>{this.onKeyDown(t.keyCode)},!1),this.div.addEventListener("keyup",t=>{this.onKeyUp(t.keyCode)},!1),this.div.style.position="absolute",this.focused=!1,this.modules=[],this.setPos(V(0,0)),this.hide()}onKeyDown(t){}onKeyUp(t){}add(t){this.modules.push(t)}update(){this.onShow()}onShow(){for(var t=0;t<this.modules.length;t++)this.modules[t].onShow()}blur(){for(var t=0;t<this.modules.length;t++)this.modules[t].blur()}show(){this.hidden=!1,this.div.style.visibility="visible",this.div.focus(),this.onShow()}hide(){this.hidden=!0,this.div.style.visibility="hidden",this.div.blur()}setPos(t){this.pos=V(t.x,t.y),this.clamp(),this.div.style.left=this.pos.x+"px",this.div.style.top=this.pos.y+"px"}clamp(){this.pos.x=Math.max(Math.min(this.pos.x,window.innerWidth-this.div.clientWidth-1),ItemNavController.isOpen?ITEMNAV_WIDTH+5:5),this.pos.y=Math.max(Math.min(this.pos.y,window.innerHeight-this.div.clientHeight-1),(header?header.clientHeight:0)+5)}}var Exporter={};Exporter.ROOT=void 0,Exporter.write=function(t){var e=(new window.DOMParser).parseFromString('<?xml version="1.0" encoding="UTF-8"?><project></project>',"text/xml");Exporter.ROOT=e;var s=t.getObjects(),i=t.getWires(),r=getChildNode(e,"project"),o=createChildNode(r,"ics");return Exporter.writeICs(o),Exporter.writeGroup(r,s,i),e.xml?e.xml:(new XMLSerializer).serializeToString(e)},Exporter.writeGroup=function(t,e,s){for(var i=createChildNode(t,"objects"),r=createChildNode(t,"wires"),o=0;o<e.length;o++)e[o].writeTo(i);for(o=0;o<s.length;o++)s[o].writeTo(r)},Exporter.writeICs=function(t){for(var e=0;e<ICData.ICs.length;e++){var s=ICData.ICs[e],i=createChildNode(t,"ic");createTextElement(i,"icuid",s.icuid),createTextElement(i,"width",s.transform.size.x),createTextElement(i,"height",s.transform.size.y);for(var r=createChildNode(i,"iports"),o=0;o<s.iports.length;o++)s.iports[o].writeTo(r);for(var n=createChildNode(i,"oports"),o=0;o<s.oports.length;o++)s.oports[o].writeTo(n);var a=createChildNode(i,"components"),h=s.inputs.concat(s.components,s.outputs),c=getAllWires(h);Exporter.writeGroup(a,h,c)}};var Importer={};Importer.types=[],Importer.load=function(t,e){t=t.substring(0,t.indexOf(">")+1)+t.substring(t.indexOf(">")+1).replace(/\s/g,"");var s=(new window.DOMParser).parseFromString(t,"text/xml");if("parsererror"!=s.documentElement.nodeName){var i=getChildNode(s,"project"),r=getChildNode(i,"ics"),o=Importer.loadICs(r,e),n=Importer.loadGroup(i,e,o);e.addObjects(n.objects),e.addWires(n.wires);for(var a=0;a<o.length;a++)ICData.add(o[a]);return e.redistributeUIDs(),ICData.redistributeUIDs(),n}},Importer.loadGroup=function(t,e,s){for(var i=getChildNode(t,"objects"),r=getChildNode(t,"wires"),o=[],n=[],a=0;a<Importer.types.length;a++)for(var h=Importer.types[a],c=getChildrenByTagName(i,h.getXMLName()),u=0;u<c.length;u++)o.push(new h(e).load(c[u],s));for(var l=getChildrenByTagName(r,"wire"),a=0;a<l.length;a++)n.push(new Wire(e).load(l[a]));for(a=0;a<n.length;a++)n[a].loadConnections(l[a],o);return{objects:o,wires:n}},Importer.loadICs=function(t,e){for(var s=[],i=getChildrenByTagName(t,"ic"),r=0;r<i.length;r++){var o=i[r],n=getIntValue(getChildNode(o,"icuid")),a=getIntValue(getChildNode(o,"width")),h=getIntValue(getChildNode(o,"height")),c=getChildNode(o,"components"),u=Importer.loadGroup(c,e,s),l=ICData.create(u.objects);l.icuid=n,l.transform.setSize(V(a,h));for(var d=getChildrenByTagName(getChildNode(o,"iports"),"iport"),g=0;g<d.length;g++)l.iports[g]=(new IPort).load(d[g]);for(var p=getChildrenByTagName(getChildNode(o,"oports"),"oport"),g=0;g<p.length;g++)l.oports[g]=(new OPort).load(p[g]);s.push(l)}return s};class Input{constructor(t){this.parent=t,this.canvas=t.renderer.canvas,this.camera=t.camera,this.rawMousePos=new Vector(0,0),this.mousePos=new Vector(0,0),this.prevMousePos=new Vector(0,0),this.worldMousePos=new Vector(0,0),this.mouseDown=!1,this.mouseDownPos=void 0,this.z=0,this.shiftKeyDown=!1,this.modiferKeyDown=!1,this.optionKeyDown=!1,this.isDragging=!1,this.startTapTime=void 0,this.setup()}setup(){var t=this.parent.renderer.canvas;window.addEventListener("keydown",t=>{this===getCurrentContext().getInput()&&this.onKeyDown(t)},!1),window.addEventListener("keyup",t=>{this===getCurrentContext().getInput()&&this.onKeyUp(t)},!1),t.addEventListener("click",t=>this.onClick(t),!1),t.addEventListener("dblclick",t=>this.onDoubleClick(t),!1),t.addEventListener("wheel",t=>this.onWheel(t),!1),t.addEventListener("mousedown",t=>this.onMouseDown(t),!1),t.addEventListener("mouseup",t=>this.onMouseUp(t),!1),t.addEventListener("mousemove",t=>this.onMouseMove(t),!1),t.addEventListener("contextmenu",function(t){contextmenu.show(t),t.preventDefault()})}onKeyDown(t){var e=t.keyCode;e===SHIFT_KEY?this.shiftKeyDown=!0:e===CONTROL_KEY||e===COMMAND_KEY?this.modiferKeyDown=!0:e===OPTION_KEY?(this.optionKeyDown=!0,getCurrentContext().setCursor("pointer")):e===ENTER_KEY&&document.activeElement===projectNameInput&&projectNameInput.blur();for(var s=this.parent.getObjects(),i=0;i<s.length;i++)s[i]instanceof Keyboard&&s[i].onKeyDown(e);this.parent.history.onKeyDown(e,this),currentTool.onKeyDown(e,this)&&render()}onKeyUp(t){var e=t.keyCode;e===SHIFT_KEY?this.shiftKeyDown=!1:e===CONTROL_KEY||e===COMMAND_KEY?this.modiferKeyDown=!1:e===OPTION_KEY&&(this.optionKeyDown=!1,getCurrentContext().setCursor("default"));for(var s=this.parent.getObjects(),i=0;i<s.length;i++)s[i]instanceof Keyboard&&s[i].onKeyUp(e);currentTool.onKeyUp(e,this)}onDoubleClick(t){}onWheel(t){var e=.95;-t.deltaY/120<0&&(e=1/e);this.camera.getWorldPos(this.mousePos);this.camera.zoomBy(e);var s=this.camera.getScreenPos(this.worldMousePos),i=(this.mousePos.x-s.x)*this.camera.zoom,r=(this.mousePos.y-s.y)*this.camera.zoom;this.camera.translate(-i,-r),popup.onWheel(),render()}onMouseDown(t){var e=this.canvas.getBoundingClientRect();if(this.isDragging=!1,this.startTapTime=Date.now(),this.mouseDown=!0,this.mouseDownPos=new Vector(t.clientX-e.left,t.clientY-e.top),0===t.button){var s=!1;contextmenu.hide(),s=currentTool.onMouseDown(this),(s=icdesigner.onMouseDown(this)||s)&&render()}}onMouseMove(t){var e=this.canvas.getBoundingClientRect();this.prevMousePos.x=this.mousePos.x,this.prevMousePos.y=this.mousePos.y,this.rawMousePos=new Vector(t.clientX,t.clientY),this.mousePos=new Vector(t.clientX-e.left,t.clientY-e.top),this.worldMousePos=this.camera.getWorldPos(this.mousePos),this.isDragging=this.mouseDown&&Date.now()-this.startTapTime>50;var s=!1;if(this.optionKeyDown&&this.isDragging){var i=new Vector(this.mousePos.x,this.mousePos.y),r=this.mouseDownPos.sub(i);this.camera.translate(this.camera.zoom*r.x,this.camera.zoom*r.y),this.mouseDownPos=this.mousePos,popup.onMove(),s=!0}s=currentTool.onMouseMove(this)||s,(s=icdesigner.onMouseMove(this)||s)&&render()}onMouseUp(t){this.mouseDown=!1;var e=!1;e=currentTool.onMouseUp(this),(e=icdesigner.onMouseUp(this)||e)&&render()}onClick(t){this.isDragging||currentTool.onClick(this)&&render()}}var PlaceItemController=function(){document.getElementById("header"),document.getElementById("project-name");var t,e=!1;return{place:function(s,i){i&&(s.not=i);getCurrentContext().getInput().canvas.getBoundingClientRect();itemTool.activate(s,getCurrentContext()),e&&(getCurrentContext().getInput().onMouseMove(t),itemTool.onMouseMove(getCurrentContext().getInput()),itemTool.onClick()),e=!1},onDragEnd:function(s){e=!0,t=s,s.srcElement.parentElement.onclick()}}}();class Tool{constructor(){this.isActive=!1}activate(){currentTool.deactivate(),currentTool=this,this.isActive=!0,render()}deactivate(){this.isActive=!1}onKeyDown(t){}onKeyUp(t){}onMouseDown(){}onMouseMove(){}onMouseUp(){}onClick(){}draw(){}}var currentTool,ItemNavController=function(){var t=document.getElementById("open-items-tab"),e=document.getElementById("items");return{isOpen:!1,toggle:function(){this.isOpen?(this.isOpen=!1,e.style.width="0px",t.style.marginLeft=ItemNavController.getTabOffset()+"px",t.style.borderColor="rgba(153, 153, 153, 0.7)",t.style.backgroundColor="rgba(200, 200, 200, 0.7)",t.style.fontSize="2em",t.innerHTML="&#9776;"):(this.isOpen=!0,e.style.width=ITEMNAV_WIDTH+"px",t.style.marginLeft=ItemNavController.getTabOffset()+"px",t.style.borderColor="rgba(153, 153, 153, 0.0)",t.style.backgroundColor="rgba(200, 200, 200, 0.0)",t.style.fontSize="2.5em",t.innerHTML="&times;")},getTabOffset:function(){return this.isOpen?ITEMNAV_WIDTH-t.offsetWidth:0}}}(),SideNavController=function(){document.getElementById("open-sive-nav-button"),document.getElementById("open-items-tab");var t=document.getElementById("sidenav"),e=document.getElementById("content"),s=document.getElementById("overlay");s&&s.addEventListener("transitionend",function(t){SideNavController.isOpen||(s.style.visibility="hidden")},!1);return{isOpen:!1,toggle:function(){this.isOpen?(this.isOpen=!1,t.style.width="0px",e.style.marginLeft="0px",s.style.opacity="0",s.onclick=function(){}):(this.isOpen=!0,t.style.width=SIDENAV_WIDTH+"px",e.style.marginLeft=SIDENAV_WIDTH+"px",s.style.visibility="visible",s.style.opacity="1",s.onclick=function(){SideNavController.toggle()})},getWidth:function(){return this.isOpen?SIDENAV_WIDTH:0}}}();class ContextMenu extends Popup{constructor(){super("context-menu"),this.add(new CutModule(this,"context-menu-cut")),this.add(new CopyModule(this,"context-menu-copy")),this.add(new PasteModule(this,"context-menu-paste")),this.add(new SelectAllModule(this,"context-menu-select-all")),this.add(new UndoModule(this,"context-menu-undo")),this.add(new RedoModule(this,"context-menu-redo"))}onKeyDown(t){t!==ESC_KEY||this.hidden||this.hide()}onShow(){super.onShow();var t=getCurrentContext().getInput().rawMousePos;this.setPos(V(t.x,t.y))}}class CopyModule extends Module{constructor(t,e){super(t,e)}onShow(){this.setDisabled(0==selectionTool.selections.length)}onClick(){this.parent.hide(),document.execCommand("copy")}}class CutModule extends Module{constructor(t,e){super(t,e)}onShow(){this.setDisabled(0==selectionTool.selections.length)}onClick(){this.parent.hide(),document.execCommand("cut")}}class PasteModule extends Module{constructor(t,e){super(t,e)}onShow(){this.setDisabled(!1)}onClick(){this.parent.hide(),document.execCommand("copy")}}class RedoModule extends Module{constructor(t,e){super(t,e)}onShow(){this.setDisabled(0==getCurrentContext().designer.history.redoStack.length)}onClick(){this.parent.hide(),getCurrentContext().designer.history.redo()}}class SelectAllModule extends Module{constructor(t,e){super(t,e)}onShow(){this.setDisabled(!1)}onClick(){this.parent.hide(),selectionTool.selectAll(),render()}}class UndoModule extends Module{constructor(t,e){super(t,e)}onShow(){this.setDisabled(0==getCurrentContext().designer.history.undoStack.length)}onClick(){this.parent.hide(),getCurrentContext().designer.history.undo()}}class BusButtonModule extends Module{constructor(t,e){super(t,e)}onShow(){for(var t=0,e=0,s=selectionTool.selections,i=0;i<s.length;i++)if(s[i]instanceof IPort)t++;else{if(!(s[i]instanceof OPort))return void this.setVisibility("none");e++}this.setVisibility(t===e?"inherit":"none")}onClick(){selectionTool.createBus()}}class ColorPickerModule extends Module{constructor(t,e,s){super(t,e,s)}onShow(){for(var t=!0,e=!0,s=selectionTool.selections,i=0;i<s.length;i++)(t=t&&s[i]instanceof LED)&&(e=e&&s[i].color===s[0].color);this.setVisibility(t?"inherit":"none"),this.setValue(t&&e?s[0].color:"#ffffff")}onChange(){for(var t=selectionTool.selections,e=0;e<t.length;e++)t[e].color=this.getValue()}onFocus(){this.parent.focused=!0}onBlur(){this.parent.focused=!1,this.onChange()}}class ICButtonModule extends Module{constructor(t,e){super(t,e)}onShow(){for(var t=0,e=selectionTool.selections,s=0;s<e.length;s++)e[s]instanceof IOObject&&!(e[s]instanceof WirePort)&&t++;this.setVisibility(t>=2?"inherit":"none")}onClick(){icdesigner.show(selectionTool.selections)}}class InputCountModule extends Module{constructor(t,e,s){super(t,e,s)}onShow(){for(var t=!0,e=!0,s=0,i=999,r=selectionTool.selections,o=0;o<r.length;o++)e=e&&r[o].maxInputs>1&&!0!==r[o].noChange,t=t&&r[o].getInputAmount()===r[0].getInputAmount(),s=Math.max(r[o].getMinInputFieldCount(),s),i=Math.min(r[o].getMaxInputFieldCount(),i);this.setValue(t?r[0].getInputAmount():""),this.setPlaceholder(t?"":"-"),this.setVisibility(e?"inherit":"none"),this.div.min=s,this.div.max=i}onChange(){for(var t=selectionTool.selections,e=0;e<t.length;e++)t[e].setInputAmount(Number(this.getValue()))}}class PositionXModule extends Module{constructor(t,e){super(t,e)}onShow(){for(var t=!0,e=selectionTool.selections,s=0;s<e.length;s++)t=t&&e[s].getPos().x===e[0].getPos().x;this.setValue(t?+(e[0].getPos().x/GRID_SIZE-.5).toFixed(3):""),this.setPlaceholder(t?"":"-")}onChange(){for(var t=new GroupAction,e=selectionTool.selections,s=0;s<e.length;s++){var i=e[s].transform.copy();e[s].setPos(V(GRID_SIZE*(Number(this.getValue())+.5),e[s].transform.getPos().y));var r=e[s].transform.copy();t.add(new TransformAction(e[s],i,r))}getCurrentContext().addAction(t)}}class PositionYModule extends Module{constructor(t,e){super(t,e)}onShow(){for(var t=!0,e=selectionTool.selections,s=0;s<e.length;s++)t=t&&e[s].getPos().y===e[0].getPos().y;this.setValue(t?+(e[0].getPos().y/GRID_SIZE-.5).toFixed(3):""),this.setPlaceholder(t?"":"-")}onChange(){for(var t=new GroupAction,e=selectionTool.selections,s=0;s<e.length;s++){var i=e[s].transform.copy();e[s].setPos(V(e[s].transform.getPos().x,GRID_SIZE*(Number(this.getValue())+.5)));var r=e[s].transform.copy();t.add(new TransformAction(e[s],i,r))}getCurrentContext().addAction(t)}}class SelectionPopup extends Popup{constructor(){super("popup"),this.add(new TitleModule(this,"popup-name")),this.add(new PositionXModule(this,"popup-position-x")),this.add(new PositionYModule(this,"popup-position-y")),this.add(new InputCountModule(this,"popup-input-count","popup-input-count-text")),this.add(new ColorPickerModule(this,"popup-color-picker","popup-color-text")),this.add(new ICButtonModule(this,"popup-ic-button")),this.add(new BusButtonModule(this,"popup-bus-button"))}onKeyDown(t){if(t!==DELETE_KEY||this.focused){if(t!==ENTER_KEY||!this.focused)return t!==ESC_KEY||this.hidden?void 0:(selectionTool.deselectAll(),void render());this.onEnter()}else selectionTool.removeSelections()}onEnter(){this.blur()}update(){selectionTool.selections.length>0?(this.show(),this.onMove()):this.hide()}onMove(){var t=getCurrentContext().getCamera();if(selectionTool.selections.length>0){selectionTool.recalculateMidpoint();var e=t.getScreenPos(selectionTool.midpoint);e.y-=this.div.clientHeight/2,this.setPos(e)}}onWheel(){this.onMove()}}class TitleModule extends Module{constructor(t,e){super(t,e)}onShow(){for(var t=!0,e=selectionTool.selections,s=0;s<e.length;s++)t=t&&e[s].getName()===e[0].getName();this.setValue(t?e[0].getName():"<Multiple>")}onChange(){for(var t=selectionTool.selections,e=0;e<t.length;e++)t[e].setName(this.getValue())}onFocus(){this.parent.focused=!0}onBlur(){this.parent.focused=!1,this.onChange()}}class ItemTool extends Tool{constructor(){super(),this.item=void 0}activate(t,e){void 0!=this.item&&e.remove(this.item),super.activate(),this.item=t,e.addObject(this.item),this.onMouseMove(e.getInput())}deactivate(){super.deactivate(),this.item=void 0}onMouseMove(t){return this.item.setPos(t.worldMousePos),!0}onClick(){var t=new PlaceAction(this.item);getCurrentContext().addAction(t),selectionTool.activate()}}var itemTool=new ItemTool;class SelectionTool extends Tool{constructor(){super(),this.selections=[],this.midpoint=V(0,0),this.drag=!1,this.rotate=!1,this.selectionBox=new SelectionBox,this.wire=void 0,this.wireSplitPoint=-1,this.shouldSplit=!1}onKeyDown(t,e){if(console.log(t),t===A_KEY&&e.modiferKeyDown)return this.selectAll(),!0}onMouseDown(t){var e=t.parent.getObjects(),s=(t.parent.getWires(),t.worldMousePos);if(!icdesigner.hidden)return!1;if(!this.rotate&&this.selections.length>0){var i=s.sub(this.midpoint).len2();if(i<=ROTATION_CIRCLE_R2&&i>=ROTATION_CIRCLE_R1)return this.startRotation(s)}this.selectionBox.selBoxDownPos=void 0;for(var r=e.length-1;r>=0;r--){var o=e[r];if(!this.drag&&o.sContains(s))return this.startDrag(o,s);if(o.contains(s))return o.isPressable&&o.press(),!0;if(-1!==o.oPortContains(s)||-1!==o.iPortContains(s))return!0}return this.pressedWire(t)||this.selectionBox.onMouseDown(t)}onMouseMove(t){t.parent.getObjects(),t.parent.getWires();var e=t.worldMousePos;if(!icdesigner.hidden)return!1;if(this.shouldSplit){this.shouldSplit=!1,this.wire.split(this.wireSplitPoint);var s=new SplitWireAction(this.wire);getCurrentContext().addAction(s),this.deselectAll(),this.select([this.wire.connection]),this.startDrag(this.wire.connection,e),this.wire=void 0}if(this.selections.length>0){if(this.drag)return this.moveSelections(e,t.shiftKeyDown),!0;if(this.rotate)return this.rotateSelections(e,t.shiftKeyDown),!0}return this.selectionBox.onMouseMove(t)}onMouseUp(t){var e=t.parent.getObjects();t.parent.getWires(),t.worldMousePos;if(!icdesigner.hidden)return!1;if(this.selectionBox.onMouseUp(t)){for(s=0;s<this.selections.length;s++)this.sendToFront(this.selections[s]);return!0}if(popup.update(),this.drag)return this.addTransformAction(),this.drag=!1,this.dragObj=void 0,!0;if(this.rotate)return this.addTransformAction(),this.rotate=!1,!0;for(var s=0;s<e.length;s++){var i=e[s];if(i.isPressable&&i.isOn)return i.release(),!0}}onClick(t){var e=t.parent.getObjects(),s=(t.parent.getWires(),t.worldMousePos);if(!icdesigner.hidden)return!1;for(var i=e.length-1;i>=0;i--){var r=e[i];if(r.sContains(s))return t.shiftKeyDown||this.deselectAll(!0),this.select([r],!0),this.sendToFront(r),!0;if(r.contains(s))return r.click(),!0;var o;if(-1!==(o=r.oPortContains(s)))return wiringTool.activate(r.outputs[o],getCurrentContext()),!0;if(-1!==(o=r.iPortContains(s)))return wiringTool.activate(r.inputs[o],getCurrentContext()),!0}return void 0!=this.wire?(this.shouldSplit=!1,t.shiftKeyDown||this.deselectAll(!0),this.select([this.wire],!0),this.wire=void 0,!0):!t.shiftKeyDown&&this.selections.length>0?(this.deselectAll(!0),!0):void 0}addTransformAction(){for(var t=new GroupAction,e=0;e<this.selections.length;e++){var s=this.oTransform[e],i=this.selections[e].transform.copy();s.equals(i)||t.add(new TransformAction(this.selections[e],s,i))}getCurrentContext().addAction(t)}select(t,e){if(0!==t.length){for(var s=new GroupAction,i=0;i<t.length;i++){var r=t[i];r.selected||(r.selected=!0,this.selections.push(r),e&&s.add(new SelectAction(r)))}e&&getCurrentContext().addAction(s),popup.update(),this.recalculateMidpoint()}}deselectAll(t){for(var e=[],s=0;s<this.selections.length;s++)e.push(this.selections[s]);this.deselect(e,t)}deselect(t,e){if(0!==t.length){for(var s=new GroupAction,i=0;i<t.length;i++){var r=t[i];r.selected?(r.selected=!1,this.selections.splice(this.selections.indexOf(r),1),e&&s.add(new SelectAction(r,!0))):console.error("Can't deselect an unselected object! "+r)}e&&getCurrentContext().addAction(s),popup.update(),this.recalculateMidpoint()}}removeSelections(){if(0!==this.selections.length){for(var t=new GroupAction,e=getAllThingsBetween(this.selections),s=0;s<e.length;s++)if(e[s]instanceof Wire||e[s]instanceof WirePort){var i=e[s].input,r=e[s].connection;e[s].remove(),t.add(new DeleteAction(e[s],i,r))}for(s=0;s<e.length;s++)e[s]instanceof Wire||e[s]instanceof WirePort||(e[s].remove(),t.add(new DeleteAction(e[s])));this.deselectAll(),getCurrentContext().addAction(t),render()}}moveSelections(t,e){for(var s=V(t.x,t.y).sub(this.dragObj.getPos()).sub(this.dragPos),i=0;i<this.selections.length;i++){var r=this.selections[i],o=r.getPos().add(s);e&&(o=V(Math.floor(o.x/GRID_SIZE+.5)*GRID_SIZE,Math.floor(o.y/GRID_SIZE+.5)*GRID_SIZE)),r.setPos(o)}this.recalculateMidpoint()}rotateSelections(t,e){for(var s=this.midpoint,i=Math.atan2(t.y-s.y,t.x-s.x)-this.prevAngle,r=0;r<this.selections.length;r++){var o=this.realAngles[r]+i;this.realAngles[r]=o,e&&(o=Math.floor(o/(Math.PI/4))*Math.PI/4),this.selections[r].setRotationAbout(o,s)}this.prevAngle=i+this.prevAngle}startDrag(t,e){this.oTransform=[];for(var s=0;s<this.selections.length;s++)this.oTransform[s]=this.selections[s].transform.copy();return this.drag=!0,this.dragObj=t,this.dragPos=e.copy().sub(t.getPos()),popup.hide(),!0}startRotation(t){this.rotate=!0,this.startAngle=Math.atan2(t.y-this.midpoint.y,t.x-this.midpoint.x),this.prevAngle=this.startAngle,this.realAngles=[],this.oTransform=[];for(var e=0;e<this.selections.length;e++)this.realAngles[e]=this.selections[e].getAngle(),this.oTransform[e]=this.selections[e].transform.copy();return popup.hide(),!1}pressedWire(t){for(var e=t.parent.getWires(),s=t.worldMousePos,i=0;i<e.length;i++){var r,o=e[i];if(-1!==(r=o.getNearestT(s.x,s.y)))return this.wire=o,this.wireSplitPoint=r,this.shouldSplit=!0,!0}return!1}selectAll(){this.deselectAll(!0),this.select(getCurrentContext().getObjects(),!0)}createBus(){for(var t=[],e=[],s=0;s<this.selections.length;s++)this.selections[s]instanceof IPort?t.push(this.selections[s]):e.push(this.selections[s]);for(;e.length>0;){for(var i=-1/0,r=-1,o=-1,s=0;s<e.length;s++){for(var n=e[s].getPos(),a=1/0,h=-1,c=0;c<t.length;c++){var u=t[c],l=n.sub(u.getPos()).len2();l<a&&(a=l,h=c)}a>i&&(i=a,r=s,o=h)}var d=new Wire(context);getCurrentContext().add(d),e[r].connect(d),d.connect(t[o]),d.set=!0,d.straight=!0,e.splice(r,1),t.splice(o,1)}render()}sendToFront(t){(t instanceof IOObject||t instanceof Wire)&&(getCurrentContext().remove(t),getCurrentContext().add(t))}recalculateMidpoint(){this.midpoint=V(0,0);for(var t=0;t<this.selections.length;t++)this.midpoint.translate(this.selections[t].getPos());this.midpoint=this.midpoint.scale(1/this.selections.length)}draw(t){var e=t.getCamera();if(this.selections.length>0&&!this.drag){var s=e.getScreenPos(this.midpoint),i=ROTATION_CIRCLE_RADIUS/e.zoom,r=ROTATION_CIRCLE_THICKNESS/e.zoom;if(this.rotate){t.save(),t.context.fillStyle="#fff",t.context.strokeStyle="#000",t.context.lineWidth=5,t.context.globalAlpha=.4,t.context.beginPath(),t.context.moveTo(s.x,s.y);var o=(this.prevAngle-this.startAngle)%(2*Math.PI);o<0&&(o+=2*Math.PI),t.context.arc(s.x,s.y,i,this.startAngle,this.prevAngle,o>Math.PI),t.context.fill(),t.context.closePath(),t.restore()}t.circle(s.x,s.y,i,void 0,"#ff0000",r,.5)}this.selectionBox.draw(t)}}var selectionTool=new SelectionTool;class WiringTool extends Tool{constructor(){super(),this.clickOPort=!1,this.wire=void 0}onKeyUp(t,e){t===ESC_KEY&&(this.removeWire(e.parent.wires),selectionTool.activate(),render())}activate(t,e){super.activate(),this.wire=new Wire(e),this.clickOPort=t instanceof OPort,this.clickOPort?t.connect(this.wire):this.wire.connect(t),this.onMouseMove(e.getInput()),e.addWire(this.wire)}deactivate(){super.deactivate(),this.wire=void 0}removeWire(t){for(var e=0;e<t.length&&t[e]!==this.wire;e++);t.splice(e,1),this.clickOPort?this.wire.input.disconnect(this.wire):this.wire.disconnect()}onMouseMove(t){return this.clickOPort?this.wire.curve.update(this.wire.curve.p1,t.worldMousePos,this.wire.curve.c1,t.worldMousePos):this.wire.curve.update(context.getInput().worldMousePos,this.wire.curve.p2,context.getInput().worldMousePos,this.wire.curve.c2),!0}onClick(t){for(var e=t.parent.getObjects(),s=t.parent.getWires(),i=t.worldMousePos,r=0;r<e.length;r++){var o=-1;if(this.clickOPort&&-1!==(o=e[r].iPortContains(i))&&(this.wire.connect(e[r].inputs[o])||this.removeWire(s)),this.clickOPort||-1===(o=e[r].oPortContains(i))||e[r].outputs[o].connect(this.wire)||this.removeWire(s),-1!==o){var n=new PlaceWireAction(this.wire);return getCurrentContext().addAction(n),selectionTool.activate(),!0}}return this.removeWire(s),selectionTool.activate(),!0}}var wiringTool=new WiringTool;class IOObject{constructor(t,e,s,i,r,o,n,a,h,c,u){void 0==t&&(t=getCurrentContext()),this.context=t,e=void 0==e?0:e,s=void 0==s?0:s,this.transform=new Transform(V(e,s),V(i,r),0,t.getCamera()),this.cullTransform=new Transform(this.transform.getPos(),V(0,0),0,this.context.getCamera()),this.name=this.getDisplayName(),this.img=o,this.isOn=!1,this.isPressable=n,this.maxInputs=a,this.maxOutputs=h,this.selected=!1,this.isPressable&&(this.selectionBoxTransform=new Transform(V(e,s),V(c,u),0,t.getCamera())),this.outputs=[],this.inputs=[],h>0&&this.setOutputAmount(1)}setInputAmount(t){for(t=clamp(t,0,this.maxInputs);this.inputs.length>t;)this.inputs.splice(this.inputs.length-1,1);for(;this.inputs.length<t;)this.inputs.push(new IPort(this));for(var e=0;e<this.inputs.length;e++)this.inputs[e].updatePosition();this.onTransformChange()}setOutputAmount(t){for(t=clamp(t,0,this.maxOutputs);this.outputs.length>t;)this.outputs.splice(this.outputs.length-1,1);for(;this.outputs.length<t;)this.outputs.push(new OPort(this));for(var e=0;e<this.outputs.length;e++)this.outputs[e].updatePosition();this.onTransformChange()}onTransformChange(){this.isPressable&&void 0!=this.selectionBoxTransform&&(this.selectionBoxTransform.setPos(this.transform.getPos()),this.selectionBoxTransform.setAngle(this.transform.getAngle()),this.selectionBoxTransform.setScale(this.transform.getScale())),this.updateCullTransform();for(t=0;t<this.inputs.length;t++)this.inputs[t].onTransformChange();for(var t=0;t<this.outputs.length;t++)this.outputs[t].onTransformChange()}updateCullTransform(){var t=V(-this.transform.size.x/2,-this.transform.size.y/2),e=V(this.transform.size.x/2,this.transform.size.y/2);void 0!=this.selectionBoxTransform&&(t.x=Math.min(-this.selectionBoxTransform.size.x/2,t.x),t.y=Math.min(-this.selectionBoxTransform.size.y/2,t.y),e.x=Math.max(this.selectionBoxTransform.size.x/2,e.x),e.y=Math.max(this.selectionBoxTransform.size.y/2,e.y));for(i=0;i<this.inputs.length;i++){var s=this.inputs[i];t.x=Math.min(s.target.x,t.x),t.y=Math.min(s.target.y,t.y),e.x=Math.max(s.target.x,e.x),e.y=Math.max(s.target.y,e.y)}for(var i=0;i<this.outputs.length;i++){var r=this.outputs[i];t.x=Math.min(r.target.x,t.x),t.y=Math.min(r.target.y,t.y),e.x=Math.max(r.target.x,e.x),e.y=Math.max(r.target.y,e.y)}this.cullTransform.setSize(V(e.x-t.x,e.y-t.y));var o=Math.cos(this.transform.getAngle()),n=Math.sin(this.transform.getAngle()),a=(t.x- -this.cullTransform.size.x/2)*o+(t.y- -this.cullTransform.size.y/2)*n,h=(t.y- -this.cullTransform.size.y/2)*o+(t.x- -this.cullTransform.size.x/2)*n;this.cullTransform.setPos(this.transform.getPos().add(V(a,h))),this.cullTransform.setAngle(this.transform.getAngle()),this.cullTransform.setScale(this.transform.getScale()),this.cullTransform.setSize(this.cullTransform.size.add(V(2*IO_PORT_RADIUS,2*IO_PORT_RADIUS)))}click(){}press(){}release(){}activate(t,e){void 0==e&&(e=0),this.isOn=t,void 0!=this.outputs[e]&&this.outputs[e].activate(t)}localSpace(){var t=this.context.getRenderer();t.save(),this.transform.transformCtx(t.context)}draw(){this.localSpace();for(t=0;t<this.inputs.length;t++)this.inputs[t].draw();for(var t=0;t<this.outputs.length;t++)this.outputs[t].draw(t);var e=this.context.getRenderer();this.isPressable&&void 0!=this.selectionBoxTransform&&e.rect(0,0,this.selectionBoxTransform.size.x,this.selectionBoxTransform.size.y,this.getCol(),this.getBorderColor()),void 0!=this.img&&e.image(this.img,0,0,this.transform.size.x,this.transform.size.y,this.getImageTint()),e.restore()}remove(){this.context.remove(this);for(t=0;t<this.outputs.length;t++)this.outputs[t].remove();for(var t=0;t<this.inputs.length;t++)this.inputs[t].remove()}contains(t){return rectContains(this.transform,t)}sContains(t){return!this.isPressable&&this.contains(t)||this.isPressable&&!this.contains(t)&&rectContains(this.selectionBoxTransform,t)}iPortContains(t){for(var e=0;e<this.inputs.length;e++)if(this.inputs[e].contains(t))return e;return-1}oPortContains(t){for(var e=0;e<this.outputs.length;e++)if(this.outputs[e].contains(t))return e;return-1}setContext(t){this.context=t,this.transform.setCamera(this.context.getCamera()),void 0!=this.selectionBoxTransform&&this.selectionBoxTransform.setCamera(this.context.getCamera())}setTransform(t){this.transform=t,this.onTransformChange()}setPos(t){this.transform.setPos(t),this.onTransformChange()}setAngle(t){this.transform.setAngle(t),this.onTransformChange()}setRotationAbout(t,e){this.transform.rotateAbout(-this.getAngle(),e),this.transform.rotateAbout(t,e),this.onTransformChange()}setName(t){this.name=t}getCullBox(){return this.cullTransform}getInputAmount(){return this.inputs.length}getImageTint(){return this.getCol()}getCol(){return this.selected?"#1cff3e":void 0}getBorderColor(){return this.selected?"#0d7f1f":void 0}getPos(){return this.transform.pos.copy()}getAngle(){return this.transform.angle}getSize(){return this.transform.size}getMaxInputFieldCount(){return 8}getMinInputFieldCount(){return 2}getName(){return this.name}getDisplayName(){return"IOObject"}getRenderer(){return this.context.getRenderer()}copy(){var t=new this.constructor(this.context);t.transform=this.transform.copy(),t.name=this.name,void 0!=this.selectionBoxTransform&&(t.selectionBoxTransform=this.selectionBoxTransform.copy());for(e=0;e<this.inputs.length;e++)t.inputs[e]=this.inputs[e].copy(),t.inputs[e].parent=t;for(var e=0;e<this.outputs.length;e++)t.outputs[e]=this.outputs[e].copy(),t.outputs[e].parent=t;return t}writeTo(t){var e=createChildNode(t,this.constructor.getXMLName());return createTextElement(e,"uid",this.uid),createTextElement(e,"name",this.getName()),createTextElement(e,"x",this.getPos().x),createTextElement(e,"y",this.getPos().y),createTextElement(e,"angle",this.getAngle()),e}load(t){var e=getIntValue(getChildNode(t,"uid")),s=getStringValue(getChildNode(t,"name")),i=getFloatValue(getChildNode(t,"x")),r=getFloatValue(getChildNode(t,"y")),o=getFloatValue(getChildNode(t,"angle")),n=getBooleanValue(getChildNode(t,"isOn"),!1);return this.uid=e,this.setName(s),n&&this.click(n),this.setPos(V(i,r)),this.setAngle(o),this}}class IOPort{constructor(t,e){this.isOn=!1,this.parent=t,this.connections=[],this.lineColor=DEFAULT_BORDER_COLOR,this.origin=V(0,0),this.target=e.scale(IO_PORT_LENGTH),this.dir=e,this.set=!1,void 0!=t&&this.updatePosition()}getArray(){}getIndex(){for(var t=0;t<this.getArray().length&&this.getArray()[t]!==this;t++);return t}getCol(){return this.parent.selected||this.selected?"#1cff3e":void 0}getBorderColor(){return this.parent.selected||this.selected?"#0d7f1f":void 0}updatePosition(){var t=this.getIndex(),e=-this.parent.transform.size.y/2*(t-this.getArray().length/2+.5);0===t&&(e-=1),t===this.getArray().length-1&&(e+=1),this.origin.y=e,this.target.y=e,this.prevParentLength=this.getArray().length}onTransformChange(){this.set||this.updatePosition();for(var t=0;t<this.connections.length;t++)void 0!=this.connections[t]&&this.connections[t].onTransformChange()}activate(t){}contains(t){var e=new Transform(this.target,V(IO_PORT_RADIUS,IO_PORT_RADIUS).scale(2),0,this.parent.context.getCamera());return e.setParent(this.parent.transform),circleContains(e,t)}sContains(t){if(this.origin.y!==this.target.y)return!1;var e=Math.abs(this.target.x-this.origin.x),s=this.target.add(this.origin).scale(.5),i=new Transform(s,V(e,2*IO_PORT_LINE_WIDTH),0,this.parent.context.getCamera());return i.setParent(this.parent.transform),rectContains(i,t)}draw(){this.set||this.getArray().length===this.prevParentLength||this.updatePosition();var t=this.origin,e=this.target,s=this.parent.getRenderer(),i=this.parent.getBorderColor()?this.parent.getBorderColor():this.lineColor;s.line(t.x,t.y,e.x,e.y,i,IO_PORT_LINE_WIDTH);var r=this.getCol()?this.getCol():DEFAULT_FILL_COLOR,o=this.getBorderColor()?this.getBorderColor():DEFAULT_BORDER_COLOR;s.circle(e.x,e.y,IO_PORT_RADIUS,r,o,IO_PORT_BORDER_WIDTH)}remove(){}setOrigin(t){this.origin.x=t.x,this.origin.y=t.y,this.set=!0,void 0!=this.parent&&this.parent.onTransformChange()}setTarget(t){this.target.x=t.x,this.target.y=t.y,this.set=!0,void 0!=this.parent&&this.parent.onTransformChange()}getPos(){return this.parent.transform.getMatrix().mul(this.target)}getOPos(){return this.parent.transform.getMatrix().mul(this.origin)}getDir(){return this.parent.transform.getMatrix().mul(this.dir).sub(this.parent.getPos()).normalize()}get uid(){return this.parent.uid}setName(t){}setPos(){}getInputAmount(){return 1}getMaxInputFieldCount(){return 1}getMinInputFieldCount(){return 1}getName(){return this.getDisplayName()}getDisplayName(){return"ioport"}getXMLName(){return this.getDisplayName().toLowerCase().replace(/\s+/g,"")}copy(){var t=new this.constructor;return t.origin=this.origin.copy(),t.target=this.target.copy(),t.set=this.set,t.lineColor=this.lineColor,t}writeTo(t){var e=createChildNode(t,this.getXMLName());createTextElement(e,"originx",this.origin.x),createTextElement(e,"originy",this.origin.y),createTextElement(e,"targetx",this.target.x),createTextElement(e,"targety",this.target.y)}load(t){var e=getFloatValue(getChildNode(t,"originx")),s=getFloatValue(getChildNode(t,"originy")),i=getFloatValue(getChildNode(t,"targetx")),r=getFloatValue(getChildNode(t,"targety"));return this.setOrigin(V(e,s)),this.setTarget(V(i,r)),this}}class IPort extends IOPort{constructor(t){super(t,V(-1,0))}getArray(){return this.parent.inputs}set input(t){void 0==t?this.connections=[]:this.connections[0]=t}get input(){return this.connections.length>0?this.connections[0]:void 0}activate(t){this.isOn!==t&&(this.isOn=t,this.parent.context.propogate(this,this.parent,this.isOn))}remove(){void 0!=this.input&&this.input.disconnect(this)}getDisplayName(){return"iport"}}class OPort extends IOPort{constructor(t){super(t,V(1,0))}getArray(){return this.parent.outputs}activate(t){if(this.isOn!==t){this.isOn=t;for(var e=0;e<this.connections.length;e++)this.parent.context.propogate(this,this.connections[e],this.isOn)}}remove(){for(var t=0;t<this.connections.length;t++)this.disconnect(this.connections[t])}connect(t){return this.connections.push(t),t.input=this,t.onTransformChange(),t.activate(this.isOn),!0}disconnect(t){for(var e=0;e<this.connections.length&&this.connections[e]!==t;e++);this.connections[e].input=void 0,this.connections.splice(e,1)}getDisplayName(){return"oport"}}class Wire{constructor(t){this.context=t,this.input=void 0,this.connection=void 0,this.curve=new BezierCurve(V(0,0),V(0,0),V(0,0),V(0,0)),this.isOn=!1,this.set=!1,this.straight=!1,this.dirty=!0,this.boundingBox=new Transform(0,0,0,t.getCamera())}activate(t){this.isOn!==t&&(this.isOn=t,void 0!=this.connection&&this.connection.activate(t))}split(t){var e=this.curve.getPos(t),s=new Wire(this.context),i=this.connection;this.disconnect();var r=new WirePort(this.context);this.connect(r),s.connect(i),r.connect(s),this.connection.setPos(e),getCurrentContext().addObject(r),getCurrentContext().addWire(s)}updateBoundingBox(){if(this.dirty){this.dirty=!1;var t=this.getPos(0),e=this.getPos(1),s=V(Math.min(t.x,e.x),Math.min(t.y,e.y)),i=V(Math.max(t.x,e.x),Math.max(t.y,e.y));this.boundingBox.setSize(V(i.x-s.x+2,i.y-s.y+2)),this.boundingBox.setPos(V((i.x-s.x)/2+s.x,(i.y-s.y)/2+s.y))}}onTransformChange(){if(void 0!=this.input){t=this.input.getPos();if(this.set)this.curve.c1.x+=t.x-this.curve.p1.x,this.curve.c1.y+=t.y-this.curve.p1.y;else{s=(e=this.input instanceof WirePort?this.input.getODir():this.input.getDir()).scale(DEFAULT_SIZE).add(t);this.curve.c1.x=s.x,this.curve.c1.y=s.y}this.curve.p1.x=t.x,this.curve.p1.y=t.y,this.curve.dirty=!0,this.dirty=!0}if(void 0!=this.connection){var t=this.connection.getPos();if(this.set)this.curve.c2.x+=t.x-this.curve.p2.x,this.curve.c2.y+=t.y-this.curve.p2.y;else{var e=this.connection.getDir(),s=e.scale(DEFAULT_SIZE).add(t);this.curve.c2.x=s.x,this.curve.c2.y=s.y}this.curve.p2.x=t.x,this.curve.p2.y=t.y,this.curve.dirty=!0,this.dirty=!0}}connect(t){return void 0==this.connection&&void 0==t.input&&(this.connection=t,t.input=this,this.onTransformChange(),t.activate(this.isOn),!0)}disconnect(){if(void 0==this.connection)return!1;this.connection.input=void 0,this.connection.activate(!1),this.connection=void 0}draw(){var t=this.context.getRenderer(),e=this.context.getCamera(),s=this.isOn?"#3cacf2":this.selected?"#1cff3e":DEFAULT_FILL_COLOR;if(this.straight){var i=e.getScreenPos(this.curve.p1),r=e.getScreenPos(this.curve.p2);t.line(i.x,i.y,r.x,r.y,s,7/e.zoom)}else this.curve.draw(s,7/e.zoom,t)}remove(){this.context.remove(this),void 0!=this.input&&this.input.disconnect(this),void 0!=this.connection&&this.disconnect(this.connection)}contains(t){return-1!==this.curve.getNearestT(t.x,t.y)}setName(t){}setPos(){}getPos(t){return void 0==t&&(t=.5),this.curve.getPos(t)}getNearestT(t,e){return this.straight?getNearestT(this.curve.p1,this.curve.p2,t,e):this.curve.getNearestT(t,e)}getCullBox(){return this.straight?this.getBoundingBox():this.curve.getBoundingBox()}getBoundingBox(){if(this.straight)return this.updateBoundingBox(),this.boundingBox}getInputAmount(){return 1}getMaxInputFieldCount(){return 1}getMinInputFieldCount(){return 1}getName(){return this.getDisplayName()}getDisplayName(){return"Wire"}copy(){var t=new Wire(this.context);return t.curve=this.curve.copy(),t.straight=this.straight,t}writeTo(t,e,s){var i=createChildNode(t,"wire");createTextElement(i,"uid",this.uid);var r=createChildNode(i,"input");createTextElement(r,"uid",this.input.uid),createTextElement(r,"index",this.input.getIndex());var o=createChildNode(i,"connection");createTextElement(o,"uid",this.connection.uid),createTextElement(o,"index",this.connection.getIndex()),this.curve.writeTo(i),createTextElement(i,"straight",this.straight)}load(t){this.context.getObjects(),this.context.getWires();var e=getIntValue(getChildNode(t,"uid"));this.uid=e;var s=getChildNode(t,"bezier");this.curve.load(s);var i=getBooleanValue(getChildNode(t,"straight"));return this.straight=i,this}loadConnections(t,e){var s=getChildNode(t,"input"),i=getIntValue(getChildNode(s,"uid")),r=getIntValue(getChildNode(s,"index")),o=findByUID(e,i);o=o instanceof WirePort?o:o.outputs[r];var n=getChildNode(t,"connection"),a=getIntValue(getChildNode(n,"uid")),h=getIntValue(getChildNode(n,"index")),c=findByUID(e,a);console.log(a),console.log(h),console.log(c),c=c instanceof WirePort?c:c.inputs[h],o.connect(this),this.connect(c)}}class WirePort extends IOObject{constructor(t){super(t,0,0,2*IO_PORT_RADIUS,2*IO_PORT_RADIUS),this._input=void 0,this.connection=void 0,this.isOn=!1,this.selected=!1,this.hasSetTransform=!1}set input(t){this._input=t,this.hasSetTransform||(this.hasSetTransform=!0,this.transform=new Transform(t.curve.p2.copy(),V(15,15),0,this.context.getCamera()))}get input(){return this._input}activate(t){this.isOn!==t&&(this.isOn=t,void 0!=this.connection&&this.connection.activate(t))}remove(){this.context.remove(this),void 0!=this.input&&this.input.disconnect(this),void 0!=this.connection&&this.disconnect(this.connection)}onTransformChange(){void 0!=this.input&&this.input.onTransformChange(),void 0!=this.connection&&this.connection.onTransformChange()}connect(t){return void 0==this.connection&&(this.connection=t,t.input=this,t.onTransformChange(),t.activate(this.isOn),!0)}disconnect(){void 0!=this.connection&&(this.connection.input=void 0,this.connection=void 0)}draw(){var t=this.context.getRenderer(),e=this.context.getCamera(),s=e.getScreenPos(this.getPos());t.circle(s.x,s.y,7/e.zoom,this.selected?"#1cff3e":"#ffffff",this.selected?"#0d7f1f":"#000000",1/e.zoom)}contains(t){return circleContains(this.transform,t)}sContains(t){return this.contains(t)}setPos(t){void 0!=this.input&&void 0!=this.connection&&(this.input.straight=!1,this.connection.straight=!1,t.x=snap(this.input,t.x,this.input.curve.p1.x),t.y=snap(this.input,t.y,this.input.curve.p1.y),t.x=snap(this.connection,t.x,this.connection.curve.p2.x),t.y=snap(this.connection,t.y,this.connection.curve.p2.y)),super.setPos(t)}getIndex(){return 0}getDir(){return this.transform.getMatrix().mul(V(-1,0)).sub(this.transform.pos).normalize()}getODir(){return this.transform.getMatrix().mul(V(1,0)).sub(this.transform.pos).normalize()}getCullBox(){return this.transform}getInputAmount(){return 1}getName(){return this.getDisplayName()}getDisplayName(){return"Port"}}WirePort.getXMLName=function(){return"port"},Importer.types.push(WirePort);class Gate extends IOObject{constructor(t,e,s,i,r){super(t,s,i,DEFAULT_SIZE*(void 0!=r?r.ratio:1),DEFAULT_SIZE,r,!1,999,999),this._not=!!e,this.name=this.getDisplayName(),this.setInputAmount(2)}set not(t){this._not=t,t&&(this.outputs[0].isOn=!this.isOn)}get not(){return this._not}activate(t,e){super.activate(this.not?!t:t,e)}draw(){super.draw();var t=this.context.getRenderer();if(this.localSpace(),this.not){var e=this.transform.size.x/2+5;t.circle(e,0,5,void 0==this.getCol()?"#fff":this.getCol(),this.getBorderColor(),2)}t.restore()}getDisplayName(){return"Gate"}copy(){var t=super.copy();return t.not=this.not,t}writeTo(t){var e=super.writeTo(t);return createTextElement(e,"not",this.not),createTextElement(e,"inputcount",this.getInputAmount()),e}load(t){super.load(t);var e=getBooleanValue(getChildNode(t,"not")),s=getIntValue(getChildNode(t,"inputcount"),1);return this.not=e,this.setInputAmount(s),this}}class ANDGate extends Gate{constructor(t,e,s,i){super(t,e,s,i,images["and.svg"])}setInputAmount(t){super.setInputAmount(t);for(var e=0;e<this.inputs.length;e++){var s=this.inputs[e];s.origin=V(-(this.transform.size.x-2)/2,s.origin.y)}}activate(t){for(var e=!0,s=0;s<this.inputs.length;s++)e=e&&this.inputs[s].isOn;super.activate(e)}draw(){var t=this.context.getRenderer();this.localSpace();var e=-this.transform.size.y/2*(.5-this.inputs.length/2),s=-this.transform.size.y/2*(this.inputs.length/2-.5),i=(this.transform.size.x-2)/2,r=V(-i,e),o=V(-i,s);t.line(r.x,r.y,o.x,o.y,this.getBorderColor(),2),t.restore(),super.draw()}getDisplayName(){return this.not?"NAND Gate":"AND Gate"}}ANDGate.getXMLName=function(){return"andgate"},Importer.types.push(ANDGate);class BUFGate extends Gate{constructor(t,e,s,i){super(t,e,s,i,images["buffer.svg"]),this.maxInputs=1,this.setInputAmount(1),this.activate(!1)}activate(t){for(var e=!1,s=0;s<this.inputs.length;s++)e=this.inputs[s].isOn;super.activate(e)}getDisplayName(){return this.not?"NOT Gate":"Buffer Gate"}}BUFGate.getXMLName=function(){return"bufgate"},Importer.types.push(BUFGate);class ORGate extends Gate{constructor(t,e,s,i){super(t,e,s,i,images["or.svg"])}quadCurveXAt(t){var e=this.transform.size.x/2-2,s=1-t;return s*s*-e+2*t*s*-(this.transform.size.x/5-2)+t*t*-e}setInputAmount(t){super.setInputAmount(t);for(var e=0;e<this.inputs.length;e++){var s=this.inputs[e],i=(s.origin.y/this.transform.size.y+.5)%1;i<0&&(i+=1);var r=this.quadCurveXAt(i);s.origin=V(r,s.origin.y)}}activate(t){for(var e=!1,s=0;s<this.inputs.length;s++)e=e||this.inputs[s].isOn;super.activate(e)}draw(){var t=this.context.getRenderer();this.localSpace();for(var e=2*Math.floor(this.inputs.length/4)+1,s=0;s<e;s++){var i=(s-Math.floor(e/2))*this.transform.size.y,r=-this.transform.size.y/2,o=+this.transform.size.y/2,n=this.transform.size.x/2-2,a=this.transform.size.x/5-2,h=V(-n,r+i),c=V(-n,o+i),u=V(-a,i);t.quadCurve(h.x,h.y,c.x,c.y,u.x,u.y,this.getBorderColor(),2)}t.restore(),super.draw()}getDisplayName(){return this.not?"NOR Gate":"OR Gate"}}ORGate.getXMLName=function(){return"orgate"},Importer.types.push(ORGate);class XORGate extends Gate{constructor(t,e,s,i){super(t,e,s,i,images["or.svg"])}quadCurveXAt(t){var e=this.transform.size.x/2-2,s=1-t;return s*s*-e+2*t*s*-(this.transform.size.x/5-2)+t*t*-e}setInputAmount(t){super.setInputAmount(t);for(var e=0;e<this.inputs.length;e++){var s=this.inputs[e],i=(s.origin.y/this.transform.size.y+.5)%1;i<0&&(i+=1);var r=this.quadCurveXAt(i);s.origin=V(r,s.origin.y)}}activate(t){for(var e=!1,s=0;s<this.inputs.length;s++)e=e!==this.inputs[s].isOn;super.activate(e)}draw(){super.draw();var t=this.context.getRenderer();this.localSpace();for(var e=2*Math.floor(this.inputs.length/4)+1,s=0;s<e;s++){var i=(s-Math.floor(e/2))*this.transform.size.y,r=-this.transform.size.y/2,o=+this.transform.size.y/2,n=this.transform.size.x/2-2,a=this.transform.size.x/5-2,h=V(-n,r+i),c=V(-n,o+i),u=V(-a,i);t.quadCurve(h.x,h.y,c.x,c.y,u.x,u.y,this.getBorderColor(),2),t.quadCurve(h.x-12,h.y,c.x-12,c.y,u.x-12,u.y,this.getBorderColor(),2)}t.restore()}getDisplayName(){return this.not?"XNOR Gate":"XOR Gate"}getXMLName(){return"xorgate"}}XORGate.getXMLName=function(){return"xorgate"},Importer.types.push(XORGate);class SRFlipFlop extends Gate{constructor(t,e,s){super(t,!1,e,s,void 0),this.noChange=!0,this.setInputAmount(3),this.setOutputAmount(2),this.transform.setSize(this.transform.size.scale(1.5))}onTransformChange(){this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE)),super.onTransformChange(),this.transform.setSize(V(1.5*DEFAULT_SIZE,1.5*DEFAULT_SIZE))}activate(t){var e=this.outputs[0].isOn,s=this.inputs[0].isOn,i=this.inputs[1].isOn,r=this.inputs[2].isOn;i&&(s&&r||(s?e=!0:r&&(e=!1))),super.activate(e,0),super.activate(!e,1)}draw(){super.draw();var t=this.context.getRenderer();this.localSpace(),t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor()),t.restore()}getDisplayName(){return"SR Flip Flop"}}SRFlipFlop.getXMLName=function(){return"srff"},Importer.types.push(SRFlipFlop);class Button extends IOObject{constructor(t,e,s){super(t,e,s,DEFAULT_SIZE,DEFAULT_SIZE,images["buttonUp.svg"],!0,0,1,60,60)}press(){super.activate(!0),this.img=images["buttonDown.svg"]}release(){super.activate(!1),this.img=images["buttonUp.svg"]}contains(t){return circleContains(this.transform,t)}getDisplayName(){return"Button"}}Button.getXMLName=function(){return"button"},Importer.types.push(Button);class Clock extends IOObject{constructor(t,e,s){super(t,e,s,60,60/images["clock.svg"].ratio,images["clock.svg"],!1,0,1),this.frequency=1e3,setTimeout(()=>this.tick(),this.frequency)}tick(){this.activate(!this.isOn),setTimeout(()=>this.tick(),this.frequency)}activate(t){super.activate(t),this.img=t?images["clockOn.svg"]:images["clock.svg"],render()}getDisplayName(){return"Clock"}}Clock.getXMLName=function(){return"clock"},Importer.types.push(Clock);class ConstantHigh extends IOObject{constructor(t,e,s){super(t,e,s,DEFAULT_SIZE,DEFAULT_SIZE,images["constHigh.svg"],!1,0,1),super.activate(!0)}getDisplayName(){return"Constant High"}}ConstantHigh.getXMLName=function(){return"consthigh"},Importer.types.push(ConstantHigh);class ConstantLow extends IOObject{constructor(t,e,s){super(t,e,s,DEFAULT_SIZE,DEFAULT_SIZE,images["constLow.svg"],!1,0,1),super.activate(!1)}getDisplayName(){return"Constant Low"}}ConstantLow.getXMLName=function(){return"constlow"},Importer.types.push(ConstantLow);class Keyboard extends IOObject{constructor(t,e,s){super(t,e,s,3.5*DEFAULT_SIZE,3.5*DEFAULT_SIZE/images["keyboard.svg"].ratio,images["keyboard.svg"],!1,0,7),this.setOutputAmount(7);for(var i=0;i<7;i++){var r=this.outputs[i],o=-DEFAULT_SIZE/2*(i-3.5+.5);0===i&&(o-=1),6===i&&(o+=1),r.setOrigin(V(o,0)),r.setTarget(V(o,-IO_PORT_LENGTH-(this.transform.size.y-DEFAULT_SIZE)/2)),r.dir=V(0,-1)}}onKeyDown(t){if(void 0!=(t=Keyboard.codeMap[t])){this.activate(!0,this.outputs.length-1);for(var e=this.outputs.length-2;e>=0;e--){var s=1<<e;s>t?this.outputs[e].activate(!1):(this.outputs[e].activate(!0),t-=s)}}}onKeyUp(t){if(void 0!=(t=Keyboard.codeMap[t])){this.activate(!1,this.outputs.length-1);for(var e=this.outputs.length-2;e>=0;e--)this.outputs[e].activate(!1)}}getDisplayName(){return"Keyboard"}}Keyboard.getXMLName=function(){return"keyboard"},Importer.types.push(Keyboard),Keyboard.codeMap=[],Keyboard.codeCount=0,Keyboard.addKey=function(t){Keyboard.codeMap[t]=++Keyboard.codeCount};for(code=48;code<=57;code++)Keyboard.addKey(code);for(var code=65;code<=90;code++)Keyboard.addKey(code);Keyboard.addKey(32),Keyboard.addKey(13),Keyboard.addKey(8),Keyboard.addKey(9),Keyboard.addKey(16),Keyboard.addKey(17),Keyboard.addKey(18),Keyboard.addKey(91),Keyboard.addKey(20),Keyboard.addKey(27),Keyboard.addKey(192),Keyboard.addKey(189),Keyboard.addKey(187),Keyboard.addKey(219),Keyboard.addKey(221),Keyboard.addKey(220),Keyboard.addKey(186),Keyboard.addKey(222),Keyboard.addKey(188),Keyboard.addKey(190),Keyboard.addKey(191),Keyboard.addKey(37),Keyboard.addKey(38),Keyboard.addKey(39),Keyboard.addKey(40),Keyboard.addKey(112),Keyboard.addKey(112),console.log(Keyboard.codeCount);class Switch extends IOObject{constructor(t,e,s){super(t,e,s,60*images["switchUp.svg"].ratio,60,images["switchUp.svg"],!0,0,1,77*images["switchUp.svg"].ratio,77)}activate(t){super.activate(t),this.img=images[this.isOn?"switchDown.svg":"switchUp.svg"]}click(){super.click(),this.activate(!this.isOn)}getDisplayName(){return"Switch"}writeTo(t){var e=super.writeTo(t);return createTextElement(e,"isOn",this.outputs[0].isOn),e}}Switch.getXMLName=function(){return"switch"},Importer.types.push(Switch);class Decoder extends Gate{constructor(t,e,s){super(t,!1,e,s,void 0)}onTransformChange(){this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE)),super.onTransformChange(),this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE/2*(2<<this.inputs.length-1)))}setInputAmount(t){super.setInputAmount(t),super.setOutputAmount(2<<t-1)}getInputAmount(){return this.inputs.length}activate(t){for(var e=0,s=0;s<this.inputs.length;s++)e|=(this.inputs[s].isOn?1:0)<<s;for(s=0;s<this.outputs.length;s++)this.outputs[s].activate(s===e,s)}draw(){super.draw();var t=this.context.getRenderer();this.localSpace(),t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor()),t.restore()}getMinInputFieldCount(){return 1}getDisplayName(){return"Decoder"}}Decoder.getXMLName=function(){return"decoder"},Importer.types.push(Decoder);class Demultiplexer extends Gate{constructor(t,e,s){super(t,!1,e,s,void 0)}setInputAmount(t){super.setInputAmount(t+1),super.setOutputAmount(2<<t-1);var e=Math.max(DEFAULT_SIZE/2*(t-1),DEFAULT_SIZE),s=DEFAULT_SIZE/2*(2<<t-1);this.transform.setSize(V(e+10,s)),this.selectLines=[];for(i=0;i<t;i++){n=this.inputs[i];this.selectLines.push(n);o=-DEFAULT_SIZE/2*(i-t/2+.5);0===i&&(o-=1),i===t-1&&(o+=1),n.setOrigin(V(o,0)),n.setTarget(V(o,IO_PORT_LENGTH+s/2-DEFAULT_SIZE/2))}for(var i=0;i<this.outputs.length;i++){var r=this.outputs[i],o=-DEFAULT_SIZE/2*(i-this.outputs.length/2+.5);0===i&&(o-=1),i===this.outputs.length-1&&(o+=1),r.setOrigin(V(0,o)),r.setTarget(V(IO_PORT_LENGTH+(e/2-DEFAULT_SIZE/2),o))}var n;(n=this.inputs[this.inputs.length-1]).setOrigin(V(0,0)),n.setTarget(V(-IO_PORT_LENGTH-(e/2-DEFAULT_SIZE/2),0))}getInputAmount(){return this.selectLines.length}activate(t){for(var e=0,s=0;s<this.selectLines.length;s++)e|=(this.selectLines[s].isOn?1:0)<<s;super.activate(this.inputs[this.inputs.length-1].isOn,e)}draw(){super.draw();var t=this.context.getRenderer();this.localSpace();var e=V(this.transform.size.x/2,this.transform.size.y/2),s=V(this.transform.size.x/2,-this.transform.size.y/2),i=V(-this.transform.size.x/2,-this.transform.size.y/2+20),r=V(-this.transform.size.x/2,this.transform.size.y/2-20);t.shape([e,s,i,r],this.getCol(),this.getBorderColor(),2),t.restore()}getMinInputFieldCount(){return 1}getDisplayName(){return"Demultiplexer"}}Demultiplexer.getXMLName=function(){return"demux"},Importer.types.push(Demultiplexer);class Encoder extends Gate{constructor(t,e,s){super(t,!1,e,s,void 0)}onTransformChange(){this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE)),super.onTransformChange(),this.transform.setSize(V(DEFAULT_SIZE,DEFAULT_SIZE/2*(2<<this.outputs.length-1)))}setInputAmount(t){super.setInputAmount(2<<t-1),super.setOutputAmount(t)}getInputAmount(){return this.outputs.length}activate(t){for(var e=-1,s=0;s<this.inputs.length;s++)if(this.inputs[s].isOn){if(-1!==e)return;e=s}if(-1!==e)for(s=this.outputs.length-1;s>=0;s--){var i=1<<s;i>e?this.outputs[s].activate(!1):(this.outputs[s].activate(!0),e-=i)}}draw(){super.draw();var t=this.context.getRenderer();this.localSpace(),t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor()),t.restore()}getMinInputFieldCount(){return 1}getDisplayName(){return"Encoder"}}Encoder.getXMLName=function(){return"encoder"},Importer.types.push(Encoder);class IC extends IOObject{constructor(t,e,s,i){super(t,s,i,50,50,void 0,!1,999,999),this.data=e,this.setup()}setup(){if(void 0!=this.data){this.setInputAmount(this.data.getInputAmount()),this.setOutputAmount(this.data.getOutputAmount());var t=this.data.copy();this.inputObjects=t.inputs,this.outputObjects=t.outputs,this.components=t.components;for(var e=0;e<this.outputObjects.length;e++){var s=this.outputs[e];this.outputObjects[e].activate=function(t){s.activate(t)}}this.noChange=!0,this.update()}}update(){if(void 0!=this.data){this.transform.setWidth(this.data.getWidth()),this.transform.setHeight(this.data.getHeight());for(t=0;t<this.inputs.length;t++)this.inputs[t].setOrigin(this.data.iports[t].origin),this.inputs[t].setTarget(this.data.iports[t].target);for(var t=0;t<this.outputs.length;t++)this.outputs[t].setOrigin(this.data.oports[t].origin),this.outputs[t].setTarget(this.data.oports[t].target);this.activate()}}activate(){for(var t=0;t<this.inputs.length;t++)this.inputObjects[t].activate(this.inputs[t].isOn)}draw(){var t=this.context.getRenderer();super.draw(),this.localSpace();var e=this.transform.size;t.rect(0,0,e.x,e.y,this.getCol(),"#000000",1);for(a=0;a<this.inputs.length;a++){var s=this.inputObjects[a].getName(),i=this.transform.toLocalSpace(this.inputs[a].getPos()),r="center",o=8,n=t.getTextWidth(s)/2;(h=(h=getNearestPointOnRect(V(-e.x/2,-e.y/2),V(e.x/2,e.y/2),i)).sub(i).normalize().scale(o).add(h)).x=clamp(h.x,-e.x/2+o+n,e.x/2-o-n),h.y=clamp(h.y,-e.y/2+14,e.y/2-14),t.text(s,h.x,h.y,0,0,r)}for(var a=0;a<this.outputs.length;a++){var s=this.outputObjects[a].getName(),i=this.transform.toLocalSpace(this.outputs[a].getPos()),r="center",o=8,n=t.getTextWidth(s)/2,h=getNearestPointOnRect(V(-e.x/2,-e.y/2),V(e.x/2,e.y/2),i);(h=h.sub(i).normalize().scale(o).add(h)).x=clamp(h.x,-e.x/2+o+n,e.x/2-o-n),h.y=clamp(h.y,-e.y/2+14,e.y/2-14),t.text(s,h.x,h.y,0,0,r)}t.restore()}getDisplayName(){return"IC"}copy(){return new IC(this.context,this.data,this.transform.pos.x,this.transform.pos.y)}writeTo(t){var e=super.writeTo(t);return createTextElement(e,"icuid",this.data.getUID()),e}load(t,e){super.load(t);var s=findIC(getIntValue(getChildNode(t,"icuid")),e);return this.data=s,this.setup(),this}}IC.getXMLName=function(){return"ic"},Importer.types.push(IC);class ICData{constructor(t,e,s){this.transform=new Transform(V(0,0),V(0,0),0),this.inputs=t,this.outputs=e,this.components=s,this.wires=getAllWires(this.getObjects()),this.uidmanager=new UIDManager(this);for(var i=this.getObjects(),r=0;r<i.length;r++)this.uidmanager.giveUIDTo(i[r]);for(r=0;r<this.wires.length;r++)this.uidmanager.giveUIDTo(this.wires[r]);for(var o=0,r=0;r<this.inputs.length;r++)o=Math.max(this.inputs[r].getName().length,o);for(r=0;r<this.outputs.length;r++)o=Math.max(this.outputs[r].getName().length,o);var n=DEFAULT_SIZE+20*o,a=DEFAULT_SIZE/2*Math.max(this.inputs.length,this.outputs.length);this.transform.setSize(V(n,a)),this.iports=[],this.oports=[];for(r=0;r<this.inputs.length;r++){this.iports[r]=new IPort;h=-DEFAULT_SIZE/2*(r-this.inputs.length/2+.5);0===r&&(h-=1),r===this.inputs.length-1&&(h+=1),this.iports[r].setOrigin(V(0,h)),this.iports[r].setTarget(V(-IO_PORT_LENGTH-(n/2-DEFAULT_SIZE/2),h))}for(r=0;r<this.outputs.length;r++){this.oports[r]=new OPort;var h=-DEFAULT_SIZE/2*(r-this.outputs.length/2+.5);0===r&&(h-=1),r===this.outputs.length-1&&(h+=1),this.oports[r].setOrigin(V(0,h)),this.oports[r].setTarget(V(IO_PORT_LENGTH+(n/2-DEFAULT_SIZE/2),h))}this.recalculatePorts()}recalculatePorts(){for(var t=this.transform.size,e=this.iports,s=0;s<e.length;s++){var i=e[s],r=this.transform.getMatrix().mul(i.target),o=this.transform.getMatrix().mul(i.origin),n=r.add(r.sub(o).normalize().scale(1e4)),a=(l=getNearestPointOnRect(V(-t.x/2,-t.y/2),V(t.x/2,t.y/2),n)).sub(n).normalize().scale(t.scale(.5)).add(l),h=l.sub(n).normalize().scale(t.scale(.5).sub(V(IO_PORT_LENGTH+t.x/2-25,IO_PORT_LENGTH+t.y/2-25))).add(l);i.setOrigin(a),i.setTarget(h)}for(var c=this.oports,s=0;s<c.length;s++){var u=c[s],r=this.transform.getMatrix().mul(u.target),o=this.transform.getMatrix().mul(u.origin),n=r.add(r.sub(o).normalize().scale(1e4)),l=getNearestPointOnRect(V(-t.x/2,-t.y/2),V(t.x/2,t.y/2),n),a=l.sub(n).normalize().scale(t.scale(.5)).add(l),h=l.sub(n).normalize().scale(t.scale(.5).sub(V(IO_PORT_LENGTH+t.x/2-25,IO_PORT_LENGTH+t.y/2-25))).add(l);u.setOrigin(a),u.setTarget(h)}}getInputAmount(){return this.inputs.length}getOutputAmount(){return this.outputs.length}copy(){return separateGroup(copyGroup(this.getObjects()).objects)}getUID(){return this.icuid}getObjects(){return this.inputs.concat(this.components,this.outputs)}getWires(){return this.wires}getWidth(){return this.transform.getSize().x}getHeight(){return this.transform.getSize().y}}ICData.create=function(t){for(var e=separateGroup(t=copyGroup(t).objects),s=0;s<e.inputs.length;s++){var i=e.inputs[s];i instanceof Clock&&i.getName()===i.getDisplayName()&&i.setName(">")}return new ICData(e.inputs,e.outputs,e.components)},ICData.add=function(t){t.icuid=ICData.ICs.length,ICData.ICs.push(t)},ICData.redistributeUIDs=function(){for(var t=[],e=0;e<ICData.ICs.length;e++)t[e]=ICData.ICs[e];ICData.ICs=[];for(e=0;e<t.length;e++)t[e].icuid=e,ICData.ICs[e]=t[e]},ICData.ICs=[];class Label extends IOObject{constructor(t,e,s){super(t,e,s,0,0,void 0,!0,0,0,60,30),this.setName("LABEL"),this.setInputAmount(0),this.setOutputAmount(0)}activate(t){}draw(){super.draw();var t=this.context.getRenderer();this.localSpace();t.getTextWidth(this.text);var e=V(0,0);t.text(this.name,e.x,e.y,0,0,"center"),t.restore()}setName(t){super.setName(t);var e=this.context.getRenderer().getTextWidth(this.name)+20;this.selectionBoxTransform.setSize(V(e,this.selectionBoxTransform.size.y)),this.onTransformChange(),render()}getDisplayName(){return this.name}}Label.getXMLName=function(){return"label"},Importer.types.push(Label);class Multiplexer extends Gate{constructor(t,e,s){super(t,!1,e,s,void 0)}setInputAmount(t){super.setInputAmount(t+(2<<t-1));var e=Math.max(DEFAULT_SIZE/2*(t-1),DEFAULT_SIZE),s=DEFAULT_SIZE/2*(2<<t-1);this.transform.setSize(V(e+10,s)),this.selectLines=[];for(r=0;r<t;r++){o=this.inputs[r];this.selectLines.push(o);n=-DEFAULT_SIZE/2*(r-t/2+.5);0===r&&(n-=1),r===t-1&&(n+=1),o.setOrigin(V(n,0)),o.setTarget(V(n,IO_PORT_LENGTH+s/2-DEFAULT_SIZE/2))}for(var i=t;i<this.inputs.length;i++){var r,o=this.inputs[i],n=-DEFAULT_SIZE/2*((r=i-t)-(this.inputs.length-t)/2+.5);0===r&&(n-=1),r===this.inputs.length-t-1&&(n+=1),o.setOrigin(V(0,n)),o.setTarget(V(-IO_PORT_LENGTH-(e/2-DEFAULT_SIZE/2),n))}var a=this.outputs[0];a.target=V(IO_PORT_LENGTH+(e/2-DEFAULT_SIZE/2),a.target.y)}getInputAmount(){return this.selectLines.length}activate(t){for(var e=0,s=0;s<this.selectLines.length;s++)e|=(this.selectLines[s].isOn?1:0)<<s;super.activate(this.inputs[e+this.selectLines.length].isOn)}draw(){super.draw();var t=this.context.getRenderer();this.localSpace();var e=V(-this.transform.size.x/2,this.transform.size.y/2),s=V(-this.transform.size.x/2,-this.transform.size.y/2),i=V(this.transform.size.x/2,-this.transform.size.y/2+20),r=V(this.transform.size.x/2,this.transform.size.y/2-20);t.shape([e,s,i,r],this.getCol(),this.getBorderColor(),2),t.restore()}getMinInputFieldCount(){return 1}getDisplayName(){return"Multiplexer"}getXMLName(){return"mux"}}Multiplexer.getXMLName=function(){return"mux"},Importer.types.push(Multiplexer);class SevenSegmentDisplay extends IOObject{constructor(t,e,s){super(t,e,s,70,100,void 0,!1,7,0),this.setInputAmount(7),this.noChange=!0,this.segmentWidth=45,this.segmentHeight=10;for(var i=0;i<7;i++){var r=this.inputs[i],o=-15*(r.getIndex()-r.getArray().length/2+.5);r.setOrigin(V(r.origin.x,o)),r.setTarget(V(r.target.x,o))}this.transform.size.x,this.transform.size.y;var n=this.segmentWidth,a=this.segmentHeight;this.segmentPositions=[V(0,-n+a),V(n/2-a/2,(-n+a)/2),V(n/2-a/2,(+n-a)/2),V(0,n-a),V(-n/2+a/2,(+n-a)/2),V(-n/2+a/2,(-n+a)/2),V(0,0)],this.segmentSizes=[V(n,a),V(a,n),V(a,n),V(n,a),V(a,n),V(a,n),V(n,a)],this.segmentImages=[images["segment1.svg"],images["segment2.svg"],images["segment2.svg"],images["segment1.svg"],images["segment2.svg"],images["segment2.svg"],images["segment1.svg"]],this.segmentOnImages=[images["segment3.svg"],images["segment4.svg"],images["segment4.svg"],images["segment3.svg"],images["segment4.svg"],images["segment4.svg"],images["segment3.svg"]]}draw(){super.draw(),this.localSpace();var t=this.context.getRenderer();t.rect(0,0,this.transform.size.x,this.transform.size.y,this.getCol(),this.getBorderColor());for(var e=0;e<7;e++){var s=this.segmentPositions[e],i=this.segmentSizes[e],r=this.inputs[e].isOn?this.segmentOnImages[e]:this.segmentImages[e];t.image(r,s.x,s.y,i.x,i.y,void 0)}t.restore()}getDisplayName(){return"7 Segment Display"}getXMLName(){return"sevensegmentdisplay"}}SevenSegmentDisplay.getXMLName=function(){return"sevensegmentdisplay"},Importer.types.push(SevenSegmentDisplay);class LED extends IOObject{constructor(t,e,s,i){super(t,e,s,DEFAULT_SIZE,DEFAULT_SIZE,images["led.svg"],!1,1,0),this.transform.setPos(V(this.transform.pos.x,this.transform.pos.y-2*this.transform.size.y)),this.color=void 0==i?"#ffffff":i,this.connectorWidth=5,this.setInputAmount(1),this.inputs[0].setOrigin(V(0,0)),this.inputs[0].setTarget(V(0,2*this.transform.size.y)),this.inputs[0].lineColor="#ffffff",this.inputs[0].dir=V(0,1)}updateCullTransform(){super.updateCullTransform(),this.isOn&&(this.cullTransform.setSize(V(3*this.transform.size.x,4*this.transform.size.y)),this.cullTransform.setPos(this.transform.pos.add(V(0,(this.inputs[0].target.y-3*this.transform.size.y/2)/2))))}activate(t,e){super.activate(t,e),this.updateCullTransform()}getImageTint(){return this.color}draw(){super.draw();var t=this.context.getRenderer();this.localSpace(),this.isOn&&t.image(images["ledLight.svg"],0,0,3*this.transform.size.x,3*this.transform.size.y,this.color),t.restore()}getDisplayName(){return"LED"}copy(){var t=super.copy();return t.color=this.color,t.connectorWidth=this.connectorWidth,t}writeTo(t){var e=super.writeTo(t);return createTextElement(e,"color",this.color),e}load(t){super.load(t);var e=getStringValue(getChildNode(t,"color"));return this.color=e,this}}LED.getXMLName=function(){return"led"},Importer.types.push(LED);class CircuitDesigner{constructor(t,e,s){this.renderer=new Renderer(this,t,e,s),this.camera=new Camera(this),this.input=new Input(this),this.history=new HistoryManager,this.wires=[],this.objects=[],this.propogationQueue=[],window.addEventListener("resize",t=>this.resize(),!1),this.resize()}reset(){for(t=0;t<this.objects.length;t++)this.objects[t].remove();for(var t=0;t<this.wires.length;t++)this.wires[t].remove();this.objects=[],this.wires=[],this.propogationQueue=[]}propogate(t,e,s){this.propogationQueue.push(new Propogation(t,e,s,()=>this.update(t,e)))}update(t,e){for(var s=[];this.propogationQueue.length>0;)s.push(this.propogationQueue.pop());for(;s.length>0;)s.pop().send();this.propogationQueue.length>0&&updateRequests++,updateRequests--,console.log("update");var i=!1;if(t instanceof Wire||e instanceof Wire){for(var r=0;r<this.wires.length;r++)if(this.wires[r]===t||this.wires[r]===e){i=!0;break}}else render();i&&render(),updateRequests>0&&setTimeout(()=>this.update(t,e),PROPOGATION_TIME)}render(){this.renderer.clear();var t=GRID_SIZE/this.camera.zoom,e=V(this.camera.pos.x/this.camera.zoom-this.renderer.canvas.width/2,this.camera.pos.y/this.camera.zoom-this.renderer.canvas.height/2),s=e.x-Math.floor(e.x/t)*t;s<0&&(s+=t);var i=e.y-Math.floor(e.y/t)*t;i<0&&(i+=t),this.renderer.save(),this.renderer.setStyles(void 0,"#999",1/this.camera.zoom),this.renderer.context.beginPath();for(var r=-s;r<=this.renderer.canvas.width-s+t;r+=t)this.renderer._line(r,0,r,this.renderer.canvas.height);for(var o=-i;o<=this.renderer.canvas.height-i+t;o+=t)this.renderer._line(0,o,this.renderer.canvas.width,o);this.renderer.context.closePath(),this.renderer.context.stroke(),this.renderer.restore();for(n=0;n<this.wires.length;n++)this.camera.cull(this.wires[n].getCullBox())&&this.wires[n].draw();for(var n=0;n<this.objects.length;n++)this.camera.cull(this.objects[n].getCullBox())&&this.objects[n].draw();currentTool.draw(this.renderer)}resize(){this.renderer.resize(),this.camera.resize(),render()}addObject(t){-1===this.getIndexOfObject(t)?this.objects.push(t):console.log(new Error)}addWire(t){-1===this.getIndexOfWire(t)?this.wires.push(t):console.log(new Error)}getRenderer(){return this.renderer}getObjects(){return this.objects}getWires(){return this.wires}getIndexOfObject(t){for(var e=0;e<this.objects.length;e++)if(t===this.objects[e])return e;return-1}getIndexOfWire(t){for(var e=0;e<this.wires.length;e++)if(t===this.wires[e])return e;return-1}}class ICDesigner{constructor(){this.canvas=document.getElementById("designer-canvas"),this.designer=new CircuitDesigner(this.canvas,.84,.76),this.context=new Context(this.designer),this.ic=void 0,this.data=void 0,this.drag=!1,this.dragObj=void 0,this.dragEdge=void 0,this.confirmButton=document.getElementById("ic-confirmbutton"),this.cancelButton=document.getElementById("ic-cancelbutton"),this.hide()}confirm(){if(void 0!=this.ic){ICData.add(this.data);var t=this.ic.copy();t.setContext(context),context.getDesigner().addObject(t),this.hide()}}cancel(){void 0!=this.ic&&this.hide()}show(t){currentContext=this.context,this.hidden=!1,this.canvas.style.visibility="visible",this.confirmButton.style.visibility="visible",this.cancelButton.style.visibility="visible",popup.hide(),this.data=ICData.create(t),this.ic=new IC(this.context,this.data,0,0),this.designer.addObject(this.ic),selectionTool.deselect(t),this.context.getCamera().zoom=.5+.1*(this.ic.transform.size.x-50)/20,render()}hide(){currentContext=context,this.hidden=!0,this.canvas.style.visibility="hidden",this.confirmButton.style.visibility="hidden",this.cancelButton.style.visibility="hidden",void 0!=this.ic&&(this.ic.remove(),this.ic=void 0,this.data=void 0),render()}onMouseDown(t){if(void 0==this.ic)return!1;for(var e=t.worldMousePos,s=this.ic.inputs,i=0;i<s.length;i++){if(s[i].sContains(e))return this.drag=!0,this.dragObj=this.data.iports[i],!1}for(var r=this.ic.outputs,i=0;i<r.length;i++){if(r[i].sContains(e))return this.drag=!0,this.dragObj=this.data.oports[i],!1}var o=this.ic.getPos(),n=this.ic.getSize(),a=new Transform(o,n.scale(1.1),0,this.context.getCamera()),h=new Transform(o,n.scale(.9),0,this.context.getCamera());rectContains(a,e)&&!rectContains(h,e)&&(e.y<o.y+n.y/2-4&&e.y>o.y-n.y/2+4?this.dragEdge="horizontal":this.dragEdge="vertical")}onMouseUp(t){if(void 0==this.ic)return!1;this.drag=!1,this.dragObj=void 0,this.dragEdge=void 0}onMouseMove(t){if(void 0==this.ic)return!1;var e=t.worldMousePos;if(this.drag){var s=this.ic.getSize(),i=getNearestPointOnRect(V(-s.x/2,-s.y/2),V(s.x/2,s.y/2),e),r=i.sub(e).normalize().scale(s.scale(.5)).add(i),o=i.sub(e).normalize().scale(s.scale(.5).sub(V(IO_PORT_LENGTH+s.x/2-25,IO_PORT_LENGTH+s.y/2-25))).add(i);return this.dragObj.setOrigin(r),this.dragObj.setTarget(o),this.ic.update(),!0}return void 0!=this.dragEdge?("horizontal"===this.dragEdge?this.data.transform.setWidth(Math.abs(2*e.x)):this.data.transform.setHeight(Math.abs(2*e.y)),this.data.recalculatePorts(),this.ic.update(),!0):void 0}}var popup,contextmenu,icdesigner,context,currentContext,images=[],browser=getBrowser(),saved=!0,renderQueue=0;class Renderer{constructor(t,e,s,i){this.parent=t,this.canvas=e,this.tintCanvas=document.createElement("canvas"),this.vw=void 0==s?1:s,this.vh=void 0==i?1:i,this.context=this.canvas.getContext("2d"),this.tintCanvas.width=100,this.tintCanvas.height=100,this.tintContext=this.tintCanvas.getContext("2d")}getCamera(){return this.parent.camera}setCursor(t){this.canvas.style.cursor=t}resize(){this.canvas.width=window.innerWidth*this.vw,this.canvas.height=window.innerHeight*this.vh}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}save(){this.context.save()}restore(){this.context.restore()}translate(t){this.context.translate(t.x,t.y)}scale(t){this.context.scale(t.x,t.y)}rotate(t){this.context.rotate(t)}rect(t,e,s,i,r,o,n,a){this.save(),this.setStyles(r,o,n,a),this.context.beginPath(),this.context.rect(t-s/2,e-i/2,s,i),this.context.fill(),(n>0||void 0==n)&&this.context.stroke(),this.context.closePath(),this.restore()}circle(t,e,s,i,r,o,n){this.save(),this.setStyles(i,r,o,n),this.context.beginPath(),this.context.arc(t,e,s,0,2*Math.PI),void 0!=i&&this.context.fill(),(o>0||void 0==o)&&this.context.stroke(),this.context.closePath(),this.restore()}image(t,e,s,i,r,o){this.context.drawImage(t,e-i/2,s-r/2,i,r),void 0!=o&&this.tintImage(t,e,s,i,r,o)}tintImage(t,e,s,i,r,o){this.tintContext.clearRect(0,0,this.tintCanvas.width,this.tintCanvas.height),this.tintContext.fillStyle=o,this.tintContext.fillRect(0,0,this.tintCanvas.width,this.tintCanvas.height),"Firefox"!==browser.name?this.tintContext.globalCompositeOperation="destination-atop":this.tintContext.globalCompositeOperation="source-atop",this.tintContext.drawImage(t,0,0,this.tintCanvas.width,this.tintCanvas.height),this.context.globalAlpha=.5,this.context.drawImage(this.tintCanvas,e-i/2,s-r/2,i,r),this.context.globalAlpha=1}text(t,e,s,i,r,o){this.save(),this.context.font="lighter 15px arial",this.context.fillStyle="#000",this.context.textAlign=o,this.context.textBaseline="middle",this.context.fillText(t,e,s),this.restore()}getTextWidth(t){var e=0;return this.save(),this.context.font="lighter 15px arial",this.context.fillStyle="#000",this.context.textBaseline="middle",e=this.context.measureText(t).width,this.restore(),e}line(t,e,s,i,r,o){this.save(),this.setStyles(void 0,r,o),this.context.beginPath(),this.context.moveTo(t,e),this.context.lineTo(s,i),this.context.stroke(),this.context.closePath(),this.restore()}_line(t,e,s,i){this.context.moveTo(t,e),this.context.lineTo(s,i)}curve(t,e,s,i,r,o,n,a,h,c){this.save(),this.setStyles(void 0,h,c),this.context.beginPath(),this.context.moveTo(t,e),this.context.bezierCurveTo(r,o,n,a,s,i),this.context.stroke(),this.context.closePath(),this.restore()}quadCurve(t,e,s,i,r,o,n,a){this.save(),this.setStyles(void 0,n,a),this.context.beginPath(),this.context.moveTo(t,e),this.context.quadraticCurveTo(r,o,s,i),this.context.stroke(),this.context.closePath(),this.restore()}shape(t,e,s,i){this.save(),this.setStyles(e,s,i),this.context.beginPath(),this.context.moveTo(t[0].x,t[0].y);for(var r=1;r<t.length;r++)this.context.lineTo(t[r].x,t[r].y);this.context.lineTo(t[0].x,t[0].y),this.context.fill(),this.context.closePath(),i>0&&this.context.stroke(),this.restore()}setStyles(t,e,s,i){void 0!=i&&i!==this.context.globalAlpha&&(this.context.globalAlpha=i),void 0!=(t=void 0==t?"#ffffff":t)&&t!==this.context.fillStyle&&(this.context.fillStyle=t),void 0!=(e=void 0==e?"#000000":e)&&e!==this.context.strokeStyle&&(this.context.strokeStyle=e),void 0!=(s=void 0==s?2:s)&&s!==this.context.lineWidth&&(this.context.lineWidth=s)}}